{% extends "base.html" %}

{% block title %}{{ case.name }} - CaseScope 2026{% endblock %}

{% block content %}
<div class="content-header">
    <div>
        <h1 class="content-title">{{ case.name }}</h1>
        <p class="text-secondary">Case ID: {{ case.id }} ‚Ä¢ Created: {{ case.created_at.strftime('%Y-%m-%d %H:%M') }}</p>
    </div>
    <div class="content-actions">
        <button onclick="generateAIReport()" class="btn" style="background: var(--color-primary); color: white;" id="aiReportBtn">
            <span>ü§ñ</span>
            <span>Generate AI Report</span>
        </button>
        <a href="{{ url_for('upload_files', case_id=case.id) }}" class="btn btn-primary">
            <span>üì§</span>
            <span>Upload Files</span>
        </a>
        <button onclick="confirmClearFiles()" class="btn" style="background: var(--color-error); color: white;">
            <span>üóëÔ∏è</span>
            <span>Clear All Files</span>
        </button>
        <button onclick="confirmRehuntIOCs()" class="btn" style="background: var(--color-warning); color: white;">
            <span>üéØ</span>
            <span>Re-Hunt IOCs</span>
        </button>
        <a href="{{ url_for('dashboard') }}" class="btn btn-secondary">
            <span>‚Üê</span>
            <span>Back to Dashboard</span>
        </a>
    </div>
</div>

<!-- ============================================================================
     CASE DASHBOARD TILES
     ROW 1: Tile 1 (Case Details) - Full Width
     ROW 2: Tiles 2 & 3 (Case Files, Event Stats) - 50/50 Split
     ============================================================================ -->

<!-- TILE ROW 1: CASE DETAILS (Full Width) -->
<div style="margin-bottom: var(--spacing-lg);">

<!-- CASE DETAILS TILE -->
<div class="card" style="margin-bottom: 0; cursor: pointer;" onclick="window.location.href='{{ url_for('cases.edit_case', case_id=case.id) }}'">
    <div class="card-header">
        <h2 class="card-title">üìã Case Details</h2>
    </div>
    <div class="card-body">
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: var(--spacing-sm) var(--spacing-xl);">
            <div style="margin-bottom: var(--spacing-xs);">
                <div class="text-secondary" style="font-size: 0.875rem; margin-bottom: 2px;">Case Name</div>
                <div><strong>{{ case.name }}</strong></div>
            </div>
            <div style="margin-bottom: var(--spacing-xs);">
                <div class="text-secondary" style="font-size: 0.875rem; margin-bottom: 2px;">Case ID</div>
                <div><strong>{{ case.id }}</strong></div>
            </div>
            <div style="margin-bottom: var(--spacing-xs);">
                <div class="text-secondary" style="font-size: 0.875rem; margin-bottom: 2px;">Case Created Date</div>
                <div><strong>{{ case.created_at.strftime('%Y-%m-%d %H:%M:%S') }}</strong></div>
            </div>
            <div style="margin-bottom: var(--spacing-xs);">
                <div class="text-secondary" style="font-size: 0.875rem; margin-bottom: 2px;">Case Created By</div>
                <div><strong>{{ case.created_by or 'System' }}</strong></div>
            </div>
            <div style="margin-bottom: var(--spacing-xs);">
                <div class="text-secondary" style="font-size: 0.875rem; margin-bottom: 2px;">Case Assigned To User</div>
                <div><strong>{{ case.assigned_to or 'Unassigned' }}</strong></div>
            </div>
            <div style="margin-bottom: var(--spacing-xs);">
                <div class="text-secondary" style="font-size: 0.875rem; margin-bottom: 2px;">DFIR-IRIS Sync Status</div>
                <div><strong>Not Enabled</strong></div>
            </div>
            <div style="grid-column: 1 / -1; margin-bottom: var(--spacing-xs);">
                <div class="text-secondary" style="font-size: 0.875rem; margin-bottom: 2px;">Case Description</div>
                <div><strong>{{ case.description or 'No description provided' }}</strong></div>
            </div>
        </div>
    </div>
</div>

</div>
<!-- End of Tile Row 1 -->

<!-- TILE ROW 2: CASE FILES & EVENT STATS (50/50 Split) -->
<div style="display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: var(--spacing-lg); margin-bottom: var(--spacing-lg);">

<!-- CASE FILES TILE -->
<div class="card" style="margin-bottom: 0; cursor: pointer;" onclick="window.location.href='{{ url_for('file_management') }}';">
    <div class="card-header">
        <h2 class="card-title">üìÅ Case Files</h2>
    </div>
    <div class="card-body">
        <div style="display: flex; flex-direction: column; gap: var(--spacing-md);">
            <div style="margin-bottom: var(--spacing-xs);">
                <div class="text-secondary" style="font-size: 0.875rem; margin-bottom: 2px;">Total Files</div>
                <div>
                    <span id="stat-total-files" style="font-size: 1.75rem; font-weight: 700; color: var(--color-primary);">
                        {{ files|length }}
                    </span>
                </div>
            </div>
            <div style="margin-bottom: var(--spacing-xs);">
                <div class="text-secondary" style="font-size: 0.875rem; margin-bottom: 2px;">Indexed Files</div>
                <div>
                    <span id="stat-indexed-files" style="font-size: 1.75rem; font-weight: 700; color: var(--color-success);">
                        {{ files|selectattr('indexing_status', 'equalto', 'Completed')|list|length }}
                    </span>
                </div>
            </div>
            <div style="margin-bottom: var(--spacing-xs);">
                <div class="text-secondary" style="font-size: 0.875rem; margin-bottom: 2px;">Files Being Processed</div>
                <div>
                    <span id="stat-processing-files" style="font-size: 1.75rem; font-weight: 700; color: var(--color-warning);">
                        {{ files|selectattr('indexing_status', 'in', ['Queued', 'Indexing', 'SIGMA Testing', 'IOC Hunting'])|list|length }}
                    </span>
                </div>
            </div>
            <div style="margin-bottom: var(--spacing-xs);">
                <div class="text-secondary" style="font-size: 0.875rem; margin-bottom: 2px;">Disk Space Used by Case Files</div>
                <div>
                    <strong id="stat-disk-space">{{ (files|sum(attribute='file_size') / 1024 / 1024)|round(2) }} MB</strong>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- EVENT STATS TILE -->
<div class="card" style="margin-bottom: 0; cursor: pointer;" onclick="window.location.href='{{ url_for('event_search', case_id=case.id) }}';">
    <div class="card-header">
        <h2 class="card-title">üìä Event Stats</h2>
    </div>
    <div class="card-body">
        <div style="display: flex; flex-direction: column; gap: var(--spacing-md);">
            <div style="margin-bottom: var(--spacing-xs);">
                <div class="text-secondary" style="font-size: 0.875rem; margin-bottom: 2px;">Total Events</div>
                <div>
                    <span id="stat-total-events" style="font-size: 1.75rem; font-weight: 700; color: var(--color-primary);">
                        {% set total_events = files|sum(attribute='event_count') or 0 %}
                        {{ '{:,}'.format(total_events) }}
                    </span>
                </div>
            </div>
            <div style="margin-bottom: var(--spacing-xs);">
                <div class="text-secondary" style="font-size: 0.875rem; margin-bottom: 2px;">Total SIGMA Violations</div>
                <div>
                    <span id="stat-total-sigma" style="font-size: 1.75rem; font-weight: 700; color: var(--color-warning);">
                        {% set total_violations = files|sum(attribute='violation_count') or 0 %}
                        {{ '{:,}'.format(total_violations) }}
                    </span>
                </div>
            </div>
            <div style="margin-bottom: var(--spacing-xs);">
                <div class="text-secondary" style="font-size: 0.875rem; margin-bottom: 2px;">Total Events w/IOCs</div>
                <div>
                    <span id="stat-total-ioc-events" style="font-size: 1.75rem; font-weight: 700; color: var(--color-error);">
                        {% set total_ioc_events = files|sum(attribute='ioc_event_count') or 0 %}
                        {{ '{:,}'.format(total_ioc_events) }}
                    </span>
                </div>
            </div>
            <div style="margin-bottom: var(--spacing-xs);">
                <div class="text-secondary" style="font-size: 0.875rem; margin-bottom: 2px;">Number of IOCs Tracked in This Case</div>
                <div>
                    <span id="stat-total-iocs" style="font-size: 1.75rem; font-weight: 700; color: var(--color-warning);">{{ total_iocs }}</span>
                </div>
            </div>
            <div style="margin-bottom: var(--spacing-xs);">
                <div class="text-secondary" style="font-size: 0.875rem; margin-bottom: 2px;">Total Systems Identified</div>
                <div>
                    <span id="stat-total-systems" style="font-size: 1.75rem; font-weight: 700; color: var(--color-info);">{{ total_systems }}</span>
                </div>
            </div>
        </div>
    </div>
</div>

</div>
<!-- End of Tile Row 2 -->
<!-- End of Case Dashboard Tiles -->

<!-- ============================================================================
     AI REPORTS SECTION
     ============================================================================ -->
<div class="card" style="margin-bottom: var(--spacing-lg);">
    <div class="card-header">
        <h2 class="card-title">ü§ñ AI Generated Reports</h2>
        <span class="text-secondary" id="aiReportsCount">Loading...</span>
    </div>
    <div class="card-body">
        <div id="aiReportsList">
            <p style="color: var(--color-text-muted); text-align: center; padding: var(--spacing-lg);">
                Loading reports...
            </p>
        </div>
    </div>
</div>

<!-- ============================================================================
     FILES TABLE
     ============================================================================ -->
<div class="card">
    <div class="card-header">
        <h2 class="card-title">üìÑ Recent Case Files</h2>
        <span class="text-secondary">Showing 10 most recent</span>
    </div>
    <div class="card-body">
        {% if files %}
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Filename</th>
                        <th>Type</th>
                        <th>Size</th>
                        <th>Status</th>
                        <th>Events</th>
                        <th>SIGMA</th>
                        <th>IOCs</th>
                        <th>Uploaded</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for file in files %}
                    <tr data-file-id="{{ file.id }}">
                        <td>
                            <strong>{{ file.original_filename }}</strong>
                            {% if file.file_hash %}
                            <br><span class="text-muted" style="font-size: 0.75rem;">{{ file.file_hash[:16] }}...</span>
                            {% endif %}
                        </td>
                        <td>
                            <span class="status-badge" style="background: rgba(59, 130, 246, 0.1); color: var(--color-info);">
                                {{ file.file_type or 'UNKNOWN' }}
                            </span>
                        </td>
                        <td>{{ (file.file_size / 1024 / 1024)|round(2) }} MB</td>
                        <td class="status-cell">
                            {% if file.indexing_status == 'Completed' %}
                                <span class="status-badge status-completed">Completed</span>
                            {% elif file.indexing_status == 'Indexing' %}
                                <span class="status-badge status-indexing pulsing">Indexing</span>
                            {% elif file.indexing_status == 'SIGMA Testing' %}
                                <span class="status-badge status-sigma pulsing">SIGMA Testing</span>
                            {% elif file.indexing_status == 'IOC Hunting' %}
                                <span class="status-badge status-ioc pulsing">IOC Hunting</span>
                            {% elif file.indexing_status == 'Queued' %}
                                <span class="status-badge status-queued">Queued</span>
                            {% else %}
                                <span class="status-badge status-failed">{{ file.indexing_status }}</span>
                            {% endif %}
                        </td>
                        <td class="event-count">{{ '{:,}'.format(file.event_count or 0) }}</td>
                        <td class="sigma-count">
                            {% if file.violation_count > 0 %}
                                <span class="status-badge status-sigma">{{ file.violation_count }}</span>
                            {% else %}
                                <span class="text-muted">0</span>
                            {% endif %}
                        </td>
                        <td class="ioc-count">
                            {% if file.ioc_event_count > 0 %}
                                <span class="status-badge status-ioc">{{ file.ioc_event_count }}</span>
                            {% else %}
                                <span class="text-muted">0</span>
                            {% endif %}
                        </td>
                        <td>{{ file.uploaded_at.strftime('%Y-%m-%d %H:%M') }}</td>
                        <td>
                            {% if file.is_indexed and file.indexing_status == 'Completed' %}
                            <button onclick="rehuntSingleFile({{ file.id }})" 
                                    class="btn btn-sm" 
                                    style="background: var(--color-warning); color: white; padding: 4px 8px; font-size: 0.75rem;"
                                    title="Re-hunt IOCs for this file">
                                üéØ
                            </button>
                            {% else %}
                            <span class="text-muted" style="font-size: 0.75rem;">‚Äî</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div style="text-align: center; padding: var(--spacing-2xl); color: var(--color-text-muted);">
            <div style="font-size: 3rem; margin-bottom: var(--spacing-md);">üìÑ</div>
            <h3>No files uploaded yet</h3>
            <p>Upload EVTX, NDJSON, JSON, CSV, or ZIP files to start processing</p>
            <a href="{{ url_for('upload_files', case_id=case.id) }}" class="btn btn-primary" style="margin-top: var(--spacing-lg);">
                Upload Files
            </a>
        </div>
        {% endif %}
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// Live status updates - refresh every 3 seconds
function updateStatuses() {
    fetch('/case/{{ case.id }}/status')
        .then(response => response.json())
        .then(data => {
            let processingCount = 0;
            let completedCount = 0;
            
            data.files.forEach(file => {
                const row = document.querySelector(`tr[data-file-id="${file.id}"]`);
                if (!row) return;
                
                // Update status
                const statusCell = row.querySelector('.status-cell');
                const currentStatus = statusCell.textContent.trim();
                
                if (currentStatus !== file.status) {
                    let statusClass = 'status-failed';
                    let pulsing = '';
                    
                    if (file.status === 'Completed') {
                        statusClass = 'status-completed';
                        completedCount++;
                    } else if (file.status === 'Indexing') {
                        statusClass = 'status-indexing';
                        pulsing = ' pulsing';
                        processingCount++;
                    } else if (file.status === 'SIGMA Testing') {
                        statusClass = 'status-sigma';
                        pulsing = ' pulsing';
                        processingCount++;
                    } else if (file.status === 'IOC Hunting') {
                        statusClass = 'status-ioc';
                        pulsing = ' pulsing';
                        processingCount++;
                    } else if (file.status === 'Queued') {
                        statusClass = 'status-queued';
                        processingCount++;
                    }
                    
                    statusCell.innerHTML = `<span class="status-badge ${statusClass}${pulsing}">${file.status}</span>`;
                }
                
                // Update counts
                row.querySelector('.event-count').textContent = file.event_count.toLocaleString();
                
                const sigmaCell = row.querySelector('.sigma-count');
                if (file.violation_count > 0) {
                    sigmaCell.innerHTML = `<span class="status-badge status-sigma">${file.violation_count}</span>`;
                } else {
                    sigmaCell.innerHTML = '<span class="text-muted">0</span>';
                }
                
                const iocCell = row.querySelector('.ioc-count');
                if (file.ioc_event_count > 0) {
                    iocCell.innerHTML = `<span class="status-badge status-ioc">${file.ioc_event_count}</span>`;
                } else {
                    iocCell.innerHTML = '<span class="text-muted">0</span>';
                }
            });
        })
        .catch(err => console.error('Status update failed:', err));
}

// Update every 3 seconds
setInterval(updateStatuses, 3000);

// Initial update after 1 second
setTimeout(updateStatuses, 1000);

// Update statistics tiles
function updateStatsTiles() {
    fetch(`/api/case/{{ case.id }}/stats`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Update file statistics
                document.getElementById('stat-total-files').textContent = data.file_stats.total_files;
                document.getElementById('stat-indexed-files').textContent = data.file_stats.indexed_files;
                document.getElementById('stat-processing-files').textContent = data.file_stats.processing_files;
                document.getElementById('stat-disk-space').textContent = data.file_stats.disk_space_mb + ' MB';
                
                // Update event statistics
                document.getElementById('stat-total-events').textContent = data.event_stats.total_events.toLocaleString();
                document.getElementById('stat-total-sigma').textContent = data.event_stats.total_sigma.toLocaleString();
                document.getElementById('stat-total-ioc-events').textContent = data.event_stats.total_ioc_events.toLocaleString();
                document.getElementById('stat-total-iocs').textContent = data.event_stats.total_iocs;
            }
        })
        .catch(err => console.error('Stats update failed:', err));
}

// Update stats every 3 seconds
setInterval(updateStatsTiles, 3000);

// Initial stats update after 500ms
setTimeout(updateStatsTiles, 500);

// Clear all files confirmation
function confirmClearFiles() {
    if (confirm('‚ö†Ô∏è WARNING: This will permanently delete ALL files from this case!\n\nThis action will:\n‚Ä¢ Remove all files from the filesystem\n‚Ä¢ Delete all database records (files, SIGMA violations, IOC matches)\n‚Ä¢ Remove all data from OpenSearch\n\nThis CANNOT be undone!\n\nAre you absolutely sure?')) {
        // Create a form and submit it
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '{{ url_for("clear_all_files", case_id=case.id) }}';
        document.body.appendChild(form);
        form.submit();
    }
}

function confirmRehuntIOCs() {
    if (confirm('üéØ Re-Hunt IOCs\n\nThis will:\n‚Ä¢ Clear all existing IOC matches for this case\n‚Ä¢ Re-scan all completed files for IOC matches\n‚Ä¢ Update IOC event counts\n\nThis may take a few minutes depending on file count.\n\nContinue?')) {
        // Create a form and submit it
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '{{ url_for("rehunt_iocs", case_id=case.id) }}';
        document.body.appendChild(form);
        form.submit();
    }
}

function rehuntSingleFile(fileId) {
    if (confirm('üéØ Re-Hunt IOCs for This File\n\nThis will:\n‚Ä¢ Clear existing IOC matches for this file only\n‚Ä¢ Re-scan this file for IOC matches\n‚Ä¢ Update IOC event count\n\nContinue?')) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/case/{{ case.id }}/file/${fileId}/rehunt_iocs`;
        document.body.appendChild(form);
        form.submit();
    }
}

// ============================================================================
// AI REPORT GENERATION
// ============================================================================

function generateAIReport() {
    const button = document.getElementById('aiReportBtn');
    button.disabled = true;
    button.innerHTML = '<span>‚è≥</span><span>Starting...</span>';
    
    fetch('/case/{{ case.id }}/ai/generate', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Fetch report details to get estimated duration
            fetch(`/ai/report/${data.report_id}`)
                .then(r => r.json())
                .then(reportData => {
                    const estimatedMinutes = reportData.estimated_duration ? (reportData.estimated_duration / 60) : 3;
                    // Show progress modal with smart estimate
                    showProgressModal(data.report_id, estimatedMinutes);
                    // Start polling for progress
                    checkAIReportStatus(data.report_id);
                })
                .catch(err => {
                    // Fallback if fetch fails
                    showProgressModal(data.report_id, 3);
                    checkAIReportStatus(data.report_id);
                });
        } else {
            alert(`‚ùå Failed to Generate Report\n\n${data.error}`);
            button.disabled = false;
            button.innerHTML = '<span>ü§ñ</span><span>Generate AI Report</span>';
        }
    })
    .catch(err => {
        console.error('AI report generation failed:', err);
        alert(`‚ùå Error: ${err.message}`);
        button.disabled = false;
        button.innerHTML = '<span>ü§ñ</span><span>Generate AI Report</span>';
    });
}

function showProgressModal(reportId, estimatedMinutes = 3) {
    // Create modal overlay
    const modal = document.createElement('div');
    modal.id = 'aiProgressModal';
    modal.style.cssText = `
        position: fixed !important;
        top: 0 !important;
        left: 0 !important;
        width: 100% !important;
        height: 100% !important;
        background-color: rgba(0, 0, 0, 0.85) !important;
        backdrop-filter: blur(4px) !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        z-index: 99999 !important;
    `;
    
    const estimateText = estimatedMinutes < 2 
        ? 'This will take ~2 minutes'
        : `This will take ~${Math.round(estimatedMinutes)} minutes`;
    
    modal.innerHTML = `
        <div style="background: var(--color-background); padding: var(--spacing-xl); border-radius: var(--border-radius); max-width: 600px; width: 90%; box-shadow: 0 8px 32px rgba(0,0,0,0.3);">
            <div style="display: flex; align-items: center; gap: var(--spacing-md); margin-bottom: var(--spacing-lg);">
                <span style="font-size: 2rem;">ü§ñ</span>
                <div style="flex: 1;">
                    <h2 style="margin: 0; font-size: 1.25rem;">AI Report Generation</h2>
                    <p id="estimatedTimeText" style="margin: var(--spacing-xs) 0 0 0; color: var(--color-text-muted); font-size: 0.875rem;">${estimateText}</p>
                </div>
            </div>
            
            <!-- Current Stage Indicator -->
            <div style="background: var(--color-primary-bg); border: 1px solid var(--color-primary); border-radius: var(--border-radius); padding: var(--spacing-sm) var(--spacing-md); margin-bottom: var(--spacing-md); display: flex; align-items: center; gap: var(--spacing-sm);">
                <span style="font-size: 1.5rem;">‚öôÔ∏è</span>
                <div>
                    <div style="font-size: 0.75rem; color: var(--color-text-muted); text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600;">Current Stage</div>
                    <div id="currentStage" style="font-size: 0.95rem; font-weight: 600; color: var(--color-primary); margin-top: 2px;">Initializing</div>
                </div>
            </div>
            
            <div style="margin-bottom: var(--spacing-md);">
                <div style="display: flex; justify-content: space-between; margin-bottom: var(--spacing-xs);">
                    <span id="progressMessage" style="font-size: 0.875rem; color: var(--color-text-muted);">Initializing...</span>
                    <span id="progressPercent" style="font-size: 0.875rem; font-weight: 600; color: var(--color-primary);">0%</span>
                </div>
                <div style="width: 100%; height: 24px; background: var(--color-background-secondary); border-radius: 12px; overflow: hidden; border: 1px solid var(--color-border);">
                    <div id="progressBar" style="height: 100%; background: linear-gradient(90deg, var(--color-primary), var(--color-success)); width: 0%; transition: width 0.3s ease;"></div>
                </div>
            </div>
            
            <div style="background: var(--color-background-secondary); padding: var(--spacing-md); border-radius: var(--border-radius); margin-bottom: var(--spacing-md);">
                <div style="display: flex; gap: var(--spacing-lg); font-size: 0.875rem;">
                    <div>
                        <span style="color: var(--color-text-muted);">‚è±Ô∏è Elapsed:</span>
                        <strong id="elapsedTime" style="margin-left: var(--spacing-xs);">0s</strong>
                    </div>
                    <div>
                        <span style="color: var(--color-text-muted);">‚è≥ Remaining:</span>
                        <strong id="remainingTime" style="margin-left: var(--spacing-xs);">~4m</strong>
                    </div>
                    <div id="tokensPerSecDiv" style="display: none;">
                        <span style="color: var(--color-text-muted);">‚ö° Speed:</span>
                        <strong id="tokensPerSec" style="margin-left: var(--spacing-xs); color: var(--color-success);">--</strong>
                    </div>
                </div>
            </div>
            
            <div id="progressLog" style="background: var(--color-background); border: 1px solid var(--color-border); border-radius: var(--border-radius); padding: var(--spacing-sm); max-height: 120px; overflow-y: auto; font-size: 0.8rem; font-family: monospace; color: var(--color-text-muted);"></div>
            
            <div style="display: flex; gap: var(--spacing-md); margin-top: var(--spacing-md); align-items: center;">
                <button id="togglePreviewBtn" onclick="toggleLivePreview(${reportId})" style="background: var(--color-success); color: white; border: none; padding: var(--spacing-sm) var(--spacing-md); border-radius: var(--border-radius); cursor: pointer; font-weight: 600; transition: all 0.2s;">
                    üìÑ Show Live Preview
                </button>
                <button id="cancelReportBtn" onclick="cancelAIReport(${reportId})" style="background: var(--color-error); color: white; border: none; padding: var(--spacing-sm) var(--spacing-md); border-radius: var(--border-radius); cursor: pointer; font-weight: 600; transition: all 0.2s;">
                    ‚õî Cancel Generation
                </button>
                <p style="margin: 0; flex: 1; text-align: right; font-size: 0.875rem; color: var(--color-text-muted);">
                    üí° You can close this and the report will continue
                </p>
            </div>
            
            <!-- Live Preview Container (Hidden by default) -->
            <div id="livePreviewContainer" style="display: none; margin-top: var(--spacing-md); border-top: 2px solid var(--color-border); padding-top: var(--spacing-md);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-sm);">
                    <h3 style="margin: 0; font-size: 1rem; display: flex; align-items: center; gap: var(--spacing-xs);">
                        <span>üìù</span>
                        <span>Live Report Preview</span>
                    </h3>
                    <span id="previewUpdateIndicator" style="font-size: 0.75rem; color: var(--color-text-muted);">Updates every 3 seconds</span>
                </div>
                <div id="livePreviewContent" style="background: #ffffff; border: 1px solid var(--color-border); border-radius: var(--border-radius); padding: var(--spacing-md); max-height: 400px; overflow-y: auto; font-size: 0.875rem; line-height: 1.6; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; color: #1a1a1a;">
                    <p style="color: #666; text-align: center; padding: var(--spacing-lg);">Loading preview...</p>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    // Allow clicking outside to close (but keep generating)
    modal.addEventListener('click', (e) => {
        if (e.target === modal) {
            modal.remove();
        }
    });
}

function updateProgressUI(data) {
    const progressBar = document.getElementById('progressBar');
    const progressPercent = document.getElementById('progressPercent');
    const progressMessage = document.getElementById('progressMessage');
    const currentStage = document.getElementById('currentStage');
    const progressLog = document.getElementById('progressLog');
    
    if (!progressBar) return; // Modal closed
    
    // Update progress bar
    progressBar.style.width = `${data.progress_percent}%`;
    progressPercent.textContent = `${data.progress_percent}%`;
    progressMessage.textContent = data.progress_message;
    
    // Update current stage with icon
    if (currentStage && data.current_stage) {
        const stageIcons = {
            'Initializing': 'üîÑ',
            'Collecting Data': 'üìä',
            'Analyzing Data': 'üîç',
            'Generating Report': '‚úçÔ∏è',
            'Finalizing': 'üìù',
            'Completed': '‚úÖ',
            'Cancelled': '‚õî',
            'Failed': '‚ùå'
        };
        const icon = stageIcons[data.current_stage] || '‚öôÔ∏è';
        currentStage.innerHTML = `${icon} ${data.current_stage}`;
    }
    
    // Add log entry
    const timestamp = new Date().toLocaleTimeString();
    const logEntry = document.createElement('div');
    logEntry.textContent = `[${timestamp}] ${data.progress_message}`;
    logEntry.style.marginBottom = '4px';
    progressLog.appendChild(logEntry);
    progressLog.scrollTop = progressLog.scrollHeight;
}

function checkAIReportStatus(reportId, attempts = 0, startTime = null) {
    const button = document.getElementById('aiReportBtn');
    const maxAttempts = 120; // 120 * 3s = 6 minutes max
    
    if (attempts >= maxAttempts) {
        const modal = document.getElementById('aiProgressModal');
        if (modal) modal.remove();
        button.disabled = false;
        button.innerHTML = '<span>ü§ñ</span><span>Generate AI Report</span>';
        alert('‚è±Ô∏è Report generation is taking longer than expected. Please refresh the page to check status.');
        return;
    }
    
    fetch(`/ai/report/${reportId}`)
        .then(response => response.json())
        .then(data => {
            // Get the real start time from the report's created_at timestamp (parse ISO string properly)
            if (!startTime && data.created_at) {
                // Parse the ISO timestamp correctly
                startTime = new Date(data.created_at + 'Z').getTime(); // Add Z to ensure UTC parsing
            }
            
            // Calculate elapsed time from report creation
            const now = Date.now();
            const elapsedSeconds = startTime ? Math.max(0, Math.floor((now - startTime) / 1000)) : 0;
            const elapsedTime = document.getElementById('elapsedTime');
            const remainingTime = document.getElementById('remainingTime');
            
            if (elapsedTime && elapsedSeconds >= 0) {
                const minutes = Math.floor(elapsedSeconds / 60);
                const seconds = elapsedSeconds % 60;
                elapsedTime.textContent = minutes > 0 ? `${minutes}m ${seconds}s` : `${seconds}s`;
            }
            
            // Update progress UI if modal is open
            updateProgressUI(data);
            
            // Update remaining time estimate based on real estimation from backend
            if (remainingTime && data.progress_percent > 0 && data.progress_percent < 100 && data.estimated_duration) {
                // Use backend's smart estimation (in SECONDS)
                const estimatedTotalSeconds = data.estimated_duration;
                const estimatedRemaining = Math.max(0, Math.floor(estimatedTotalSeconds - elapsedSeconds));
                const remMinutes = Math.floor(estimatedRemaining / 60);
                const remSeconds = estimatedRemaining % 60;
                remainingTime.textContent = remMinutes > 0 ? `~${remMinutes}m ${remSeconds}s` : `~${remSeconds}s`;
            } else if (remainingTime && data.progress_percent >= 100) {
                remainingTime.textContent = '0s';
            }
            
            // Update tokens/second if available (real-time during generation)
            const tokensDiv = document.getElementById('tokensPerSecDiv');
            const tokensText = document.getElementById('tokensPerSec');
            if (tokensDiv && tokensText) {
                // Show tok/s if we have the data (even during generation)
                if (data.tokens_per_second && data.tokens_per_second > 0) {
                    tokensDiv.style.display = 'block';
                    tokensText.textContent = `${data.tokens_per_second.toFixed(2)} tok/s`;
                    
                    // Also show total tokens if available
                    if (data.total_tokens && data.total_tokens > 0) {
                        tokensText.textContent = `${data.tokens_per_second.toFixed(2)} tok/s (${data.total_tokens} tokens)`;
                    }
                } else if (data.status === 'generating') {
                    // Show placeholder during generation if no data yet
                    tokensDiv.style.display = 'block';
                    tokensText.textContent = 'calculating...';
                }
            }
            
            if (data.status === 'completed') {
                // Close modal
                const modal = document.getElementById('aiProgressModal');
                if (modal) modal.remove();
                
                button.disabled = false;
                button.innerHTML = '<span>ü§ñ</span><span>Generate AI Report</span>';
                
                // Build success message with tokens/second if available
                let successMsg = `‚úÖ Report Generated Successfully!\n\nTitle: ${data.title}\nGeneration Time: ${data.generation_time.toFixed(1)}s`;
                if (data.tokens_per_second) {
                    successMsg += `\nSpeed: ${data.tokens_per_second.toFixed(2)} tokens/second`;
                    if (data.total_tokens) {
                        successMsg += `\nTotal Tokens: ${data.total_tokens}`;
                    }
                }
                successMsg += '\n\nClick "OK" to download, or use "Refine with AI" button to make changes.';
                alert(successMsg);
                
                // Download the report
                window.location.href = `/ai/report/${reportId}/download`;
                
                // Refresh the reports list to show the new report
                loadAIReportsList();
                
                // Scroll to the AI Reports section
                setTimeout(() => {
                    const reportsSection = document.getElementById('aiReportsList');
                    if (reportsSection) {
                        reportsSection.closest('.card').scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                }, 500);
            } else if (data.status === 'failed') {
                // Close modal
                const modal = document.getElementById('aiProgressModal');
                if (modal) modal.remove();
                
                button.disabled = false;
                button.innerHTML = '<span>ü§ñ</span><span>Generate AI Report</span>';
                alert(`‚ùå Report Generation Failed\n\n${data.error_message}`);
            } else {
                // Still pending or generating - continue polling
                setTimeout(() => checkAIReportStatus(reportId, attempts + 1, startTime), 3000);
            }
        })
        .catch(err => {
            console.error('Status check failed:', err);
            setTimeout(() => checkAIReportStatus(reportId, attempts + 1, startTime), 3000);
        });
}

// ============================================================================
// CHECK STATUS MODE - For Active Reports
// ============================================================================

function checkActiveReport() {
    // Check if there's already a report being generated for this case
    fetch('/case/{{ case.id }}/ai/reports')
        .then(response => response.json())
        .then(data => {
            if (data.reports && data.reports.length > 0) {
                // Find the most recent generating report
                const activeReport = data.reports.find(r => r.status === 'generating' || r.status === 'pending');
                
                if (activeReport) {
                    // Update button to "Check Status" mode
                    const button = document.getElementById('aiReportBtn');
                    button.innerHTML = '<span>üìä</span><span>Check Report Status</span>';
                    button.style.background = 'var(--color-success)';
                    button.onclick = () => checkStatus(activeReport.id);
                    
                    // Store active report ID for easy access
                    button.dataset.activeReportId = activeReport.id;
                }
            }
        })
        .catch(err => {
            console.error('Failed to check for active reports:', err);
        });
}

function checkStatus(reportId) {
    // Open the progress modal and start monitoring from current position
    showProgressModal(reportId);
    checkAIReportStatus(reportId);
}

// ============================================================================
// DELETE AI REPORT (Failed & Cancelled Reports)
// ============================================================================

function deleteAIReport(reportId) {
    // Confirm deletion
    if (!confirm('Are you sure you want to delete this report? This action cannot be undone.')) {
        return;
    }
    
    // Show loading state
    const button = event.target.closest('button');
    const originalContent = button.innerHTML;
    button.disabled = true;
    button.innerHTML = '<span>üóëÔ∏è Deleting...</span>';
    
    fetch(`/ai/report/${reportId}`, {
        method: 'DELETE',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert(`Error deleting report: ${data.error}`);
            button.disabled = false;
            button.innerHTML = originalContent;
        } else {
            // Show success message
            showFlash('‚úÖ Report deleted successfully', 'success');
            
            // Reload reports list
            loadAIReports();
        }
    })
    .catch(err => {
        console.error('Failed to delete report:', err);
        alert(`Failed to delete report: ${err.message}`);
        button.disabled = false;
        button.innerHTML = originalContent;
    });
}

function showFlash(message, type) {
    // Create flash message element
    const flash = document.createElement('div');
    flash.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: var(--spacing-md);
        background: ${type === 'success' ? 'var(--color-success)' : 'var(--color-error)'};
        color: white;
        border-radius: var(--border-radius);
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        z-index: 10000;
        opacity: 0;
        transform: translateX(400px);
        transition: all 0.3s ease;
    `;
    flash.textContent = message;
    
    document.body.appendChild(flash);
    
    // Slide in
    setTimeout(() => {
        flash.style.opacity = '1';
        flash.style.transform = 'translateX(0)';
    }, 10);
    
    // Auto-remove after 3 seconds
    setTimeout(() => {
        flash.style.opacity = '0';
        flash.style.transform = 'translateX(400px)';
        setTimeout(() => flash.remove(), 300);
    }, 3000);
}

function cancelAIReport(reportId) {
    if (!confirm('‚ö†Ô∏è Are you sure you want to cancel this report generation?\n\nThis action cannot be undone.')) {
        return;
    }
    
    const cancelBtn = document.getElementById('cancelReportBtn');
    if (cancelBtn) {
        cancelBtn.disabled = true;
        cancelBtn.textContent = '‚è≥ Cancelling...';
    }
    
    fetch(`/ai/report/${reportId}/cancel`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Close modal
            const modal = document.getElementById('aiProgressModal');
            if (modal) modal.remove();
            
            // Re-enable button
            const button = document.getElementById('aiReportBtn');
            if (button) {
                button.disabled = false;
                button.innerHTML = '<span>ü§ñ</span><span>Generate AI Report</span>';
            }
            
            // Reload reports list to show cancelled status
            if (typeof loadAIReportsList === 'function') {
                loadAIReportsList();
            }
            
            alert('‚úì Report generation has been cancelled successfully.');
        } else {
            alert(`‚ùå Failed to cancel report: ${data.error || 'Unknown error'}`);
            if (cancelBtn) {
                cancelBtn.disabled = false;
                cancelBtn.textContent = '‚õî Cancel Generation';
            }
        }
    })
    .catch(err => {
        console.error('Cancel failed:', err);
        alert('‚ùå Failed to cancel report. Please try again.');
        if (cancelBtn) {
            cancelBtn.disabled = false;
            cancelBtn.textContent = '‚õî Cancel Generation';
        }
    });
}

// Check for active reports when page loads
window.addEventListener('load', () => {
    checkActiveReport();
    loadAIReportsList();
    
    // Re-check every 30 seconds in case user navigates back
    setInterval(checkActiveReport, 30000);
});

// ============================================================================
// AI REPORTS LIST DISPLAY
// ============================================================================

function deleteAIReport(reportId) {
    if (!confirm('‚ö†Ô∏è Are you sure you want to delete this AI report?\n\nThis action cannot be undone.')) {
        return;
    }
    
    fetch(`/ai/report/${reportId}`, {
        method: 'DELETE',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`‚úÖ ${data.message}`);
            // Reload the reports list
            loadAIReportsList();
        } else {
            alert(`‚ùå Error: ${data.error || 'Failed to delete report'}`);
        }
    })
    .catch(err => {
        console.error('Delete error:', err);
        alert(`‚ùå Error deleting report: ${err.message}`);
    });
}

function loadAIReportsList() {
    fetch('/case/{{ case.id }}/ai/reports')
        .then(response => {
            console.log('AI Reports API Response Status:', response.status);
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('AI Reports Data:', data);
            const reportsList = document.getElementById('aiReportsList');
            const reportsCount = document.getElementById('aiReportsCount');
            
            if (!data.reports || data.reports.length === 0) {
                reportsList.innerHTML = `
                    <p style="color: var(--color-text-muted); text-align: center; padding: var(--spacing-lg);">
                        No AI reports generated yet. Click "Generate AI Report" button above to create one.
                    </p>
                `;
                reportsCount.textContent = '0 reports';
                return;
            }
            
            reportsCount.textContent = `${data.reports.length} report${data.reports.length > 1 ? 's' : ''}`;
            
            // Build reports list
            let html = '<div style="display: flex; flex-direction: column; gap: var(--spacing-md);">';
            
            data.reports.forEach(report => {
                const statusColors = {
                    'completed': 'var(--color-success)',
                    'generating': 'var(--color-warning)',
                    'failed': 'var(--color-error)',
                    'pending': 'var(--color-info)'
                };
                const statusColor = statusColors[report.status] || 'var(--color-text-muted)';
                const createdDate = new Date(report.created_at).toLocaleString();
                const genTime = report.generation_time ? ` (${report.generation_time.toFixed(1)}s)` : '';
                
                html += `
                    <div style="border: 1px solid var(--color-border); border-radius: 8px; padding: var(--spacing-md); background: ${report.status === 'completed' ? 'var(--color-bg-secondary)' : 'var(--color-bg)'};">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: var(--spacing-md);">
                            <div style="flex: 1;">
                                <h3 style="margin: 0 0 var(--spacing-xs) 0; font-size: 1rem;">
                                    ${report.title || 'Untitled Report'}
                                </h3>
                                <div style="display: flex; flex-wrap: wrap; gap: var(--spacing-sm); font-size: 0.875rem; color: var(--color-text-muted);">
                                    <span>
                                        <strong>Status:</strong> 
                                        <span style="color: ${statusColor}; font-weight: 600;">${report.status}</span>
                                    </span>
                `
;
                
                // Add validation badge if available
                if (report.validation && report.status === 'completed') {
                    let validationIcon, validationColor, validationText;
                    if (report.validation.passed && report.validation.warnings.length === 0) {
                        validationIcon = '‚úÖ';
                        validationColor = 'var(--color-success)';
                        validationText = 'Validated';
                    } else if (report.validation.passed && report.validation.warnings.length > 0) {
                        validationIcon = '‚ö†Ô∏è';
                        validationColor = 'var(--color-warning)';
                        validationText = `${report.validation.warnings.length} Warnings`;
                    } else {
                        validationIcon = '‚ùå';
                        validationColor = 'var(--color-error)';
                        validationText = `${report.validation.errors.length} Errors`;
                    }
                    
                    html += `
                                    <span>‚Ä¢</span>
                                    <span title="Validation: ${validationText}">
                                        <strong>Validation:</strong> 
                                        <span style="color: ${validationColor}; font-weight: 600;">${validationIcon} ${validationText}</span>
                                    </span>
                    `;
                }
                
                html += `
                                    <span>‚Ä¢</span>
                                    <span><strong>Created:</strong> ${createdDate}</span>
                `;
                
                if (report.model_name) {
                    html += `
                                    <span>‚Ä¢</span>
                                    <span><strong>Model:</strong> ${report.model_name}</span>
                    `;
                }
                
                if (report.generation_time) {
                    html += `
                                    <span>‚Ä¢</span>
                                    <span><strong>Time:</strong> ${report.generation_time.toFixed(1)}s</span>
                    `;
                }
                
                html += `
                                </div>
                            </div>
                            <div style="display: flex; gap: var(--spacing-xs); flex-shrink: 0;">
                `;
                
                if (report.status === 'completed') {
                    html += `
                        <button onclick="showAIReportChat(${report.id})" class="btn btn-sm btn-success" title="Refine this report with AI">
                            <span>ü§ñ Refine with AI</span>
                        </button>
                        <button onclick="showAIReportReview(${report.id})" class="btn btn-sm btn-info" title="Review AI prompts and responses">
                            <span>üîç Review AI</span>
                        </button>
                        <a href="/ai/report/${report.id}/download" class="btn btn-sm btn-primary" title="Download report">
                            <span>üíæ Download</span>
                        </a>
                    `;
                    
                    // Add delete button for administrators only
                    if ('{{ current_user.role }}' === 'administrator') {
                        html += `
                            <button onclick="deleteAIReport(${report.id})" class="btn btn-sm" style="background: var(--color-error); color: white;" title="Delete report (Admin only)">
                                <span>üóëÔ∏è Delete</span>
                            </button>
                        `;
                    }
                } else if (report.status === 'generating' || report.status === 'pending') {
                    html += `
                        <button onclick="checkStatus(${report.id})" class="btn btn-sm" style="background: var(--color-info); color: white;">
                            <span>üìä Check Status</span>
                        </button>
                    `;
                } else if (report.status === 'failed') {
                    html += `
                        <button class="btn btn-sm" style="background: var(--color-error); color: white;" disabled>
                            <span>‚ùå Failed</span>
                        </button>
                        <button onclick="deleteAIReport(${report.id})" class="btn btn-sm" style="background: var(--color-error); color: white; opacity: 0.8;" title="Delete this failed report">
                            <span>üóëÔ∏è Delete</span>
                        </button>
                    `;
                } else if (report.status === 'cancelled') {
                    html += `
                        <button class="btn btn-sm" style="background: var(--color-warning); color: white;" disabled>
                            <span>‚õî Cancelled</span>
                        </button>
                        <button onclick="deleteAIReport(${report.id})" class="btn btn-sm" style="background: var(--color-warning); color: white; opacity: 0.8;" title="Delete this cancelled report">
                            <span>üóëÔ∏è Delete</span>
                        </button>
                    `;
                }
                
                html += `
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            reportsList.innerHTML = html;
        })
        .catch(err => {
            console.error('Failed to load AI reports:', err);
            const errorMsg = err.message || 'Unknown error';
            document.getElementById('aiReportsList').innerHTML = 
                '<p style="color: var(--color-error); text-align: center; padding: var(--spacing-lg);">' +
                    '‚ùå Failed to load reports: ' + errorMsg + '<br>' +
                    '<small>Check browser console (F12) for details, or refresh the page.</small>' +
                '</p>';
            document.getElementById('aiReportsCount').textContent = 'Error';
        });
}

// ============================================================================
// AI REPORT REFINEMENT CHAT
// ============================================================================

function showAIReportChat(reportId) {
    fetch(`/ai/report/${reportId}`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert(`Error: ${data.error}`);
                return;
            }
            
            // Create chat modal
            const modal = document.createElement('div');
            modal.id = 'aiChatModal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.7);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 10000;
            `;
            
            modal.innerHTML = `
                <div style="background: white; width: 95%; max-width: 1400px; height: 90%; border-radius: 8px; display: flex; flex-direction: column; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
                    <!-- Header -->
                    <div style="padding: 20px; border-bottom: 2px solid #e0e0e0; display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h2 style="margin: 0; font-size: 1.5rem;">ü§ñ AI Report Refinement</h2>
                            <p style="margin: 5px 0 0 0; color: #666; font-size: 0.875rem;">Chat with AI to refine your report</p>
                        </div>
                        <button onclick="closeAIChatModal()" style="background: none; border: none; font-size: 2rem; cursor: pointer; color: #999;">&times;</button>
                    </div>
                    
                    <!-- Content Area: Split View -->
                    <div style="flex: 1; display: flex; overflow: hidden;">
                        <!-- Report Preview (Left) -->
                        <div style="flex: 1; border-right: 2px solid #e0e0e0; display: flex; flex-direction: column;">
                            <div style="padding: 15px; background: #f8f9fa; border-bottom: 1px solid #e0e0e0; display: flex; justify-content: space-between; align-items: center;">
                                <h3 style="margin: 0; font-size: 1rem; color: #555;">üìÑ Report Preview</h3>
                                <a href="/ai/report/${reportId}/download" class="btn btn-sm btn-secondary" style="padding: 5px 15px; text-decoration: none;">
                                    <span>üíæ Download</span>
                                </a>
                            </div>
                            <div id="reportPreviewContent" style="flex: 1; overflow-y: auto; padding: 20px; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;">
                                ${data.content || '<p style="color: #999;">Loading report...</p>'}
                            </div>
                        </div>
                        
                        <!-- Chat Interface (Right) -->
                        <div style="width: 450px; display: flex; flex-direction: column;">
                            <div style="padding: 15px; background: #f8f9fa; border-bottom: 1px solid #e0e0e0;">
                                <h3 style="margin: 0; font-size: 1rem; color: #555;">üí¨ Refinement Chat</h3>
                            </div>
                            
                            <!-- Chat Messages -->
                            <div id="chatMessages" style="flex: 1; overflow-y: auto; padding: 15px; background: #fafafa;">
                                <div style="padding: 15px; background: white; border: 1px solid #e0e0e0; border-radius: 8px; margin-bottom: 10px;">
                                    <p style="margin: 0; color: #555; font-size: 0.875rem;">
                                        <strong>üí° Examples:</strong><br>
                                        ‚Ä¢ "Add more detail about the password dumping technique"<br>
                                        ‚Ä¢ "Rewrite the executive summary for non-technical executives"<br>
                                        ‚Ä¢ "Expand the timeline between 2:00 PM and 3:00 PM"<br>
                                        ‚Ä¢ "Add a recommendations section"
                                    </p>
                                </div>
                            </div>
                            
                            <!-- Chat Input -->
                            <div style="padding: 15px; border-top: 2px solid #e0e0e0; background: white;">
                                <textarea id="chatInput" placeholder="Type your refinement request..." style="width: 100%; height: 80px; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.875rem; font-family: inherit; resize: none; margin-bottom: 10px;"></textarea>
                                <button id="chatSendBtn" class="btn btn-primary" style="width: 100%; padding: 10px;">
                                    <span>üì§ Send Request</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Store reportId for later use
            modal.dataset.reportId = reportId;
            
            // Load chat history
            loadChatHistory(reportId);
            
            // Focus chat input
            document.getElementById('chatInput').focus();
            
            // Add button click handler
            document.getElementById('chatSendBtn').onclick = function() {
                sendChatMessage(reportId);
            };
            
            // Add Enter key support (Shift+Enter for new line, Enter to send)
            document.getElementById('chatInput').addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendChatMessage(reportId);
                }
            });
        })
        .catch(err => {
            console.error('Error loading report:', err);
            alert('Failed to load report for chat');
        });
}

function closeAIChatModal() {
    const modal = document.getElementById('aiChatModal');
    if (modal) modal.remove();
}

function loadChatHistory(reportId) {
    fetch(`/ai/report/${reportId}/chat`)
        .then(response => response.json())
        .then(data => {
            const chatMessages = document.getElementById('chatMessages');
            
            // Add existing messages
            if (data.messages && data.messages.length > 0) {
                data.messages.forEach(msg => {
                    appendChatMessage(msg.role, msg.message, msg.id, msg.applied);
                });
            }
        })
        .catch(err => {
            console.error('Error loading chat history:', err);
        });
}

function appendChatMessage(role, message, messageId = null, applied = false) {
    const chatMessages = document.getElementById('chatMessages');
    const isUser = role === 'user';
    
    const msgDiv = document.createElement('div');
    msgDiv.style.cssText = `
        margin-bottom: 15px;
        padding: 12px;
        border-radius: 8px;
        background: ${isUser ? '#e3f2fd' : 'white'};
        border: 1px solid ${isUser ? '#90caf9' : '#e0e0e0'};
    `;
    
    let applyButton = '';
    if (!isUser && messageId && !applied) {
        applyButton = `
            <button onclick="applyRefinement(${messageId}, this)" class="btn btn-sm btn-success" style="padding: 5px 15px; margin-top: 10px;">
                <span>‚úÖ Apply to Report</span>
            </button>
        `;
    } else if (!isUser && applied) {
        applyButton = `<p style="margin-top: 10px; color: #4caf50; font-size: 0.75rem;">‚úÖ Applied to report</p>`;
    }
    
    msgDiv.innerHTML = `
        <div style="display: flex; align-items: center; margin-bottom: 5px;">
            <span style="font-size: 1.2rem; margin-right: 8px;">${isUser ? 'üë§' : 'ü§ñ'}</span>
            <strong style="font-size: 0.875rem; color: #555;">${isUser ? 'You' : 'AI Assistant'}</strong>
        </div>
        <div style="font-size: 0.875rem; color: #333; white-space: pre-wrap;">${message}</div>
        ${applyButton}
    `;
    
    chatMessages.appendChild(msgDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

function sendChatMessage(reportId) {
    const input = document.getElementById('chatInput');
    const button = document.getElementById('chatSendBtn');
    const message = input.value.trim();
    
    if (!message) return;
    
    // Add user message to chat
    appendChatMessage('user', message);
    
    // Clear input and disable button
    input.value = '';
    button.disabled = true;
    button.innerHTML = '<span>‚è≥ AI is thinking...</span>';
    
    // Create AI response placeholder
    const chatMessages = document.getElementById('chatMessages');
    const aiMsgDiv = document.createElement('div');
    aiMsgDiv.style.cssText = `
        margin-bottom: 15px;
        padding: 12px;
        border-radius: 8px;
        background: white;
        border: 1px solid #e0e0e0;
    `;
    aiMsgDiv.innerHTML = `
        <div style="display: flex; align-items: center; margin-bottom: 5px;">
            <span style="font-size: 1.2rem; margin-right: 8px;">ü§ñ</span>
            <strong style="font-size: 0.875rem; color: #555;">AI Assistant</strong>
        </div>
        <div id="aiStreamingResponse" style="font-size: 0.875rem; color: #333; white-space: pre-wrap;"></div>
    `;
    chatMessages.appendChild(aiMsgDiv);
    
    // Stream AI response with fetch
    fetch(`/ai/report/${reportId}/chat`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({message: message})
    })
    .then(response => {
        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let fullResponse = '';
        let currentMessageId = null;
        
        function read() {
            reader.read().then(({done, value}) => {
                if (done) {
                    // Add apply button after response completes
                    if (currentMessageId) {
                        const applyBtn = document.createElement('button');
                        applyBtn.className = 'btn btn-sm btn-success';
                        applyBtn.style.cssText = 'padding: 5px 15px; margin-top: 10px;';
                        applyBtn.innerHTML = '<span>‚úÖ Apply to Report</span>';
                        applyBtn.onclick = () => applyRefinement(currentMessageId, applyBtn);
                        aiMsgDiv.appendChild(applyBtn);
                    }
                    
                    button.disabled = false;
                    button.innerHTML = '<span>üì§ Send Request</span>';
                    return;
                }
                
                const chunk = decoder.decode(value, {stream: true});
                const lines = chunk.split('\\n');
                
                lines.forEach(line => {
                    if (line.startsWith('data: ')) {
                        try {
                            const data = JSON.parse(line.substring(6));
                            if (data.chunk) {
                                fullResponse += data.chunk;
                                document.getElementById('aiStreamingResponse').textContent = fullResponse;
                                chatMessages.scrollTop = chatMessages.scrollHeight;
                            }
                            if (data.done && data.message_id) {
                                currentMessageId = data.message_id;
                            }
                            if (data.error) {
                                document.getElementById('aiStreamingResponse').textContent = `‚ùå Error: ${data.error}`;
                            }
                        } catch (e) {
                            // Ignore parse errors
                        }
                    }
                });
                
                read();
            });
        }
        
        read();
    })
    .catch(err => {
        console.error('Chat error:', err);
        document.getElementById('aiStreamingResponse').textContent = `‚ùå Error: ${err.message}`;
        button.disabled = false;
        button.innerHTML = '<span>üì§ Send Request</span>';
    });
}

function applyRefinement(messageId, button) {
    const reportId = button.closest('#aiChatModal').querySelector('[onclick*="applyRefinement"]').getAttribute('onclick').match(/\\d+/)[0];
    
    if (!confirm('Apply this refinement to the report? This will update the report content.')) {
        return;
    }
    
    // Get the AI message content
    const aiResponse = button.parentElement.querySelector('#aiStreamingResponse, div[style*="white-space: pre-wrap"]').textContent;
    
    fetch(`/ai/report/${reportId}/apply`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            message_id: messageId,
            content: aiResponse
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            button.disabled = true;
            button.innerHTML = '<span>‚úÖ Applied</span>';
            button.style.background = '#4caf50';
            
            // Reload report preview
            fetch(`/ai/report/${reportId}`)
                .then(r => r.json())
                .then(d => {
                    document.getElementById('reportPreviewContent').innerHTML = d.content;
                    alert('‚úÖ Refinement applied! Report updated successfully.');
                });
        } else {
            alert(`‚ùå Failed to apply refinement: ${data.error || 'Unknown error'}`);
        }
    })
    .catch(err => {
        console.error('Apply error:', err);
        alert(`‚ùå Error applying refinement: ${err.message}`);
    });
}

function showAIReportReview(reportId) {
    // Fetch prompt and response data
    fetch(`/ai/report/${reportId}/review`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert(`Error: ${data.error}`);
                return;
            }
            
            // Create review modal
            const modal = document.createElement('div');
            modal.id = 'aiReviewModal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.7);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 10000;
            `;
            
            modal.innerHTML = `
                <div style="background: white; width: 95%; max-width: 1400px; height: 90%; border-radius: 8px; display: flex; flex-direction: column; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
                    <!-- Header -->
                    <div style="padding: 20px; border-bottom: 2px solid #e0e0e0; display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h2 style="margin: 0; font-size: 1.5rem;">üîç AI Report Review</h2>
                            <p style="margin: 5px 0 0 0; font-size: 0.875rem; color: #666;">
                                Model: ${data.model_name} | Tokens: ${data.total_tokens || 'N/A'} | Prompt: ${(data.prompt_length / 1024).toFixed(1)}KB | Response: ${(data.response_length / 1024).toFixed(1)}KB
                            </p>
                        </div>
                        <button onclick="document.getElementById('aiReviewModal').remove()" style="background: none; border: none; font-size: 2rem; cursor: pointer; color: #666;">
                            √ó
                        </button>
                    </div>
                    
                    <!-- Content -->
                    <div style="flex: 1; display: flex; gap: 20px; padding: 20px; overflow: hidden;">
                        <!-- Prompt Section -->
                        <div style="flex: 1; display: flex; flex-direction: column;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <h3 style="margin: 0; font-size: 1.125rem;">üì§ Prompt Sent to AI</h3>
                                <button onclick="navigator.clipboard.writeText(document.getElementById('promptText').textContent)" class="btn btn-sm btn-primary">
                                    üìã Copy
                                </button>
                            </div>
                            <div style="flex: 1; background: #ffffff; border: 1px solid #e0e0e0; border-radius: 4px; padding: 15px; overflow-y: auto;">
                                <pre id="promptText" style="margin: 0; font-family: monospace; font-size: 0.8rem; white-space: pre-wrap; word-wrap: break-word; color: #1a1a1a;">${escapeHtml(data.prompt_sent)}</pre>
                            </div>
                        </div>
                        
                        <!-- Response Section -->
                        <div style="flex: 1; display: flex; flex-direction: column;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <h3 style="margin: 0; font-size: 1.125rem;">üì• Raw AI Response</h3>
                                <button onclick="navigator.clipboard.writeText(document.getElementById('responseText').textContent)" class="btn btn-sm btn-primary">
                                    üìã Copy
                                </button>
                            </div>
                            <div style="flex: 1; background: #ffffff; border: 1px solid #e0e0e0; border-radius: 4px; padding: 15px; overflow-y: auto;">
                                <pre id="responseText" style="margin: 0; font-family: monospace; font-size: 0.8rem; white-space: pre-wrap; word-wrap: break-word; color: #1a1a1a;">${escapeHtml(data.raw_response)}</pre>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Footer -->
                    <div style="padding: 15px 20px; border-top: 2px solid #e0e0e0; background: #f8f9fa; text-align: center; font-size: 0.875rem; color: #666;">
                        Use this to verify data accuracy and debug hallucination issues. Compare the prompt data with what appears in the response.
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Close modal on background click
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        })
        .catch(err => {
            console.error('Failed to load review data:', err);
            alert(`‚ùå Error loading review data: ${err.message}`);
        });
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Live Preview Functions
let livePreviewInterval = null;
let previewVisible = false;

function toggleLivePreview(reportId) {
    const container = document.getElementById('livePreviewContainer');
    const button = document.getElementById('togglePreviewBtn');
    
    if (!container || !button) return;
    
    previewVisible = !previewVisible;
    
    if (previewVisible) {
        container.style.display = 'block';
        button.innerHTML = 'üìÑ Hide Live Preview';
        button.style.background = 'var(--color-warning)';
        
        // Start auto-refresh
        updateLivePreview(reportId);
        livePreviewInterval = setInterval(() => updateLivePreview(reportId), 3000);
    } else {
        container.style.display = 'none';
        button.innerHTML = 'üìÑ Show Live Preview';
        button.style.background = 'var(--color-success)';
        
        // Stop auto-refresh
        if (livePreviewInterval) {
            clearInterval(livePreviewInterval);
            livePreviewInterval = null;
        }
    }
}

function updateLivePreview(reportId) {
    const contentDiv = document.getElementById('livePreviewContent');
    const indicator = document.getElementById('previewUpdateIndicator');
    
    if (!contentDiv) {
        // Modal was closed, stop interval
        if (livePreviewInterval) {
            clearInterval(livePreviewInterval);
            livePreviewInterval = null;
        }
        return;
    }
    
    // Flash update indicator
    if (indicator) {
        indicator.style.color = 'var(--color-success)';
        indicator.textContent = 'Updating...';
    }
    
    fetch(`/ai/report/${reportId}/live-preview`)
        .then(response => response.json())
        .then(data => {
            if (data.raw_response && data.raw_response.length > 0) {
                // Convert markdown to simple HTML (basic formatting)
                let html = data.raw_response
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/\n\n/g, '</p><p>')
                    .replace(/\n/g, '<br>')
                    .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
                    .replace(/^# (.+)$/gm, '<h1 style="font-size: 1.5rem; font-weight: 700; margin: 1rem 0 0.5rem 0; color: #1a1a1a;">$1</h1>')
                    .replace(/^## (.+)$/gm, '<h2 style="font-size: 1.25rem; font-weight: 700; margin: 1rem 0 0.5rem 0; color: #333;">$1</h2>')
                    .replace(/^### (.+)$/gm, '<h3 style="font-size: 1.1rem; font-weight: 600; margin: 0.75rem 0 0.5rem 0; color: #444;">$1</h3>');
                
                contentDiv.innerHTML = `<div style="line-height: 1.7;">${html}</div>`;
                
                // Scroll to bottom to show latest content
                contentDiv.scrollTop = contentDiv.scrollHeight;
            } else {
                contentDiv.innerHTML = '<p style="color: #999; text-align: center; padding: var(--spacing-lg);">Waiting for AI to start generating...</p>';
            }
            
            // Reset indicator
            if (indicator) {
                setTimeout(() => {
                    indicator.style.color = 'var(--color-text-muted)';
                    indicator.textContent = `Updates every 3 seconds ‚Ä¢ ${data.tokens || 0} tokens`;
                }, 500);
            }
            
            // Stop updating if report is complete
            if (data.status === 'completed' || data.status === 'failed' || data.status === 'cancelled') {
                if (livePreviewInterval) {
                    clearInterval(livePreviewInterval);
                    livePreviewInterval = null;
                }
                if (indicator) {
                    indicator.textContent = `Generation ${data.status} ‚Ä¢ ${data.tokens || 0} tokens`;
                }
            }
        })
        .catch(err => {
            console.error('Failed to update live preview:', err);
            if (indicator) {
                indicator.style.color = 'var(--color-error)';
                indicator.textContent = 'Update failed';
            }
        });
}

// Clean up interval when modal closes
document.addEventListener('DOMContentLoaded', () => {
    const observer = new MutationObserver((mutations) => {
        mutations.forEach((mutation) => {
            mutation.removedNodes.forEach((node) => {
                if (node.id === 'aiProgressModal' && livePreviewInterval) {
                    clearInterval(livePreviewInterval);
                    livePreviewInterval = null;
                    previewVisible = false;
                }
            });
        });
    });
    observer.observe(document.body, { childList: true });
});
</script>
{% endblock %}
