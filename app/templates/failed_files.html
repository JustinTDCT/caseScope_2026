{% extends "base.html" %}

{% block title %}Failed Files - {{ case.name }} - CaseScope 2026{% endblock %}

{% block content %}
<div class="content-header">
    <div>
        <h1 class="content-title">Failed Files: {{ case.name }}</h1>
        <p class="text-secondary">Files that failed during processing</p>
    </div>
    <div class="content-actions">
        <a href="{{ url_for('files.case_files', case_id=case.id) }}" class="btn btn-secondary">
            <span>‚Üê</span>
            <span>Back to Files</span>
        </a>
    </div>
</div>

<!-- Failed Files Stats -->
<div class="card" style="margin-bottom: var(--spacing-lg);">
    <div class="card-body">
        <div style="text-align: center;">
            <div style="font-size: 0.75rem; color: var(--color-text-secondary); margin-bottom: 0.5rem; text-transform: uppercase;">Total Failed Files</div>
            <div style="font-size: 2rem; font-weight: 700; color: var(--color-error);">{{ failed_count }}</div>
            <div style="font-size: 0.875rem; color: var(--color-text-muted); margin-top: 0.5rem;">These files encountered errors during processing</div>
        </div>
        
        <!-- Bulk Actions Bar -->
        <div id="selectedActionsBar" style="display: none; margin-top: var(--spacing-lg); padding-top: var(--spacing-lg); border-top: 1px solid var(--color-border);">
            <div style="margin-bottom: var(--spacing-sm); color: var(--color-text-secondary); font-size: 0.875rem; text-align: center;">
                <span id="selectedCount">0</span> file(s) selected
            </div>
            <div style="display: inline-flex; gap: var(--spacing-sm); flex-wrap: wrap; justify-content: center; width: 100%;">
                <button onclick="bulkRequeueSelected()" class="btn btn-sm" style="background: var(--color-success); color: white;">
                    <span>üîÑ</span>
                    <span>Requeue Selected</span>
                </button>
                <button onclick="deselectAll()" class="btn btn-sm btn-secondary">
                    <span>‚úï</span>
                    <span>Deselect All</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Failed Files List -->
<div class="card">
    <div class="card-header" style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: var(--spacing-md);">
        <div>
            <h2 class="card-title">‚ùå Failed Files</h2>
            <span class="text-muted">
                {% if search_term %}
                {{ pagination.total }} matching file(s) ‚Ä¢ Page {{ pagination.page }} of {{ pagination.pages }}
                {% else %}
                {{ pagination.total }} total file(s) ‚Ä¢ Page {{ pagination.page }} of {{ pagination.pages }}
                {% endif %}
            </span>
        </div>
        <div style="display: flex; gap: var(--spacing-sm); align-items: center; flex-wrap: wrap;">
            <!-- Search Form -->
            <form method="GET" action="{{ url_for('files.view_failed_files', case_id=case.id) }}" style="display: inline-flex; gap: var(--spacing-xs);">
                <input type="text" 
                       id="fileSearch" 
                       name="search"
                       value="{{ search_term }}"
                       placeholder="üîç Search failed files..." 
                       class="form-input" 
                       style="width: 250px;">
                <button type="submit" class="btn btn-primary" style="padding: 0.5rem 1rem;">
                    <span>üîé</span>
                </button>
                {% if search_term %}
                <a href="{{ url_for('files.view_failed_files', case_id=case.id) }}" class="btn btn-secondary" style="padding: 0.5rem 1rem;" title="Clear search">
                    <span>‚úï</span>
                </a>
                {% endif %}
            </form>
            
        </div>
    </div>
    <div class="card-body" style="padding: 0;">
        {% if files %}
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th style="width: 50px;"><input type="checkbox" id="selectAll" onchange="toggleSelectAll()"></th>
                        <th>File Name</th>
                        <th style="width: 100px;">Type</th>
                        <th style="width: 120px;">Size</th>
                        <th style="width: 150px;">Status</th>
                        <th style="width: 300px;">Failure Reason</th>
                        <th style="width: 150px;">Uploaded</th>
                        <th style="width: 120px;">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for file in files %}
                    <tr>
                        <td><input type="checkbox" class="file-checkbox" value="{{ file.id }}" onchange="updateSelectedCount()"></td>
                        <td>
                            <strong>{{ file.original_filename }}</strong>
                            <div class="text-muted" style="font-size: 0.75rem;">Hash: {{ file.file_hash[:16] }}...</div>
                        </td>
                        <td>
                            <span class="status-badge" style="background: rgba(150, 150, 150, 0.1); color: var(--color-text-secondary);">
                                {{ file.file_type }}
                            </span>
                        </td>
                        <td>{{ "%.2f"|format(file.file_size / 1024 / 1024) }} MB</td>
                        <td>
                            <span class="status-badge" style="background: rgba(239, 68, 68, 0.2); color: var(--color-error); font-weight: 500;">
                                {{ file.indexing_status }}
                            </span>
                        </td>
                        <td style="font-size: 0.85rem;">
                            {% if file.error_message %}
                            <div style="color: var(--color-text-secondary); line-height: 1.4; max-width: 300px; overflow-wrap: break-word;">
                                <span style="font-weight: 500; color: var(--color-error);">‚ö†Ô∏è</span> {{ file.error_message[:200] }}{% if file.error_message|length > 200 %}...{% endif %}
                            </div>
                            {% else %}
                            <span class="text-muted" style="font-style: italic;">No error details available</span>
                            {% endif %}
                        </td>
                        <td>
                            <span class="text-muted">{{ file.uploaded_at.strftime('%Y-%m-%d') }}</span>
                            <br><span class="text-muted" style="font-size: 0.75rem;">{{ file.uploaded_at.strftime('%H:%M') }}</span>
                        </td>
                        <td>
                            <form method="POST" action="{{ url_for('files.requeue_single_file', case_id=case.id, file_id=file.id) }}" style="display: inline;">
                                <button type="submit" class="btn btn-sm" style="font-size: 0.75rem; background: var(--color-success); color: white;">
                                    üîÑ Requeue
                                </button>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <!-- Pagination -->
        {% if pagination.pages > 1 %}
        <div class="pagination-container" style="display: flex; justify-content: space-between; align-items: center; padding: var(--spacing-lg); border-top: 1px solid var(--color-border);">
            <div class="pagination-info" style="color: var(--color-text-secondary); font-size: 0.875rem;">
                Showing {{ ((pagination.page - 1) * pagination.per_page) + 1 }} 
                to {% if pagination.page * pagination.per_page > pagination.total %}{{ pagination.total }}{% else %}{{ pagination.page * pagination.per_page }}{% endif %} 
                of {{ pagination.total }} files
            </div>
            
            <div class="pagination-controls" style="display: flex; gap: var(--spacing-xs);">
                {% if pagination.has_prev %}
                <a href="{{ url_for('files.view_failed_files', case_id=case.id, page=1, search=search_term) }}" class="btn btn-sm">¬´¬´</a>
                <a href="{{ url_for('files.view_failed_files', case_id=case.id, page=pagination.prev_num, search=search_term) }}" class="btn btn-sm">‚Äπ</a>
                {% endif %}
                
                <span class="btn btn-sm" style="background: var(--color-primary); color: white;">
                    Page {{ pagination.page }} of {{ pagination.pages }}
                </span>
                
                {% if pagination.has_next %}
                <a href="{{ url_for('files.view_failed_files', case_id=case.id, page=pagination.next_num, search=search_term) }}" class="btn btn-sm">‚Ä∫</a>
                <a href="{{ url_for('files.view_failed_files', case_id=case.id, page=pagination.pages, search=search_term) }}" class="btn btn-sm">¬ª¬ª</a>
                {% endif %}
            </div>
        </div>
        {% endif %}
        
        {% else %}
        <div style="text-align: center; padding: var(--spacing-2xl); color: var(--color-text-muted);">
            <div style="font-size: 3rem; margin-bottom: var(--spacing-md);">‚úÖ</div>
            <h3>No failed files</h3>
            <p>All files have been processed successfully</p>
        </div>
        {% endif %}
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
const CASE_ID = {{ case.id }};

function toggleSelectAll() {
    const selectAllCheckbox = document.getElementById('selectAll');
    const checkboxes = document.querySelectorAll('.file-checkbox');
    checkboxes.forEach(cb => {
        cb.checked = selectAllCheckbox.checked;
    });
    updateSelectedCount();
}

function updateSelectedCount() {
    const selectedCount = document.querySelectorAll('.file-checkbox:checked').length;
    document.getElementById('selectedCount').textContent = selectedCount;
    document.getElementById('selectedActionsBar').style.display = selectedCount > 0 ? 'block' : 'none';
}

function deselectAll() {
    document.getElementById('selectAll').checked = false;
    document.querySelectorAll('.file-checkbox').forEach(cb => cb.checked = false);
    updateSelectedCount();
}

function getSelectedFileIds() {
    return Array.from(document.querySelectorAll('.file-checkbox:checked')).map(cb => cb.value);
}

function bulkRequeueSelected() {
    const fileIds = getSelectedFileIds();
    if (fileIds.length === 0) {
        alert('No files selected');
        return;
    }
    
    if (confirm(`üîÑ Requeue ${fileIds.length} Selected File(s)\n\nThis will resubmit these files to the processing queue.\n\nContinue?`)) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/case/${CASE_ID}/bulk_requeue_selected`;
        fileIds.forEach(id => {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'file_ids';
            input.value = id;
            form.appendChild(input);
        });
        document.body.appendChild(form);
        form.submit();
    }
}
</script>
{% endblock %}

