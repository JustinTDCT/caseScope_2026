{% extends "base.html" %}

{% block title %}SIGMA Management - CaseScope 2026{% endblock %}

{% block content %}
<div class="content-header">
    <div>
        <h1 class="content-title">üõ°Ô∏è SIGMA Management</h1>
        <p class="text-secondary">Manage SIGMA detection rules and violations</p>
    </div>
    <div class="content-actions">
        <form method="POST" action="{{ url_for('update_sigma') }}" style="display: inline;">
            <button type="submit" class="btn" style="background: var(--color-success); color: white;">
                <span>üîÑ</span>
                <span>Update SIGMA Rules</span>
            </button>
        </form>
        <a href="{{ url_for('dashboard') }}" class="btn btn-secondary">
            <span>‚Üê</span>
            <span>Back to Dashboard</span>
        </a>
    </div>
</div>

<!-- SIGMA STATS ROW -->
<div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: var(--spacing-lg); margin-bottom: var(--spacing-lg);">
    
    <div class="card" style="margin-bottom: 0;">
        <div class="card-body">
            <div class="text-secondary" style="font-size: 0.875rem; margin-bottom: 2px;">Total Rules (All Sets)</div>
            <div style="font-size: 1.75rem; font-weight: 700; color: var(--color-primary);">{{ '{:,}'.format(sigma_info.total_rules) }}</div>
            {% if sigma_info.breakdown %}
            <div style="margin-top: var(--spacing-sm); padding-top: var(--spacing-sm); border-top: 1px solid var(--color-border); font-size: 0.75rem;">
                {% for name, count in sigma_info.breakdown.items() %}
                <div style="display: flex; justify-content: space-between; margin-bottom: 2px;">
                    <span class="text-secondary">{{ name }}:</span>
                    <span style="font-weight: 600;">{{ '{:,}'.format(count) }}</span>
                </div>
                {% endfor %}
            </div>
            {% endif %}
        </div>
    </div>
    
    <div class="card" style="margin-bottom: 0;">
        <div class="card-body">
            <div class="text-secondary" style="font-size: 0.875rem; margin-bottom: 2px;">Enabled Rules</div>
            <div style="font-size: 1.75rem; font-weight: 700; color: var(--color-success);">{{ '{:,}'.format(sigma_info.enabled_rules) }}</div>
            <div style="margin-top: var(--spacing-sm); font-size: 0.75rem; color: var(--color-text-secondary);">
                All rules active and scanning
            </div>
        </div>
    </div>
    
    <div class="card" style="margin-bottom: 0;">
        <div class="card-body">
            <div class="text-secondary" style="font-size: 0.875rem; margin-bottom: 2px;">Total Violations</div>
            <div style="font-size: 1.75rem; font-weight: 700; color: var(--color-warning);">{{ '{:,}'.format(sigma_info.total_violations) }}</div>
            <div style="margin-top: var(--spacing-sm); font-size: 0.75rem; color: var(--color-text-secondary);">
                Across all cases
            </div>
        </div>
    </div>
    
    <div class="card" style="margin-bottom: 0;">
        <div class="card-body">
            <div class="text-secondary" style="font-size: 0.875rem; margin-bottom: 2px;">Last Updated</div>
            <div style="font-size: 1.125rem; font-weight: 700; color: var(--color-text-primary);">
                {% if sigma_info.last_updated %}
                    {{ sigma_info.last_updated.strftime('%Y-%m-%d') }}
                {% else %}
                    Unknown
                {% endif %}
            </div>
            <div style="margin-top: var(--spacing-sm); font-size: 0.75rem; color: var(--color-text-secondary);">
                SigmaHQ repository
            </div>
        </div>
    </div>
</div>

<!-- SIGMA RULES TABLE -->
<div class="card">
    <div class="card-header" style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: var(--spacing-md);">
        <div style="display: flex; align-items: center; gap: var(--spacing-md);">
            <h2 class="card-title">SIGMA Rules</h2>
            <span class="text-secondary">{{ '{:,}'.format(total) }} rule(s) - Page {{ page }} of {{ total_pages }}</span>
        </div>
        
        <!-- Search Form -->
        <form method="GET" action="{{ url_for('sigma_management') }}" style="display: flex; gap: var(--spacing-sm); align-items: center;">
            <input type="text" 
                   name="search" 
                   value="{{ search_query }}" 
                   placeholder="üîç Search rules by name or path..."
                   style="min-width: 300px; padding: 8px 12px; border: 1px solid var(--color-border); border-radius: 4px; background: var(--color-bg-secondary);">
            <button type="submit" class="btn btn-sm btn-primary">Search</button>
            {% if search_query %}
            <a href="{{ url_for('sigma_management') }}" class="btn btn-sm btn-secondary">Clear</a>
            {% endif %}
        </form>
    </div>
    <div class="card-body">
        {% if rules %}
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th style="width: 28%;">Rule Title</th>
                        <th style="width: 8%;">Level</th>
                        <th style="width: 8%;">Status</th>
                        <th style="width: 12%;">Rule Set</th>
                        <th style="width: 30%;">Description</th>
                        <th style="width: 14%;">File Path</th>
                    </tr>
                </thead>
                <tbody>
                    {% for rule in rules %}
                    <tr>
                        <td><strong>{{ rule.title }}</strong></td>
                        <td>
                            {% if rule.level == 'critical' %}
                                <span class="status-badge status-ioc">CRITICAL</span>
                            {% elif rule.level == 'high' %}
                                <span class="status-badge status-sigma">HIGH</span>
                            {% elif rule.level == 'medium' %}
                                <span class="status-badge status-indexing">MEDIUM</span>
                            {% elif rule.level == 'low' %}
                                <span class="status-badge status-queued">LOW</span>
                            {% elif rule.level == 'informational' %}
                                <span class="status-badge status-completed">INFO</span>
                            {% else %}
                                <span class="text-muted">{{ rule.level|upper }}</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if rule.status == 'stable' %}
                                <span class="status-badge status-completed">STABLE</span>
                            {% elif rule.status == 'test' %}
                                <span class="status-badge status-indexing">TEST</span>
                            {% elif rule.status == 'experimental' %}
                                <span class="status-badge status-queued">EXPERIMENTAL</span>
                            {% elif rule.status == 'deprecated' %}
                                <span class="status-badge status-failed">DEPRECATED</span>
                            {% else %}
                                <span class="text-muted">{{ rule.status|upper }}</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if rule.rule_set == 'rules-dfir' %}
                                <span class="status-badge status-sigma" style="font-size: 0.75rem;">üîç DFIR</span>
                            {% elif rule.rule_set == 'rules-emerging-threats' %}
                                <span class="status-badge status-ioc" style="font-size: 0.75rem;">üö® Emerging</span>
                            {% elif rule.rule_set == 'rules-threat-hunting' %}
                                <span class="status-badge status-indexing" style="font-size: 0.75rem;">üéØ Hunting</span>
                            {% else %}
                                <span class="text-muted" style="font-size: 0.75rem;">üìã Windows</span>
                            {% endif %}
                        </td>
                        <td style="font-size: 0.875rem; color: var(--color-text-secondary);">
                            {{ rule.description[:120] }}{% if rule.description|length > 120 %}...{% endif %}
                        </td>
                        <td><span class="text-muted" style="font-size: 0.75rem; font-family: monospace;">{{ rule.filepath[:50] }}{% if rule.filepath|length > 50 %}...{% endif %}</span></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <!-- Pagination -->
        {% if total_pages > 1 %}
        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: var(--spacing-lg); padding-top: var(--spacing-lg); border-top: 1px solid var(--color-border);">
            <div class="text-secondary" style="font-size: 0.875rem;">
                Showing {{ ((page - 1) * per_page) + 1 }} to {{ [page * per_page, total]|min }} of {{ '{:,}'.format(total) }} rules
            </div>
            
            <div style="display: flex; gap: var(--spacing-sm); align-items: center;">
                <!-- First Page -->
                {% if page > 1 %}
                <a href="{{ url_for('sigma_management', page=1, per_page=per_page, search=search_query) }}" class="btn btn-sm btn-secondary">¬´ First</a>
                {% endif %}
                
                <!-- Previous Page -->
                {% if page > 1 %}
                <a href="{{ url_for('sigma_management', page=page-1, per_page=per_page, search=search_query) }}" class="btn btn-sm btn-secondary">‚Äπ Prev</a>
                {% endif %}
                
                <!-- Page Numbers -->
                {% set start_page = [1, page - 2]|max %}
                {% set end_page = [total_pages, page + 2]|min %}
                
                {% for p in range(start_page, end_page + 1) %}
                    {% if p == page %}
                    <span class="btn btn-sm btn-primary" style="pointer-events: none;">{{ p }}</span>
                    {% else %}
                    <a href="{{ url_for('sigma_management', page=p, per_page=per_page, search=search_query) }}" class="btn btn-sm btn-secondary">{{ p }}</a>
                    {% endif %}
                {% endfor %}
                
                <!-- Next Page -->
                {% if page < total_pages %}
                <a href="{{ url_for('sigma_management', page=page+1, per_page=per_page, search=search_query) }}" class="btn btn-sm btn-secondary">Next ‚Ä∫</a>
                {% endif %}
                
                <!-- Last Page -->
                {% if page < total_pages %}
                <a href="{{ url_for('sigma_management', page=total_pages, per_page=per_page, search=search_query) }}" class="btn btn-sm btn-secondary">Last ¬ª</a>
                {% endif %}
            </div>
            
            <!-- Per Page Selector -->
            <div style="display: flex; gap: var(--spacing-sm); align-items: center;">
                <span class="text-secondary" style="font-size: 0.875rem;">Rules per page:</span>
                <select onchange="window.location.href='{{ url_for('sigma_management', page=1, search=search_query) }}&per_page=' + this.value" 
                        style="padding: 4px 8px; border: 1px solid var(--color-border); border-radius: 4px; background: var(--color-bg-secondary);">
                    <option value="25" {% if per_page == 25 %}selected{% endif %}>25</option>
                    <option value="50" {% if per_page == 50 %}selected{% endif %}>50</option>
                    <option value="100" {% if per_page == 100 %}selected{% endif %}>100</option>
                    <option value="200" {% if per_page == 200 %}selected{% endif %}>200</option>
                </select>
            </div>
        </div>
        {% endif %}
        
        {% else %}
        <div style="text-align: center; padding: var(--spacing-2xl); color: var(--color-text-muted);">
            <div style="font-size: 3rem; margin-bottom: var(--spacing-md);">üõ°Ô∏è</div>
            {% if search_query %}
            <h3>No rules match your search</h3>
            <p>Try a different search term or <a href="{{ url_for('sigma_management') }}">view all rules</a></p>
            {% else %}
            <h3>No SIGMA rules found</h3>
            <p>Click "Update SIGMA Rules" to download the latest rules from SigmaHQ</p>
            {% endif %}
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}
