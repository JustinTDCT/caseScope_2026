{% extends "base.html" %}

{% block title %}Timeline - {{ case.name }} - CaseScope 2026{% endblock %}

{% block content %}
<div class="content-header">
    <div>
        <h1 class="content-title">ğŸ“… Case Timeline</h1>
        <p class="text-secondary">{{ case.name }} - Version {{ timeline.version }}</p>
    </div>
    <div class="content-actions">
        <button onclick="regenerateTimeline()" class="btn" style="background: #f59e0b; color: white;">
            <span>ğŸ”„</span>
            <span>Regenerate</span>
        </button>
        {% if timeline.status == 'failed' or (current_user.role == 'administrator' and timeline.status != 'generating') %}
        <button onclick="deleteTimeline()" class="btn" style="background: var(--color-error); color: white;">
            <span>ğŸ—‘ï¸</span>
            <span>Delete</span>
        </button>
        {% endif %}
        <a href="{{ url_for('view_case', case_id=case.id) }}" class="btn btn-secondary">
            <span>â†</span>
            <span>Back to Case</span>
        </a>
    </div>
</div>

<!-- Timeline Stats -->
<div class="stats-grid" style="grid-template-columns: repeat(auto-fit, minmin(200px, 1fr));">
    <div class="stat-card">
        <div class="stat-label">Status</div>
        <div class="stat-value" style="font-size: 1.2rem;">
            {% if timeline.status == 'completed' %}
            <span style="color: var(--color-success);">âœ… Completed</span>
            {% elif timeline.status == 'generating' %}
            <span style="color: var(--color-warning);">â³ Generating</span>
            {% elif timeline.status == 'failed' %}
            <span style="color: var(--color-error);">âŒ Failed</span>
            {% else %}
            <span>{{ timeline.status|title }}</span>
            {% endif %}
        </div>
    </div>
    
    <div class="stat-card">
        <div class="stat-label">Events Analyzed</div>
        <div class="stat-value">{{ '{:,}'.format(timeline.event_count or 0) }}</div>
    </div>
    
    <div class="stat-card">
        <div class="stat-label">IOCs Tracked</div>
        <div class="stat-value">{{ timeline.ioc_count or 0 }}</div>
    </div>
    
    <div class="stat-card">
        <div class="stat-label">Systems</div>
        <div class="stat-value">{{ timeline.system_count or 0 }}</div>
    </div>
    
    <div class="stat-card">
        <div class="stat-label">Generation Time</div>
        <div class="stat-value">
            {% if timeline.generation_time_seconds %}
            {{ (timeline.generation_time_seconds / 60)|round(1) }} min
            {% else %}
            N/A
            {% endif %}
        </div>
    </div>
    
    <div class="stat-card">
        <div class="stat-label">Model Used</div>
        <div class="stat-value" style="font-size: 0.9rem;">{{ timeline.model_name }}</div>
    </div>
</div>

<!-- Timeline Content -->
<div class="card">
    <div class="card-header">
        <h2 class="card-title">{{ timeline.timeline_title or 'Case Timeline' }}</h2>
        <p class="text-secondary" style="margin-top: var(--spacing-xs);">
            Generated {{ timeline.created_at.strftime('%Y-%m-%d %H:%M:%S UTC') }} by {{ timeline.user.username }}
        </p>
    </div>
    <div class="card-body">
        {% if timeline.status == 'completed' and timeline.timeline_content %}
        <div class="timeline-content" style="font-size: 1rem; line-height: 1.8; white-space: pre-wrap; word-wrap: break-word;">
            {{ timeline.timeline_content }}
        </div>
        {% elif timeline.status == 'generating' %}
        <div style="text-align: center; padding: var(--spacing-xl);">
            <div style="font-size: 3rem; margin-bottom: var(--spacing-md);">â³</div>
            <h3>Timeline Generation in Progress</h3>
            <p class="text-secondary">This may take 3-5 minutes...</p>
            <div style="margin-top: var(--spacing-lg);">
                <div class="progress-bar" style="width: 100%; max-width: 400px; margin: 0 auto; height: 20px; background: var(--color-bg-secondary); border-radius: 10px; overflow: hidden;">
                    <div id="progressBar" style="height: 100%; background: linear-gradient(90deg, #f59e0b, #10b981); width: {{ timeline.progress_percent or 0 }}%; transition: width 0.5s;"></div>
                </div>
                <p id="progressMessage" style="margin-top: var(--spacing-sm);">{{ timeline.progress_message or 'Initializing...' }}</p>
            </div>
        </div>
        {% elif timeline.status == 'failed' %}
        <div style="text-align: center; padding: var(--spacing-xl);">
            <div style="font-size: 3rem; margin-bottom: var(--spacing-md);">âŒ</div>
            <h3>Timeline Generation Failed</h3>
            <p class="text-secondary">{{ timeline.error_message or 'Unknown error occurred' }}</p>
            <button onclick="regenerateTimeline()" class="btn btn-primary" style="margin-top: var(--spacing-md);">
                ğŸ”„ Try Again
            </button>
        </div>
        {% else %}
        <div style="text-align: center; padding: var(--spacing-xl);">
            <p class="text-secondary">No timeline content available.</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- Version History -->
{% if all_timelines|length > 1 %}
<div class="card">
    <div class="card-header">
        <h2 class="card-title">Version History</h2>
    </div>
    <div class="card-body">
        <table class="table">
            <thead>
                <tr>
                    <th>Version</th>
                    <th>Status</th>
                    <th>Events</th>
                    <th>Generated</th>
                    <th>By</th>
                    <th>Time</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for t in all_timelines %}
                <tr {% if t.id == timeline.id %}style="background: rgba(139, 92, 246, 0.05);"{% endif %}>
                    <td>
                        <strong>v{{ t.version }}</strong>
                        {% if t.id == timeline.id %}
                        <span class="status-badge" style="background: rgba(139, 92, 246, 0.1); color: #8b5cf6; font-size: 0.75rem; margin-left: 0.5rem;">Current</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if t.status == 'completed' %}
                        <span class="status-badge" style="background: rgba(16, 185, 129, 0.1); color: #10b981;">âœ… Completed</span>
                        {% elif t.status == 'failed' %}
                        <span class="status-badge" style="background: rgba(239, 68, 68, 0.1); color: #ef4444;">âŒ Failed</span>
                        {% else %}
                        <span class="status-badge">{{ t.status|title }}</span>
                        {% endif %}
                    </td>
                    <td>{{ '{:,}'.format(t.event_count or 0) }}</td>
                    <td>{{ t.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                    <td>{{ t.user.username }}</td>
                    <td>
                        {% if t.generation_time_seconds %}
                        {{ (t.generation_time_seconds / 60)|round(1) }} min
                        {% else %}
                        N/A
                        {% endif %}
                    </td>
                    <td>
                        {% if t.id != timeline.id and t.status == 'completed' %}
                        <a href="{{ url_for('timeline.view_timeline', timeline_id=t.id) }}" class="btn btn-sm" style="background: var(--color-info); color: white; padding: 0.25rem 0.75rem;">View</a>
                        {% endif %}
                        {% if t.status == 'failed' or (current_user.role == 'administrator' and t.id != timeline.id and t.status != 'generating') %}
                        <button onclick="deleteTimelineVersion({{ t.id }})" class="btn btn-sm" style="background: var(--color-error); color: white; padding: 0.25rem 0.75rem;">ğŸ—‘ï¸ Delete</button>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endif %}

<style>
.timeline-content {
    max-width: none;
}

.timeline-content h2 {
    color: var(--color-primary);
    margin-top: var(--spacing-xl);
    margin-bottom: var(--spacing-md);
    padding-bottom: var(--spacing-sm);
    border-bottom: 2px solid var(--color-border);
}

.timeline-content h3 {
    color: var(--color-text);
    margin-top: var(--spacing-lg);
    margin-bottom: var(--spacing-sm);
}

.timeline-content table {
    width: 100%;
    border-collapse: collapse;
    margin: var(--spacing-md) 0;
}

.timeline-content table th,
.timeline-content table td {
    padding: var(--spacing-sm);
    border: 1px solid var(--color-border);
    text-align: left;
}

.timeline-content table th {
    background: var(--color-bg-secondary);
    font-weight: 600;
}

.timeline-content code {
    background: var(--color-bg-secondary);
    padding: 0.2rem 0.4rem;
    border-radius: 3px;
    font-family: 'Courier New', monospace;
    font-size: 0.9em;
}

.timeline-content pre {
    background: var(--color-bg-secondary);
    padding: var(--spacing-md);
    border-radius: var(--border-radius);
    overflow-x: auto;
    margin: var(--spacing-md) 0;
}

.timeline-content strong {
    color: var(--color-primary);
}

.timeline-content ul, .timeline-content ol {
    margin-left: var(--spacing-lg);
    margin-bottom: var(--spacing-md);
}

.timeline-content li {
    margin-bottom: var(--spacing-xs);
}
</style>

<script>
const TIMELINE_ID = {{ timeline.id }};
const CASE_ID = {{ case.id }};

function regenerateTimeline() {
    if (!confirm('Regenerate timeline?\n\nThis will create a new version (v{{ timeline.version + 1 }}) with updated data.\n\nEstimated time: 3-5 minutes.')) {
        return;
    }
    
    fetch(`/case/${CASE_ID}/generate_timeline`, {
        method: 'POST'
    })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showFlash('Timeline regeneration started! Redirecting...', 'success');
                setTimeout(() => {
                    window.location.href = `/timeline/${data.timeline_id}`;
                }, 1500);
            } else {
                showFlash(data.error || 'Failed to regenerate timeline', 'error');
            }
        })
        .catch(error => {
            showFlash('Failed to regenerate timeline: ' + error, 'error');
        });
}

function deleteTimeline() {
    if (!confirm('âš ï¸ Delete this timeline?\n\nThis action cannot be undone.')) {
        return;
    }
    
    fetch(`/timeline/${TIMELINE_ID}`, {
        method: 'DELETE',
        headers: {
            'Content-Type': 'application/json'
        }
    })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showFlash('Timeline deleted successfully', 'success');
                setTimeout(() => {
                    window.location.href = `/case/${CASE_ID}`;
                }, 1000);
            } else {
                showFlash(data.error || 'Failed to delete timeline', 'error');
            }
        })
        .catch(error => {
            showFlash('Failed to delete timeline: ' + error, 'error');
        });
}

function deleteTimelineVersion(timelineId) {
    if (!confirm('âš ï¸ Delete this timeline version?\n\nThis action cannot be undone.')) {
        return;
    }
    
    fetch(`/timeline/${timelineId}`, {
        method: 'DELETE',
        headers: {
            'Content-Type': 'application/json'
        }
    })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showFlash('Timeline deleted successfully', 'success');
                setTimeout(() => {
                    location.reload();
                }, 1000);
            } else {
                showFlash(data.error || 'Failed to delete timeline', 'error');
            }
        })
        .catch(error => {
            showFlash('Failed to delete timeline: ' + error, 'error');
        });
}

// Poll for progress if generating
{% if timeline.status == 'generating' %}
function checkProgress() {
    fetch(`/timeline/${TIMELINE_ID}/api`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const progressBar = document.getElementById('progressBar');
                const progressMessage = document.getElementById('progressMessage');
                
                if (progressBar) {
                    progressBar.style.width = (data.progress_percent || 0) + '%';
                }
                if (progressMessage) {
                    progressMessage.textContent = data.progress_message || 'Processing...';
                }
                
                if (data.status === 'completed') {
                    location.reload();
                } else if (data.status === 'failed') {
                    showFlash('Timeline generation failed', 'error');
                    setTimeout(() => location.reload(), 2000);
                } else {
                    // Still generating, check again
                    setTimeout(checkProgress, 3000);
                }
            }
        })
        .catch(error => console.error('Failed to check progress:', error));
}

// Start polling
setTimeout(checkProgress, 2000);
{% endif %}
</script>
{% endblock %}

