{% extends "base.html" %}

{% block title %}{{ case.name }} - CaseScope 2026{% endblock %}

{% block content %}
<div class="content-header">
    <div>
        <h1 class="content-title">{{ case.name }}</h1>
        <p class="text-secondary">{{ case.description or 'No description provided' }}</p>
    </div>
    <div class="content-actions">
        {% if current_user.role == 'administrator' or case.created_by == current_user.id %}
        <a href="{{ url_for('cases.edit_case', case_id=case.id) }}" class="btn" style="background: var(--color-info); color: white;">
            <span>‚úèÔ∏è</span>
            <span>Edit Case</span>
        </a>
        {% endif %}
        <button onclick="generateTimeline()" class="btn" style="background: #f59e0b; color: white;" id="timelineBtn">
            <span>üìÖ</span>
            <span>AI Case Timeline</span>
        </button>
        <a href="{{ url_for('upload_files', case_id=case.id) }}" class="btn btn-primary">
            <span>üì§</span>
            <span>Upload Files</span>
        </a>
        <a href="{{ url_for('dashboard') }}" class="btn btn-secondary">
            <span>‚Üê</span>
            <span>Back to Cases</span>
        </a>
    </div>
</div>

<!-- Case Info Stats -->
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-label">Total Files</div>
        <div class="stat-value">{{ files|length }}</div>
        <div class="stat-subtitle">Uploaded</div>
    </div>
    
    <div class="stat-card">
        <div class="stat-label">Storage</div>
        <div class="stat-value">
            {% set total_size = files|sum(attribute='file_size') or 0 %}
            {{ (total_size / 1024 / 1024)|round(2) }} MB
        </div>
        <div class="stat-subtitle">Used space</div>
    </div>
    
    <div class="stat-card">
        <div class="stat-label">Processing</div>
        <div class="stat-value" id="processingCount">
            {{ files|selectattr('indexing_status', 'in', ['Queued', 'Indexing', 'SIGMA Testing', 'IOC Hunting'])|list|length }}
        </div>
        <div class="stat-subtitle">In progress</div>
    </div>
    
    <div class="stat-card">
        <div class="stat-label">Completed</div>
        <div class="stat-value" id="completedCount">
            {{ files|selectattr('indexing_status', 'equalto', 'Completed')|list|length }}
        </div>
        <div class="stat-subtitle">Processed</div>
    </div>
</div>

<!-- Case Details Card -->
<div class="card">
    <div class="card-header">
        <h2 class="card-title">Case Information</h2>
    </div>
    <div class="card-body">
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: var(--spacing-lg);">
            <div>
                <div class="text-secondary" style="font-size: 0.875rem; margin-bottom: var(--spacing-xs);">Company</div>
                <div><strong>{{ case.company or 'N/A' }}</strong></div>
            </div>
            <div>
                <div class="text-secondary" style="font-size: 0.875rem; margin-bottom: var(--spacing-xs);">Created</div>
                <div><strong>{{ case.created_at.strftime('%Y-%m-%d %H:%M:%S') }}</strong></div>
            </div>
            <div>
                <div class="text-secondary" style="font-size: 0.875rem; margin-bottom: var(--spacing-xs);">Last Updated</div>
                <div><strong>{{ case.updated_at.strftime('%Y-%m-%d %H:%M:%S') if case.updated_at else 'N/A' }}</strong></div>
            </div>
            <div>
                <div class="text-secondary" style="font-size: 0.875rem; margin-bottom: var(--spacing-xs);">Status</div>
                <div>
                    {% if case.status == 'New' %}
                        <span class="status-badge" style="background: rgba(99, 102, 241, 0.1); color: #6366f1; font-weight: 600;">üÜï New</span>
                    {% elif case.status == 'Assigned' %}
                        <span class="status-badge" style="background: rgba(251, 191, 36, 0.1); color: #f59e0b; font-weight: 600;">üë§ Assigned</span>
                    {% elif case.status == 'In Progress' %}
                        <span class="status-badge" style="background: rgba(16, 185, 129, 0.1); color: #10b981; font-weight: 600;">‚öôÔ∏è In Progress</span>
                    {% elif case.status == 'Completed' %}
                        <span class="status-badge" style="background: rgba(139, 92, 246, 0.1); color: #8b5cf6; font-weight: 600;">‚úÖ Completed</span>
                    {% else %}
                        <span class="status-badge status-success">{{ case.status|title }}</span>
                    {% endif %}
                </div>
            </div>
            <div>
                <div class="text-secondary" style="font-size: 0.875rem; margin-bottom: var(--spacing-xs);">AI Timeline</div>
                <div id="timelineStatus">
                    <span class="status-badge" style="background: rgba(156, 163, 175, 0.1); color: #6b7280;">‚è≥ Checking...</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Files Table -->
<div class="card">
    <div class="card-header">
        <h2 class="card-title">Case Files</h2>
        <span class="text-secondary">{{ files|length }} file(s)</span>
    </div>
    <div class="card-body">
        {% if files %}
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Filename</th>
                        <th>Type</th>
                        <th>Size</th>
                        <th>Status</th>
                        <th>Events</th>
                        <th>SIGMA</th>
                        <th>IOCs</th>
                        <th>Uploaded</th>
                    </tr>
                </thead>
                <tbody>
                    {% for file in files %}
                    <tr data-file-id="{{ file.id }}">
                        <td>
                            <strong>{{ file.original_filename }}</strong>
                            {% if file.file_hash %}
                            <br><span class="text-muted" style="font-size: 0.75rem;">{{ file.file_hash[:16] }}...</span>
                            {% endif %}
                        </td>
                        <td>
                            <span class="status-badge" style="background: rgba(59, 130, 246, 0.1); color: var(--color-info);">
                                {{ file.file_type or 'UNKNOWN' }}
                            </span>
                        </td>
                        <td>{{ (file.file_size / 1024 / 1024)|round(2) }} MB</td>
                        <td class="status-cell">
                            {% if file.indexing_status == 'Completed' %}
                                <span class="status-badge status-completed">Completed</span>
                            {% elif file.indexing_status == 'Indexing' %}
                                <span class="status-badge status-indexing pulsing">Indexing</span>
                            {% elif file.indexing_status == 'SIGMA Testing' %}
                                <span class="status-badge status-sigma pulsing">SIGMA Testing</span>
                            {% elif file.indexing_status == 'IOC Hunting' %}
                                <span class="status-badge status-ioc pulsing">IOC Hunting</span>
                            {% elif file.indexing_status == 'Queued' %}
                                <span class="status-badge status-queued">Queued</span>
                            {% else %}
                                <span class="status-badge status-failed">{{ file.indexing_status }}</span>
                            {% endif %}
                        </td>
                        <td class="event-count">{{ '{:,}'.format(file.event_count or 0) }}</td>
                        <td class="sigma-count">
                            {% if file.violation_count > 0 %}
                                <span class="status-badge status-sigma">{{ file.violation_count }}</span>
                            {% else %}
                                <span class="text-muted">0</span>
                            {% endif %}
                        </td>
                        <td class="ioc-count">
                            {% if file.ioc_event_count > 0 %}
                                <span class="status-badge status-ioc">{{ file.ioc_event_count }}</span>
                            {% else %}
                                <span class="text-muted">0</span>
                            {% endif %}
                        </td>
                        <td>{{ file.uploaded_at.strftime('%Y-%m-%d %H:%M') }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div style="text-align: center; padding: var(--spacing-2xl); color: var(--color-text-muted);">
            <div style="font-size: 3rem; margin-bottom: var(--spacing-md);">üìÑ</div>
            <h3>No files uploaded yet</h3>
            <p>Upload EVTX, NDJSON, JSON, CSV, IIS logs, or ZIP files to start processing</p>
            <a href="{{ url_for('upload_files', case_id=case.id) }}" class="btn btn-primary" style="margin-top: var(--spacing-lg);">
                Upload Files
            </a>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Live status updates - refresh every 3 seconds
function updateStatuses() {
    fetch('/case/{{ case.id }}/status')
        .then(response => response.json())
        .then(data => {
            let processingCount = 0;
            let completedCount = 0;
            
            data.files.forEach(file => {
                const row = document.querySelector(`tr[data-file-id="${file.id}"]`);
                if (!row) return;
                
                // Update status
                const statusCell = row.querySelector('.status-cell');
                const currentStatus = statusCell.textContent.trim();
                
                if (currentStatus !== file.status) {
                    let statusClass = 'status-failed';
                    let pulsing = '';
                    
                    if (file.status === 'Completed') {
                        statusClass = 'status-completed';
                        completedCount++;
                    } else if (file.status === 'Indexing') {
                        statusClass = 'status-indexing';
                        pulsing = ' pulsing';
                        processingCount++;
                    } else if (file.status === 'SIGMA Testing') {
                        statusClass = 'status-sigma';
                        pulsing = ' pulsing';
                        processingCount++;
                    } else if (file.status === 'IOC Hunting') {
                        statusClass = 'status-ioc';
                        pulsing = ' pulsing';
                        processingCount++;
                    } else if (file.status === 'Queued') {
                        statusClass = 'status-queued';
                        processingCount++;
                    }
                    
                    statusCell.innerHTML = `<span class="status-badge ${statusClass}${pulsing}">${file.status}</span>`;
                }
                
                // Update counts
                row.querySelector('.event-count').textContent = file.event_count.toLocaleString();
                
                const sigmaCell = row.querySelector('.sigma-count');
                if (file.violation_count > 0) {
                    sigmaCell.innerHTML = `<span class="status-badge status-sigma">${file.violation_count}</span>`;
                } else {
                    sigmaCell.innerHTML = '<span class="text-muted">0</span>';
                }
                
                const iocCell = row.querySelector('.ioc-count');
                if (file.ioc_event_count > 0) {
                    iocCell.innerHTML = `<span class="status-badge status-ioc">${file.ioc_event_count}</span>`;
                } else {
                    iocCell.innerHTML = '<span class="text-muted">0</span>';
                }
            });
            
            // Update summary stats
            const processingEl = document.getElementById('processingCount');
            const completedEl = document.getElementById('completedCount');
            if (processingEl) processingEl.textContent = processingCount;
            if (completedEl) completedEl.textContent = completedCount;
        })
        .catch(err => console.error('Status update failed:', err));
}

// Update every 3 seconds
setInterval(updateStatuses, 3000);

// Initial update after 1 second
setTimeout(updateStatuses, 1000);

// ============================================================================
// AI TIMELINE FUNCTIONS
// ============================================================================

const CASE_ID = {{ case.id }};

// Check timeline status on page load
function checkTimelineStatus() {
    fetch(`/case/${CASE_ID}/timeline/status`)
        .then(response => response.json())
        .then(data => {
            const statusEl = document.getElementById('timelineStatus');
            const timelineBtn = document.getElementById('timelineBtn');
            
            if (data.exists) {
                const timeline = data;
                if (timeline.status === 'completed') {
                    statusEl.innerHTML = `
                        <a href="/timeline/${timeline.timeline_id}" style="text-decoration: none;">
                            <span class="status-badge" style="background: rgba(16, 185, 129, 0.1); color: #10b981; font-weight: 600; cursor: pointer;">
                                ‚úÖ Available (v${timeline.version})
                            </span>
                        </a>
                    `;
                    timelineBtn.innerHTML = '<span>üîÑ</span><span>Regenerate Timeline</span>';
                } else if (timeline.status === 'generating') {
                    statusEl.innerHTML = '<span class="status-badge" style="background: rgba(251, 191, 36, 0.1); color: #f59e0b;">‚è≥ Generating...</span>';
                    timelineBtn.disabled = true;
                    timelineBtn.innerHTML = '<span>‚è≥</span><span>Generating...</span>';
                    // Poll for updates
                    setTimeout(checkTimelineStatus, 3000);
                } else if (timeline.status === 'failed') {
                    statusEl.innerHTML = '<span class="status-badge" style="background: rgba(239, 68, 68, 0.1); color: #ef4444;">‚ùå Failed</span>';
                    timelineBtn.innerHTML = '<span>üîÑ</span><span>Retry Timeline</span>';
                } else {
                    statusEl.innerHTML = '<span class="status-badge" style="background: rgba(251, 191, 36, 0.1); color: #f59e0b;">‚è≥ Pending...</span>';
                    timelineBtn.disabled = true;
                }
            } else {
                statusEl.innerHTML = '<span class="status-badge" style="background: rgba(156, 163, 175, 0.1); color: #6b7280;">‚ö†Ô∏è No Timeline</span>';
                timelineBtn.innerHTML = '<span>üìÖ</span><span>AI Case Timeline</span>';
            }
        })
        .catch(error => {
            console.error('Failed to check timeline status:', error);
            document.getElementById('timelineStatus').innerHTML = '<span class="status-badge" style="background: rgba(156, 163, 175, 0.1); color: #6b7280;">‚ö†Ô∏è No Timeline</span>';
        });
}

// Generate timeline
function generateTimeline() {
    const button = document.getElementById('timelineBtn');
    button.disabled = true;
    button.innerHTML = '<span>‚è≥</span><span>Starting...</span>';
    
    fetch('/case/{{ case.id }}/generate_timeline', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Show progress modal
            showTimelineProgressModal(data.timeline_id, 4);
            // Start polling for progress
            pollTimelineProgress(data.timeline_id);
        } else {
            alert(`‚ùå Failed to Generate Timeline\n\n${data.error}`);
            button.disabled = false;
            button.innerHTML = '<span>üìÖ</span><span>AI Case Timeline</span>';
        }
    })
    .catch(err => {
        console.error('Timeline generation failed:', err);
        alert(`‚ùå Error: ${err.message}`);
        button.disabled = false;
        button.innerHTML = '<span>üìÖ</span><span>AI Case Timeline</span>';
    });
}

function showTimelineProgressModal(timelineId, estimatedMinutes = 4) {
    // Create modal overlay
    const modal = document.createElement('div');
    modal.id = 'timelineProgressModal';
    modal.style.cssText = `
        position: fixed !important;
        top: 0 !important;
        left: 0 !important;
        width: 100% !important;
        height: 100% !important;
        background-color: rgba(0, 0, 0, 0.85) !important;
        backdrop-filter: blur(4px) !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        z-index: 99999 !important;
    `;
    
    const estimateText = estimatedMinutes < 2 
        ? 'This will take ~2 minutes'
        : `This will take ~${Math.round(estimatedMinutes)} minutes`;
    
    modal.innerHTML = `
        <div style="background: var(--color-background); padding: var(--spacing-xl); border-radius: var(--border-radius); max-width: 600px; width: 90%; box-shadow: 0 8px 32px rgba(0,0,0,0.3);">
            <div style="display: flex; align-items: center; gap: var(--spacing-md); margin-bottom: var(--spacing-lg);">
                <span style="font-size: 2rem;">üìÖ</span>
                <div style="flex: 1;">
                    <h2 style="margin: 0; font-size: 1.25rem;">AI Timeline Generation</h2>
                    <p id="estimatedTimeText" style="margin: var(--spacing-xs) 0 0 0; color: var(--color-text-muted); font-size: 0.875rem;">${estimateText}</p>
                </div>
            </div>
            
            <!-- Current Stage Indicator -->
            <div style="background: #fef3c7; border: 1px solid #f59e0b; border-radius: var(--border-radius); padding: var(--spacing-sm) var(--spacing-md); margin-bottom: var(--spacing-md); display: flex; align-items: center; gap: var(--spacing-sm);">
                <span style="font-size: 1.5rem;">‚öôÔ∏è</span>
                <div>
                    <div style="font-size: 0.75rem; color: #78350f; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600;">Current Stage</div>
                    <div id="timelineCurrentStage" style="font-size: 0.95rem; font-weight: 600; color: #f59e0b; margin-top: 2px;">Initializing</div>
                </div>
            </div>
            
            <div style="margin-bottom: var(--spacing-md);">
                <div style="display: flex; justify-content: space-between; margin-bottom: var(--spacing-xs);">
                    <span id="timelineProgressMessage" style="font-size: 0.875rem; color: var(--color-text-muted);">Initializing timeline generation...</span>
                    <span id="timelineProgressPercent" style="font-size: 0.875rem; font-weight: 600; color: #f59e0b;">0%</span>
                </div>
                <div style="width: 100%; height: 24px; background: var(--color-background-secondary); border-radius: 12px; overflow: hidden; border: 1px solid var(--color-border);">
                    <div id="timelineProgressBar" style="height: 100%; background: linear-gradient(90deg, #f59e0b, #10b981); width: 0%; transition: width 0.3s ease;"></div>
                </div>
            </div>
            
            <div style="background: var(--color-background-secondary); padding: var(--spacing-md); border-radius: var(--border-radius); margin-bottom: var(--spacing-md);">
                <div style="display: flex; gap: var(--spacing-lg); font-size: 0.875rem;">
                    <div>
                        <span style="color: var(--color-text-muted);">‚è±Ô∏è Elapsed:</span>
                        <strong id="timelineElapsedTime" style="margin-left: var(--spacing-xs);">0s</strong>
                    </div>
                    <div>
                        <span style="color: var(--color-text-muted);">‚è≥ Remaining:</span>
                        <strong id="timelineRemainingTime" style="margin-left: var(--spacing-xs);">~4m</strong>
                    </div>
                </div>
            </div>
            
            <div id="timelineProgressLog" style="background: var(--color-background); border: 1px solid var(--color-border); border-radius: var(--border-radius); padding: var(--spacing-sm); max-height: 120px; overflow-y: auto; font-size: 0.8rem; font-family: monospace; color: var(--color-text-muted);"></div>
            
            <div style="display: flex; gap: var(--spacing-md); margin-top: var(--spacing-md); align-items: center;">
                <button id="cancelTimelineBtn" onclick="cancelTimeline(${timelineId})" style="background: var(--color-error); color: white; border: none; padding: var(--spacing-sm) var(--spacing-md); border-radius: var(--border-radius); cursor: pointer; font-weight: 600; transition: all 0.2s;">
                    ‚õî Cancel Generation
                </button>
                <p style="margin: 0; flex: 1; text-align: right; font-size: 0.875rem; color: var(--color-text-muted);">
                    üí° You can close this and the timeline will continue
                </p>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    // Allow clicking outside to close (but keep generating)
    modal.addEventListener('click', (e) => {
        if (e.target === modal) {
            modal.remove();
        }
    });
    
    // Start elapsed time counter
    window.timelineStartTime = Date.now();
    updateTimelineElapsedTime();
}

function updateTimelineProgressUI(data) {
    const progressBar = document.getElementById('timelineProgressBar');
    const progressPercent = document.getElementById('timelineProgressPercent');
    const progressMessage = document.getElementById('timelineProgressMessage');
    const currentStage = document.getElementById('timelineCurrentStage');
    const progressLog = document.getElementById('timelineProgressLog');
    
    if (!progressBar) return; // Modal closed
    
    // Update progress bar
    const percent = data.progress_percent || 0;
    progressBar.style.width = `${percent}%`;
    progressPercent.textContent = `${percent}%`;
    progressMessage.textContent = data.progress_message || 'Processing...';
    
    // Update current stage with icon
    if (currentStage && data.progress_message) {
        // Extract stage from progress message
        let stageName = 'Processing';
        let stageIcon = '‚öôÔ∏è';
        
        if (data.progress_message.includes('Initializing')) {
            stageName = 'Initializing';
            stageIcon = 'üîÑ';
        } else if (data.progress_message.includes('Collecting') || data.progress_message.includes('Fetching')) {
            stageName = 'Collecting Data';
            stageIcon = 'üìä';
        } else if (data.progress_message.includes('Analyzing') || data.progress_message.includes('Building')) {
            stageName = 'Analyzing Data';
            stageIcon = 'üîç';
        } else if (data.progress_message.includes('Generating') || data.progress_message.includes('Creating')) {
            stageName = 'Generating Timeline';
            stageIcon = '‚úçÔ∏è';
        } else if (data.progress_message.includes('Finalizing') || data.progress_message.includes('Saving')) {
            stageName = 'Finalizing';
            stageIcon = 'üìù';
        }
        
        if (data.status === 'completed') {
            stageName = 'Completed';
            stageIcon = '‚úÖ';
        } else if (data.status === 'cancelled') {
            stageName = 'Cancelled';
            stageIcon = '‚õî';
        } else if (data.status === 'failed') {
            stageName = 'Failed';
            stageIcon = '‚ùå';
        }
        
        currentStage.innerHTML = `${stageIcon} ${stageName}`;
    }
    
    // Add log entry
    if (data.progress_message) {
        const timestamp = new Date().toLocaleTimeString();
        const logEntry = document.createElement('div');
        logEntry.textContent = `[${timestamp}] ${data.progress_message}`;
        logEntry.style.marginBottom = '4px';
        if (progressLog.children.length > 20) {
            progressLog.removeChild(progressLog.firstChild);
        }
        progressLog.appendChild(logEntry);
        progressLog.scrollTop = progressLog.scrollHeight;
    }
    
    // Update estimated remaining time
    if (percent > 5 && percent < 95) {
        const elapsed = (Date.now() - window.timelineStartTime) / 1000;
        const estimatedTotal = (elapsed / percent) * 100;
        const remaining = estimatedTotal - elapsed;
        const remainingMins = Math.ceil(remaining / 60);
        const remainingText = remainingMins > 1 ? `~${remainingMins}m` : `~${Math.ceil(remaining)}s`;
        const remainingEl = document.getElementById('timelineRemainingTime');
        if (remainingEl) remainingEl.textContent = remainingText;
    }
}

function updateTimelineElapsedTime() {
    const elapsedEl = document.getElementById('timelineElapsedTime');
    if (!elapsedEl || !window.timelineStartTime) return;
    
    const elapsed = Math.floor((Date.now() - window.timelineStartTime) / 1000);
    const mins = Math.floor(elapsed / 60);
    const secs = elapsed % 60;
    elapsedEl.textContent = mins > 0 ? `${mins}m ${secs}s` : `${secs}s`;
    
    // Continue updating if modal is still open
    if (document.getElementById('timelineProgressModal')) {
        setTimeout(updateTimelineElapsedTime, 1000);
    }
}

function pollTimelineProgress(timelineId, attempts = 0) {
    const maxAttempts = 200; // 200 * 2s = ~6.5 minutes max
    
    if (attempts >= maxAttempts) {
        const modal = document.getElementById('timelineProgressModal');
        if (modal) modal.remove();
        checkTimelineStatus(); // Refresh button state
        return;
    }
    
    fetch(`/timeline/${timelineId}/api`)
        .then(response => response.json())
        .then(data => {
            if (!data.success) {
                throw new Error(data.error || 'Failed to get timeline status');
            }
            
            // Update UI
            updateTimelineProgressUI(data);
            
            // Check if completed
            if (data.status === 'completed') {
                setTimeout(() => {
                    const modal = document.getElementById('timelineProgressModal');
                    if (modal) modal.remove();
                    showFlash('‚úÖ Timeline generated successfully!', 'success');
                    checkTimelineStatus(); // Refresh button state
                    // Optionally redirect to timeline
                    if (confirm('Timeline completed! View timeline now?')) {
                        window.location.href = `/timeline/${timelineId}`;
                    }
                }, 2000);
                return;
            }
            
            // Check if failed
            if (data.status === 'failed') {
                const modal = document.getElementById('timelineProgressModal');
                if (modal) modal.remove();
                alert(`‚ùå Timeline generation failed:\n\n${data.error_message || 'Unknown error'}`);
                checkTimelineStatus(); // Refresh button state
                return;
            }
            
            // Check if cancelled
            if (data.status === 'cancelled') {
                const modal = document.getElementById('timelineProgressModal');
                if (modal) modal.remove();
                showFlash('Timeline generation cancelled', 'info');
                checkTimelineStatus(); // Refresh button state
                return;
            }
            
            // Continue polling if generating or pending
            if (data.status === 'generating' || data.status === 'pending') {
                setTimeout(() => pollTimelineProgress(timelineId, attempts + 1), 2000);
            }
        })
        .catch(error => {
            console.error('Failed to poll timeline status:', error);
            // Continue polling unless too many failures
            if (attempts < maxAttempts) {
                setTimeout(() => pollTimelineProgress(timelineId, attempts + 1), 3000);
            } else {
                const modal = document.getElementById('timelineProgressModal');
                if (modal) modal.remove();
                showFlash('Timeline generation status polling failed', 'error');
            }
        });
}

function cancelTimeline(timelineId) {
    if (!confirm('Are you sure you want to cancel timeline generation?')) {
        return;
    }
    
    fetch(`/timeline/${timelineId}/cancel`, {
        method: 'POST'
    })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const modal = document.getElementById('timelineProgressModal');
                if (modal) modal.remove();
                showFlash('Timeline generation cancelled', 'info');
                checkTimelineStatus();
            } else {
                alert(`Failed to cancel: ${data.error}`);
            }
        })
        .catch(error => {
            console.error('Failed to cancel timeline:', error);
            alert(`Error: ${error.message}`);
        });
}

// Check timeline status on page load
setTimeout(checkTimelineStatus, 500);
</script>
{% endblock %}

