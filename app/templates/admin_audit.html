{% extends "base.html" %}

{% block title %}Audit Trail - CaseScope{% endblock %}

{% block content %}
<div class="container">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-lg);">
        <h1 style="margin: 0;">üìã Audit Trail</h1>
        <div style="display: flex; gap: var(--spacing-sm); align-items: center;">
            <span style="color: var(--color-text-muted); font-size: 0.875rem;">Last {{ days_filter }} days</span>
        </div>
    </div>

    <!-- Statistics Tiles -->
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: var(--spacing-md); margin-bottom: var(--spacing-lg);">
        <div class="card">
            <div class="card-body" style="text-align: center;">
                <div style="font-size: 2rem; font-weight: bold; color: var(--color-primary);">{{ '{:,}'.format(total_logs) }}</div>
                <div style="color: var(--color-text-muted); font-size: 0.875rem;">Total Logs</div>
            </div>
        </div>
        
        <div class="card">
            <div class="card-body" style="text-align: center;">
                <div style="font-size: 2rem; font-weight: bold; color: var(--color-success);">{{ '{:,}'.format(logs_today) }}</div>
                <div style="color: var(--color-text-muted); font-size: 0.875rem;">Today</div>
            </div>
        </div>
        
        <div class="card">
            <div class="card-body" style="text-align: center;">
                <div style="font-size: 2rem; font-weight: bold; color: var(--color-error);">{{ '{:,}'.format(failed_logs) }}</div>
                <div style="color: var(--color-text-muted); font-size: 0.875rem;">Failed Actions</div>
            </div>
        </div>
    </div>

    <!-- Filters -->
    <div class="card" style="margin-bottom: var(--spacing-lg);">
        <div class="card-body">
            <form method="GET" id="filterForm">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: var(--spacing-md);">
                    <div>
                        <label style="font-size: 0.875rem; color: var(--color-text-muted);">Time Range</label>
                        <select name="days" class="form-control" onchange="this.form.submit()">
                            <option value="1" {% if days_filter == 1 %}selected{% endif %}>Last 24 hours</option>
                            <option value="7" {% if days_filter == 7 %}selected{% endif %}>Last 7 days</option>
                            <option value="30" {% if days_filter == 30 %}selected{% endif %}>Last 30 days</option>
                            <option value="90" {% if days_filter == 90 %}selected{% endif %}>Last 90 days</option>
                            <option value="0" {% if days_filter == 0 %}selected{% endif %}>All time</option>
                        </select>
                    </div>
                    
                    <div>
                        <label style="font-size: 0.875rem; color: var(--color-text-muted);">Action</label>
                        <select name="action" class="form-control" onchange="this.form.submit()">
                            <option value="">All Actions</option>
                            {% for action in actions %}
                            <option value="{{ action }}" {% if action_filter == action %}selected{% endif %}>{{ action }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div>
                        <label style="font-size: 0.875rem; color: var(--color-text-muted);">Resource Type</label>
                        <select name="resource" class="form-control" onchange="this.form.submit()">
                            <option value="">All Resources</option>
                            {% for resource in resources %}
                            <option value="{{ resource }}" {% if resource_filter == resource %}selected{% endif %}>{{ resource }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div>
                        <label style="font-size: 0.875rem; color: var(--color-text-muted);">User</label>
                        <select name="user" class="form-control" onchange="this.form.submit()">
                            <option value="">All Users</option>
                            {% for user in users %}
                            <option value="{{ user }}" {% if user_filter == user %}selected{% endif %}>{{ user }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div>
                        <label style="font-size: 0.875rem; color: var(--color-text-muted);">Status</label>
                        <select name="status" class="form-control" onchange="this.form.submit()">
                            <option value="">All Statuses</option>
                            <option value="success" {% if status_filter == 'success' %}selected{% endif %}>Success</option>
                            <option value="failed" {% if status_filter == 'failed' %}selected{% endif %}>Failed</option>
                            <option value="error" {% if status_filter == 'error' %}selected{% endif %}>Error</option>
                        </select>
                    </div>
                    
                    <div style="display: flex; align-items: flex-end;">
                        <button type="submit" class="btn btn-primary" style="width: 100%;">üîç Apply Filters</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Audit Logs Table -->
    <div class="card">
        <div class="card-body">
            <table class="table">
                <thead>
                    <tr>
                        <th>Timestamp</th>
                        <th>User</th>
                        <th>Action</th>
                        <th>Resource</th>
                        <th>Status</th>
                        <th>IP Address</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    {% for log in logs %}
                    <tr>
                        <td style="white-space: nowrap; color: var(--color-text-muted); font-size: 0.875rem;">
                            {{ log.created_at.strftime('%Y-%m-%d %H:%M:%S') }}
                        </td>
                        <td><strong>{{ log.username }}</strong></td>
                        <td>
                            <span class="status-badge status-sigma">{{ log.action }}</span>
                        </td>
                        <td>
                            {% if log.resource_type %}
                            <span style="font-size: 0.875rem;">
                                {{ log.resource_type }}
                                {% if log.resource_name %}
                                <br><span style="color: var(--color-text-muted);">{{ log.resource_name[:50] }}{% if log.resource_name|length > 50 %}...{% endif %}</span>
                                {% endif %}
                            </span>
                            {% else %}
                            <span style="color: var(--color-text-muted);">-</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if log.status == 'success' %}
                            <span class="status-badge status-completed">‚úÖ Success</span>
                            {% elif log.status == 'failed' %}
                            <span class="status-badge status-failed">‚ùå Failed</span>
                            {% else %}
                            <span class="status-badge status-queued">‚ö†Ô∏è {{ log.status }}</span>
                            {% endif %}
                        </td>
                        <td style="font-size: 0.875rem; color: var(--color-text-muted);">
                            {{ log.ip_address or '-' }}
                        </td>
                        <td>
                            <button onclick="viewDetails({{ log.id }})" class="btn btn-sm" title="View Details">
                                üîç
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            
            {% if not logs %}
            <p style="text-align: center; padding: var(--spacing-xl); color: var(--color-text-muted);">
                No audit logs found for the selected filters.
            </p>
            {% endif %}
        </div>
    </div>

    <!-- Pagination -->
    {% if pagination.pages > 1 %}
    <div style="display: flex; justify-content: center; align-items: center; gap: var(--spacing-sm); margin-top: var(--spacing-lg);">
        {% if pagination.has_prev %}
        <a href="{{ url_for('admin.audit_trail', page=pagination.prev_num, days=days_filter, action=action_filter, resource=resource_filter, user=user_filter, status=status_filter) }}" class="btn">
            ‚Üê Previous
        </a>
        {% endif %}
        
        <span style="color: var(--color-text-muted);">
            Page {{ pagination.page }} of {{ pagination.pages }}
        </span>
        
        {% if pagination.has_next %}
        <a href="{{ url_for('admin.audit_trail', page=pagination.next_num, days=days_filter, action=action_filter, resource=resource_filter, user=user_filter, status=status_filter) }}" class="btn">
            Next ‚Üí
        </a>
        {% endif %}
    </div>
    {% endif %}
</div>

<!-- Details Modal -->
<div id="detailsModal" class="modal-overlay" style="display: none;">
    <div class="modal-container" style="max-width: 800px;">
        <div class="modal-header">
            <h2 style="margin: 0;">üìã Audit Log Details</h2>
            <button onclick="closeDetailsModal()" class="modal-close">‚úï</button>
        </div>
        <div class="modal-body" id="detailsContent" style="max-height: 70vh; overflow-y: auto;">
            <div style="text-align: center; padding: var(--spacing-xl);">Loading...</div>
        </div>
    </div>
</div>

<script>
async function viewDetails(logId) {
    const modal = document.getElementById('detailsModal');
    const content = document.getElementById('detailsContent');
    
    modal.style.display = 'flex';
    content.innerHTML = '<div style="text-align: center; padding: var(--spacing-xl);"><div class="spinner"></div><p>Loading details...</p></div>';
    
    try {
        const response = await fetch(`/admin/audit/${logId}`);
        const data = await response.json();
        
        if (data.error) {
            content.innerHTML = `<p style="color: var(--color-error);">Error: ${data.error}</p>`;
            return;
        }
        
        let html = '<div style="display: grid; gap: var(--spacing-md);">';
        
        // User and action
        html += '<div class="card" style="margin: 0;"><div class="card-body">';
        html += '<h3 style="margin: 0 0 var(--spacing-sm) 0;">User & Action</h3>';
        html += '<div style="display: grid; gap: var(--spacing-xs);">';
        html += `<div><strong>Username:</strong> ${data.username}</div>`;
        html += `<div><strong>Action:</strong> ${data.action}</div>`;
        html += `<div><strong>Status:</strong> ${data.status}</div>`;
        html += `<div><strong>Timestamp:</strong> ${data.created_at}</div>`;
        html += '</div></div></div>';
        
        // Resource
        if (data.resource_type) {
            html += '<div class="card" style="margin: 0;"><div class="card-body">';
            html += '<h3 style="margin: 0 0 var(--spacing-sm) 0;">Resource</h3>';
            html += '<div style="display: grid; gap: var(--spacing-xs);">';
            html += `<div><strong>Type:</strong> ${data.resource_type}</div>`;
            if (data.resource_id) html += `<div><strong>ID:</strong> ${data.resource_id}</div>`;
            if (data.resource_name) html += `<div><strong>Name:</strong> ${data.resource_name}</div>`;
            html += '</div></div></div>';
        }
        
        // Request info
        html += '<div class="card" style="margin: 0;"><div class="card-body">';
        html += '<h3 style="margin: 0 0 var(--spacing-sm) 0;">Request Information</h3>';
        html += '<div style="display: grid; gap: var(--spacing-xs);">';
        html += `<div><strong>IP Address:</strong> ${data.ip_address || 'N/A'}</div>`;
        if (data.user_agent) {
            html += `<div><strong>User Agent:</strong> <span style="font-size: 0.875rem; word-break: break-all;">${data.user_agent}</span></div>`;
        }
        html += '</div></div></div>';
        
        // Details
        if (data.details) {
            html += '<div class="card" style="margin: 0;"><div class="card-body">';
            html += '<h3 style="margin: 0 0 var(--spacing-sm) 0;">Additional Details</h3>';
            html += `<pre style="background: var(--color-background-secondary); padding: var(--spacing-sm); border-radius: var(--border-radius); overflow-x: auto; font-size: 0.875rem;">${data.details}</pre>`;
            html += '</div></div>';
        }
        
        html += '</div>';
        content.innerHTML = html;
    } catch (error) {
        content.innerHTML = `<p style="color: var(--color-error);">Error loading details: ${error.message}</p>`;
    }
}

function closeDetailsModal() {
    document.getElementById('detailsModal').style.display = 'none';
}

// Close modal on background click
document.getElementById('detailsModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeDetailsModal();
    }
});
</script>
{% endblock %}

