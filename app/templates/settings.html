{% extends "base.html" %}

{% block title %}System Settings{% endblock %}

{% block content %}
<div class="content-header">
    <h1 class="content-title">‚öôÔ∏è System Settings</h1>
    <p style="color: var(--color-text-muted); margin: 0;">Configure system-wide settings and integrations</p>
</div>

<div style="max-width: 1200px; margin: 0 auto;">
    <form method="POST" action="{{ url_for('settings.save') }}">
        <!-- DFIR-IRIS Integration -->
        <div class="card" style="margin-bottom: var(--spacing-lg);">
            <div class="card-header">
                <h2 class="card-title">üîó DFIR-IRIS Integration</h2>
                <p style="color: var(--color-text-muted); margin: var(--spacing-sm) 0 0 0; font-size: 0.875rem;">
                    Sync cases, IOCs, and timeline events with DFIR-IRIS platform
                </p>
            </div>
            
            <div class="card-body">
                <!-- Enable DFIR-IRIS -->
                <div style="margin-bottom: var(--spacing-lg);">
                    <label style="display: flex; align-items: center; gap: var(--spacing-sm); cursor: pointer;">
                        <input type="checkbox" 
                               name="dfir_iris_enabled" 
                               {% if dfir_iris_enabled %}checked{% endif %}
                               style="width: 18px; height: 18px; cursor: pointer;">
                        <span style="font-weight: 500;">Enable DFIR-IRIS Integration</span>
                    </label>
                    <p style="color: var(--color-text-muted); margin: var(--spacing-xs) 0 0 26px; font-size: 0.875rem;">
                        Automatically sync case data, IOCs, and timeline events
                    </p>
                </div>

                <!-- DFIR-IRIS URL -->
                <div class="form-group">
                    <label for="dfir_iris_url">DFIR-IRIS URL</label>
                    <input type="url" 
                           id="dfir_iris_url"
                           name="dfir_iris_url" 
                           value="{{ dfir_iris_url }}"
                           placeholder="https://iris.example.com"
                           style="width: 100%; max-width: 600px;">
                    <p style="color: var(--color-text-muted); margin: var(--spacing-xs) 0 0 0; font-size: 0.875rem;">
                        Full URL to your DFIR-IRIS instance (e.g., https://iris.example.com)
                    </p>
                </div>

                <!-- API Key -->
                <div class="form-group">
                    <label for="dfir_iris_api_key">API Key</label>
                    <input type="password" 
                           id="dfir_iris_api_key"
                           name="dfir_iris_api_key" 
                           value="{{ dfir_iris_api_key }}"
                           placeholder="Enter DFIR-IRIS API key"
                           style="width: 100%; max-width: 600px; font-family: monospace;">
                    <p style="color: var(--color-text-muted); margin: var(--spacing-xs) 0 0 0; font-size: 0.875rem;">
                        API key from DFIR-IRIS (User Settings ‚Üí API Keys)
                    </p>
                </div>

                <!-- Action Buttons -->
                <div style="display: flex; gap: var(--spacing-md); margin-top: var(--spacing-md);">
                    <button type="button" 
                            onclick="testIrisConnection()"
                            class="btn"
                            style="padding: var(--spacing-sm) var(--spacing-lg); background: var(--color-info); color: white;">
                        üîå Test Connection
                    </button>
                    <button type="button" 
                            onclick="syncNow()"
                            class="btn"
                            style="padding: var(--spacing-sm) var(--spacing-lg); background: var(--color-success); color: white;">
                        üîÑ Sync Now
                    </button>
                </div>
                
                <!-- Test/Sync Result -->
                <div id="test-result" style="margin-top: var(--spacing-sm); display: none;"></div>

                <!-- Sync Behavior Info -->
                <div style="background: var(--color-background-secondary); padding: var(--spacing-md); border-radius: var(--border-radius); border-left: 3px solid var(--color-info);">
                    <h3 style="margin: 0 0 var(--spacing-sm) 0; font-size: 0.875rem; color: var(--color-info);">
                        üìã Sync Behavior
                    </h3>
                    <ul style="margin: 0; padding-left: var(--spacing-lg); color: var(--color-text-muted); font-size: 0.875rem; line-height: 1.6;">
                        <li>Company check: Creates if missing in DFIR-IRIS</li>
                        <li>Case sync: Creates if missing, matches open/closed status</li>
                        <li>IOC sync: Updates existing, creates new</li>
                        <li>Timeline events: Syncs tagged events, removes untagged
                            <ul style="margin-top: var(--spacing-xs);">
                                <li>Event timestamp = actual event time</li>
                                <li>Title = description + computer name</li>
                                <li>Source = "Pushed from CaseScope"</li>
                                <li>Raw data = full JSON/NDJSON</li>
                                <li>Manual edits in DFIR-IRIS preserved</li>
                            </ul>
                        </li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- OpenCTI Integration -->
        <div class="card" style="margin-bottom: var(--spacing-lg);">
            <div class="card-header">
                <h2 class="card-title">üß† OpenCTI Integration</h2>
                <p style="color: var(--color-text-muted); margin: var(--spacing-sm) 0 0 0; font-size: 0.875rem;">
                    Enrich IOCs with threat intelligence from OpenCTI
                </p>
            </div>
            
            <div class="card-body">
                <!-- Enable OpenCTI -->
                <div style="margin-bottom: var(--spacing-lg);">
                    <label style="display: flex; align-items: center; gap: var(--spacing-sm); cursor: pointer;">
                        <input type="checkbox" 
                               name="opencti_enabled" 
                               {% if opencti_enabled %}checked{% endif %}
                               style="width: 18px; height: 18px; cursor: pointer;">
                        <span style="font-weight: 500;">Enable OpenCTI Integration</span>
                    </label>
                    <p style="color: var(--color-text-muted); margin: var(--spacing-xs) 0 0 26px; font-size: 0.875rem;">
                        Automatically enrich IOCs with threat intelligence data
                    </p>
                </div>

                <!-- OpenCTI URL -->
                <div class="form-group">
                    <label for="opencti_url">OpenCTI URL</label>
                    <input type="url" 
                           id="opencti_url"
                           name="opencti_url" 
                           value="{{ opencti_url }}"
                           placeholder="https://opencti.example.com"
                           style="width: 100%; max-width: 600px;">
                    <p style="color: var(--color-text-muted); margin: var(--spacing-xs) 0 0 0; font-size: 0.875rem;">
                        Full URL to your OpenCTI instance (e.g., https://opencti.example.com)
                    </p>
                </div>

                <!-- API Key -->
                <div class="form-group">
                    <label for="opencti_api_key">API Key</label>
                    <input type="password" 
                           id="opencti_api_key"
                           name="opencti_api_key" 
                           value="{{ opencti_api_key }}"
                           placeholder="Enter OpenCTI API key"
                           style="width: 100%; max-width: 600px; font-family: monospace;">
                    <p style="color: var(--color-text-muted); margin: var(--spacing-xs) 0 0 0; font-size: 0.875rem;">
                        API key from OpenCTI (Profile ‚Üí API Tokens)
                    </p>
                </div>

                <!-- Action Buttons -->
                <div style="display: flex; gap: var(--spacing-md); margin-top: var(--spacing-md);">
                    <button type="button" 
                            onclick="testOpenCTIConnection()"
                            class="btn"
                            style="padding: var(--spacing-sm) var(--spacing-lg); background: var(--color-info); color: white;">
                        üîå Test Connection
                    </button>
                    <button type="button" 
                            onclick="syncOpenCTI()"
                            class="btn"
                            style="padding: var(--spacing-sm) var(--spacing-lg); background: var(--color-success); color: white;">
                        üîÑ Sync Now
                    </button>
                </div>
                
                <!-- Test/Sync Result -->
                <div id="opencti-result" style="margin-top: var(--spacing-sm); display: none;"></div>

                <!-- Sync Behavior Info -->
                <div style="background: var(--color-background-secondary); padding: var(--spacing-md); border-radius: var(--border-radius); border-left: 3px solid var(--color-info); margin-top: var(--spacing-md);">
                    <h3 style="margin: 0 0 var(--spacing-sm) 0; font-size: 0.875rem; color: var(--color-info);">
                        üìã Enrichment Behavior
                    </h3>
                    <ul style="margin: 0; padding-left: var(--spacing-lg); color: var(--color-text-muted); font-size: 0.875rem; line-height: 1.6;">
                        <li>Checks IOCs against OpenCTI threat intelligence database</li>
                        <li>Returns threat actor, campaign, and malware associations</li>
                        <li>Provides confidence score and TLP classification</li>
                        <li>Enrichment data stored with each IOC for reference</li>
                        <li>IOCs not found in OpenCTI are marked as "clean" (no match)</li>
                        <li>Re-enrichment updates existing data (useful for new intel)</li>
                        <li><strong>IOC Types Enriched:</strong> IP, Domain, Hostname, Username, Hash, Email, URL, Registry, Filename</li>
                        <li><strong>IOC Types Skipped:</strong> Command-line (environment-specific, no threat intel value)</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Logging Configuration -->
        <div class="card" style="margin-bottom: var(--spacing-lg);">
            <div class="card-header">
                <h2 class="card-title">üìã Logging</h2>
                <p style="color: var(--color-text-muted); margin: var(--spacing-sm) 0 0 0; font-size: 0.875rem;">
                    Configure application logging level and view log files
                </p>
            </div>
            
            <div class="card-body">
                <!-- Log Level Selection -->
                <div class="form-group">
                    <label for="log_level">Log Level</label>
                    <select id="log_level" 
                            name="log_level" 
                            style="width: 100%; max-width: 300px; padding: var(--spacing-sm); border: 1px solid var(--color-border); border-radius: var(--border-radius); background: var(--color-background); color: var(--color-text);">
                        <option value="DEBUG" {% if log_level == 'DEBUG' %}selected{% endif %}>DEBUG - Log everything (verbose)</option>
                        <option value="INFO" {% if log_level == 'INFO' %}selected{% endif %}>INFO - Normal operations (recommended)</option>
                        <option value="WARNING" {% if log_level == 'WARNING' %}selected{% endif %}>WARNING - Only warnings and errors</option>
                        <option value="ERROR" {% if log_level == 'ERROR' %}selected{% endif %}>ERROR - Only errors (minimal)</option>
                    </select>
                    <p style="color: var(--color-text-muted); margin: var(--spacing-xs) 0 0 0; font-size: 0.875rem;">
                        <strong>Current Level:</strong> {{ log_level or 'INFO' }} | 
                        <strong>Logs Location:</strong> <code style="background: var(--color-background-secondary); padding: 2px 6px; border-radius: 3px;">/opt/casescope/logs/</code>
                    </p>
                </div>

                <!-- Log Files Info -->
                <div style="background: var(--color-background-secondary); padding: var(--spacing-md); border-radius: var(--border-radius); border-left: 3px solid var(--color-info); margin-top: var(--spacing-md);">
                    <h3 style="margin: 0 0 var(--spacing-sm) 0; font-size: 0.875rem; color: var(--color-info);">
                        üìÅ Log Files
                    </h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-sm); margin: var(--spacing-sm) 0;">
                        <div style="font-family: monospace; font-size: 0.8rem; padding: var(--spacing-xs); background: var(--color-background); border-radius: var(--border-radius);">
                            <strong style="color: var(--color-primary);">cases.log</strong><br>
                            <span style="color: var(--color-text-muted);">Case operations</span>
                        </div>
                        <div style="font-family: monospace; font-size: 0.8rem; padding: var(--spacing-xs); background: var(--color-background); border-radius: var(--border-radius);">
                            <strong style="color: var(--color-primary);">files.log</strong><br>
                            <span style="color: var(--color-text-muted);">File processing</span>
                        </div>
                        <div style="font-family: monospace; font-size: 0.8rem; padding: var(--spacing-xs); background: var(--color-background); border-radius: var(--border-radius);">
                            <strong style="color: var(--color-primary);">workers.log</strong><br>
                            <span style="color: var(--color-text-muted);">Celery tasks</span>
                        </div>
                        <div style="font-family: monospace; font-size: 0.8rem; padding: var(--spacing-xs); background: var(--color-background); border-radius: var(--border-radius);">
                            <strong style="color: var(--color-primary);">app.log</strong><br>
                            <span style="color: var(--color-text-muted);">Web application</span>
                        </div>
                        <div style="font-family: monospace; font-size: 0.8rem; padding: var(--spacing-xs); background: var(--color-background); border-radius: var(--border-radius);">
                            <strong style="color: var(--color-primary);">api.log</strong><br>
                            <span style="color: var(--color-text-muted);">External API calls</span>
                        </div>
                        <div style="font-family: monospace; font-size: 0.8rem; padding: var(--spacing-xs); background: var(--color-background); border-radius: var(--border-radius);">
                            <strong style="color: var(--color-primary);">dfir_iris.log</strong><br>
                            <span style="color: var(--color-text-muted);">DFIR-IRIS integration</span>
                        </div>
                        <div style="font-family: monospace; font-size: 0.8rem; padding: var(--spacing-xs); background: var(--color-background); border-radius: var(--border-radius); grid-column: span 1;">
                            <strong style="color: var(--color-primary);">opencti.log</strong><br>
                            <span style="color: var(--color-text-muted);">OpenCTI integration</span>
                        </div>
                    </div>
                    <p style="margin: var(--spacing-sm) 0 0 0; color: var(--color-text-muted); font-size: 0.875rem;">
                        üí° <strong>Tip:</strong> Use <code style="background: var(--color-background); padding: 2px 6px; border-radius: 3px;">tail -f /opt/casescope/logs/[filename].log</code> to monitor logs in real-time
                    </p>
                </div>

                <!-- Log Level Details -->
                <div style="background: var(--color-background-secondary); padding: var(--spacing-md); border-radius: var(--border-radius); border-left: 3px solid var(--color-warning); margin-top: var(--spacing-md);">
                    <h3 style="margin: 0 0 var(--spacing-sm) 0; font-size: 0.875rem; color: var(--color-warning);">
                        ‚öôÔ∏è Log Level Details
                    </h3>
                    <ul style="margin: 0; padding-left: var(--spacing-lg); color: var(--color-text-muted); font-size: 0.875rem; line-height: 1.6;">
                        <li><strong>DEBUG:</strong> Maximum verbosity - Logs all operations, variables, SQL queries, API calls. Use for troubleshooting only (large log files).</li>
                        <li><strong>INFO:</strong> Normal operations - Logs important events like case creation, file uploads, user actions. Recommended for production.</li>
                        <li><strong>WARNING:</strong> Potential issues - Logs warnings and errors only. Use when disk space is limited.</li>
                        <li><strong>ERROR:</strong> Errors only - Logs only critical failures. Use for minimal logging in stable environments.</li>
                    </ul>
                    <p style="margin: var(--spacing-sm) 0 0 0; color: var(--color-text-muted); font-size: 0.875rem;">
                        ‚ö†Ô∏è <strong>Note:</strong> Changes take effect immediately. Restart services if logs are not updating.
                    </p>
                </div>
            </div>
        </div>

        <!-- AI Configuration -->
        <div class="card" style="margin-bottom: var(--spacing-lg);">
            <div class="card-header">
                <h2 class="card-title">ü§ñ AI Report Generation</h2>
                <p style="color: var(--color-text-muted); margin: var(--spacing-sm) 0 0 0; font-size: 0.875rem;">
                    Generate automated DFIR reports using local AI (DFIR-Optimized models via Ollama)
                </p>
            </div>
            
            <div class="card-body">
                <!-- AI System Status -->
                <div style="background: {% if ai_status.running and ai_status.model_available %}var(--color-success-bg){% elif ai_status.installed %}var(--color-warning-bg){% else %}var(--color-error-bg){% endif %}; padding: var(--spacing-md); border-radius: var(--border-radius); border-left: 3px solid {% if ai_status.running and ai_status.model_available %}var(--color-success){% elif ai_status.installed %}var(--color-warning){% else %}var(--color-error){% endif %}; margin-bottom: var(--spacing-md);">
                    <div style="display: flex; align-items: center; gap: var(--spacing-sm); margin-bottom: var(--spacing-xs);">
                        <span style="font-size: 1.2rem;">{% if ai_status.running and ai_status.model_available %}‚úÖ{% elif ai_status.installed %}‚ö†Ô∏è{% else %}‚ùå{% endif %}</span>
                        <strong style="color: {% if ai_status.running and ai_status.model_available %}var(--color-success){% elif ai_status.installed %}var(--color-warning){% else %}var(--color-error){% endif %};">
                            AI System Status
                        </strong>
                    </div>
                    <ul style="margin: var(--spacing-xs) 0 0 0; padding-left: var(--spacing-lg); color: var(--color-text-muted); font-size: 0.875rem; line-height: 1.6;">
                        <li><strong>Ollama:</strong> {% if ai_status.running %}‚úÖ Running{% elif ai_status.installed %}‚ö†Ô∏è Installed but not running{% else %}‚ùå Not installed{% endif %}</li>
                        {% if ai_status.models %}
                        <li><strong>Installed Models ({{ ai_status.models|length }}):</strong> {{ ai_status.models|join(', ') }}</li>
                        {% else %}
                        <li><strong>Models:</strong> ‚ùå No models installed</li>
                        {% endif %}
                    </ul>
                    {% if not ai_status.running or not ai_status.model_available %}
                    <p style="margin: var(--spacing-sm) 0 0 0; color: var(--color-text-muted); font-size: 0.875rem;">
                        ‚ö†Ô∏è <strong>To enable AI features:</strong> Install Ollama and pull a DFIR-optimized model
                        <br>
                        <code style="background: var(--color-background); padding: 2px 6px; border-radius: 3px;">curl -fsSL https://ollama.com/install.sh | sh && ollama pull llama3.1:8b-instruct-q4_K_M</code>
                    </p>
                    {% endif %}
                    
                    <!-- Update Models Button -->
                    {% if ai_status.running and ai_status.models %}
                    <div style="margin-top: var(--spacing-md); padding-top: var(--spacing-md); border-top: 1px solid var(--color-border);">
                        <button type="button" 
                                onclick="updateAllModels()" 
                                style="padding: var(--spacing-sm) var(--spacing-md); background: var(--color-primary); color: white; border: none; border-radius: var(--border-radius); cursor: pointer; font-size: 0.875rem; display: flex; align-items: center; gap: var(--spacing-xs);">
                            <span>üîÑ</span>
                            <span>Update All Installed Models</span>
                        </button>
                        <p style="color: var(--color-text-muted); margin: var(--spacing-xs) 0 0 0; font-size: 0.75rem;">
                            Check for and install updates for all {{ ai_status.models|length }} installed model(s)
                        </p>
                    </div>
                    {% endif %}
                </div>

                <!-- Enable AI -->
                <div style="margin-bottom: var(--spacing-lg);">
                    <label style="display: flex; align-items: center; gap: var(--spacing-sm); cursor: pointer;">
                        <input type="checkbox" 
                               name="ai_enabled" 
                               {% if ai_enabled %}checked{% endif %}
                               style="width: 18px; height: 18px; cursor: pointer;">
                        <span style="font-weight: 500;">Enable AI Report Generation</span>
                    </label>
                    <p style="color: var(--color-text-muted); margin: var(--spacing-xs) 0 0 26px; font-size: 0.875rem;">
                        Allow users to generate AI-powered DFIR reports from case data, IOCs, and tagged events
                    </p>
                </div>

                <!-- Hardware Detection Status -->
                <div style="margin-bottom: var(--spacing-md); padding: var(--spacing-sm); background: var(--color-background); border-radius: var(--border-radius); border: 1px solid var(--color-border);">
                    <div style="font-size: 0.875rem; color: var(--color-text-secondary);">
                        <strong>üíª Hardware Detected:</strong>
                        {% if hardware_info.gpu.gpu_detected %}
                        <span style="color: var(--color-success);">‚úì GPU: {{ hardware_info.gpu.gpu_name }} ({{ hardware_info.gpu.vram_gb }}GB VRAM)</span>
                        {% else %}
                        <span style="color: var(--color-text-muted);">CPU Only (No GPU detected)</span>
                        {% endif %}
                        | <strong>CPU:</strong> {{ hardware_info.cpu.cpu_count }} cores
                    </div>
                </div>

                <!-- Hardware Mode Selection (CPU vs GPU) -->
                <div style="margin-bottom: var(--spacing-lg); padding: var(--spacing-md); background: var(--color-background-secondary); border-radius: var(--border-radius); border-left: 3px solid var(--color-primary);">
                    <label style="font-weight: 600; margin-bottom: var(--spacing-sm); display: block; color: var(--color-text);">
                        ‚ö° Hardware Acceleration Mode
                    </label>
                    
                    <div style="display: flex; gap: var(--spacing-md); margin-bottom: var(--spacing-sm);">
                        <select name="ai_hardware_mode" 
                                id="ai_hardware_mode"
                                onchange="checkHardwareRequirements()"
                                style="flex: 1; max-width: 250px; padding: var(--spacing-sm); border: 1px solid var(--color-border); border-radius: var(--border-radius); background: var(--color-background); color: var(--color-text); font-size: 0.875rem;">
                            <option value="cpu" {% if ai_hardware_mode == 'cpu' %}selected{% endif %}>
                                üñ•Ô∏è CPU Mode (Default)
                            </option>
                            <option value="gpu" {% if ai_hardware_mode == 'gpu' %}selected{% endif %}>
                                üéÆ GPU Mode (Nvidia/AMD)
                            </option>
                        </select>
                        
                        <select name="ai_gpu_vram" 
                                id="ai_gpu_vram"
                                style="flex: 1; max-width: 150px; padding: var(--spacing-sm); border: 1px solid var(--color-border); border-radius: var(--border-radius); background: var(--color-background); color: var(--color-text); font-size: 0.875rem;">
                            <option value="4" {% if ai_gpu_vram == '4' %}selected{% endif %}>4GB VRAM</option>
                            <option value="6" {% if ai_gpu_vram == '6' %}selected{% endif %}>6GB VRAM</option>
                            <option value="8" {% if ai_gpu_vram == '8' or not ai_gpu_vram %}selected{% endif %}>8GB VRAM</option>
                            <option value="12" {% if ai_gpu_vram == '12' %}selected{% endif %}>12GB VRAM</option>
                            <option value="16" {% if ai_gpu_vram == '16' %}selected{% endif %}>16GB VRAM</option>
                            <option value="24" {% if ai_gpu_vram == '24' %}selected{% endif %}>24GB VRAM</option>
                            <option value="32" {% if ai_gpu_vram == '32' %}selected{% endif %}>32GB VRAM</option>
                            <option value="48" {% if ai_gpu_vram == '48' %}selected{% endif %}>48GB VRAM</option>
                        </select>
                    </div>
                    
                    <!-- GPU Setup Button (shown when requirements not met) -->
                    {% if ai_hardware_mode == 'gpu' and not hardware_info.gpu.gpu_detected %}
                    <div style="margin: var(--spacing-sm) 0; padding: var(--spacing-sm); background: var(--color-warning-bg); border-radius: var(--border-radius); border-left: 3px solid var(--color-warning);">
                        <p style="font-size: 0.875rem; color: var(--color-warning); margin: 0 0 var(--spacing-sm) 0;">
                            <strong>‚ö†Ô∏è GPU Not Detected:</strong> NVIDIA drivers or CUDA may not be installed.
                        </p>
                        <button type="button" onclick="setupGPU()" 
                                style="padding: var(--spacing-xs) var(--spacing-md); background: var(--color-warning); color: white; border: none; border-radius: var(--border-radius); cursor: pointer; font-size: 0.875rem; font-weight: 600;">
                            üîß Auto-Setup GPU Requirements
                        </button>
                    </div>
                    {% endif %}
                    
                    <div style="margin-top: var(--spacing-sm);">
                        <div style="padding: var(--spacing-sm); background: {% if ai_hardware_mode == 'gpu' %}var(--color-primary-bg){% else %}var(--color-background){% endif %}; border-radius: var(--border-radius); margin-bottom: var(--spacing-xs);">
                            <strong style="color: var(--color-primary); font-size: 0.875rem;">
                                {% if ai_hardware_mode == 'gpu' %}üéÆ GPU Mode Enabled{% else %}üñ•Ô∏è CPU Mode Enabled{% endif %}
                            </strong>
                            <p style="color: var(--color-text-muted); margin: var(--spacing-xs) 0 0 0; font-size: 0.8rem; line-height: 1.5;">
                                {% if ai_hardware_mode == 'gpu' %}
                                <strong>GPU Optimization:</strong> Higher context window (16K-32K), GPU layers enabled, max output 16K tokens. Best for systems with dedicated GPU (8+ GB VRAM).
                                <br><br>
                                <span style="color: var(--color-warning); font-weight: 500;">‚ö†Ô∏è Note:</span> AI models larger than available VRAM will automatically offload layers to CPU as needed. For optimal performance without CPU offloading, use models marked "‚úÖ 8GB VRAM OPTIMIZED" (Phi-3 Mini, Gemma 2 9B, Qwen 2.5 7B).
                                {% else %}
                                <strong>CPU Optimization:</strong> Balanced context window (8K), high thread count, max output 8K tokens. Optimized for CPU-only systems.
                                {% endif %}
                            </p>
                        </div>
                        
                        <p style="color: var(--color-text-muted); font-size: 0.75rem; line-height: 1.5; margin: 0;">
                            üí° <strong>Tip:</strong> The system automatically optimizes AI parameters based on your selection. Choose GPU mode only if you have a dedicated GPU with 8+ GB VRAM. CPU mode works great on most systems.
                        </p>
                    </div>
                </div>

                <!-- AI Model Selection -->
                <div class="form-group">
                    <label style="font-weight: 600; margin-bottom: var(--spacing-sm); display: block;">
                        AI Model Selection
                    </label>
                    
                    {% if all_models %}
                    <!-- Available Models -->
                    <div style="display: grid; gap: var(--spacing-md); margin-bottom: var(--spacing-md);">
                        {% for model in all_models %}
                        <label style="cursor: pointer;">
                            <input type="radio" 
                                   name="ai_model_name" 
                                   value="{{ model.name }}"
                                   {% if ai_model_name == model.name %}checked{% endif %}
                                   {% if not model.installed %}title="This model needs to be downloaded first"{% endif %}
                                   style="display: none;">
                            <div class="model-card" style="border: 2px solid {% if ai_model_name == model.name %}var(--color-primary){% elif not model.installed %}#666{% else %}var(--color-border){% endif %}; padding: var(--spacing-md); border-radius: var(--border-radius); background: {% if ai_model_name == model.name %}var(--color-primary-bg){% elif not model.installed %}#1a1a1a{% else %}var(--color-background){% endif %}; transition: all 0.2s ease; {% if not model.installed %}opacity: 0.7;{% endif %}">
                                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: var(--spacing-xs);">
                                    <div style="flex: 1;">
                                        <h4 style="margin: 0; font-size: 1rem; color: var(--color-text);">
                                            {% if model.recommended %}‚≠ê {% endif %}{{ model.display_name }}
                                            {% if ai_model_name == model.name %}
                                            <span style="background: var(--color-primary); color: white; padding: 2px 8px; border-radius: 3px; font-size: 0.75rem; margin-left: var(--spacing-xs);">SELECTED</span>
                                            {% endif %}
                                            {% if not model.installed %}
                                            <span style="background: #ff6b6b; color: white; padding: 2px 8px; border-radius: 3px; font-size: 0.75rem; margin-left: var(--spacing-xs);">NOT INSTALLED</span>
                                            {% else %}
                                            <span style="background: #51cf66; color: white; padding: 2px 8px; border-radius: 3px; font-size: 0.75rem; margin-left: var(--spacing-xs);">‚úì INSTALLED</span>
                                            {% endif %}
                                        </h4>
                                        <p style="margin: var(--spacing-xs) 0 0 0; color: var(--color-text-muted); font-size: 0.875rem;">
                                            {{ model.description }}
                                        </p>
                                        {% if not model.installed %}
                                        <p style="margin: var(--spacing-xs) 0 0 0; color: #ffa94d; font-size: 0.8rem; font-family: monospace;">
                                            üì• Download: <code style="background: #2a2a2a; padding: 2px 6px; border-radius: 3px;">ollama pull {{ model.name }}</code>
                                        </p>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: var(--spacing-sm); margin-top: var(--spacing-sm); font-size: 0.8rem;">
                                    <div>
                                        <span style="color: var(--color-text-muted);">Speed:</span>
                                        <strong style="color: {% if model.speed == 'Fast' or model.speed == 'Very Fast' %}var(--color-success){% elif model.speed == 'Moderate' %}var(--color-warning){% else %}var(--color-error){% endif %};">{{ model.speed }}</strong>
                                    </div>
                                    <div>
                                        <span style="color: var(--color-text-muted);">Quality:</span>
                                        <strong style="color: {% if model.quality == 'Excellent' or model.quality == 'Outstanding' or model.quality == 'Best Available' %}var(--color-success){% elif model.quality == 'Good' %}var(--color-info){% else %}var(--color-text-muted){% endif %};">{{ model.quality }}</strong>
                                    </div>
                                    <div>
                                        <span style="color: var(--color-text-muted);">Size:</span>
                                        <strong>{{ model.size }}</strong>
                                    </div>
                                    <div>
                                        <span style="color: var(--color-text-muted);">CPU Offload:</span>
                                        <strong style="color: {% if model.cpu_offload == 0 %}var(--color-success){% elif model.cpu_offload < 25 %}#82c91e{% elif model.cpu_offload < 50 %}var(--color-warning){% else %}var(--color-error){% endif %};">{{ model.cpu_offload }}%</strong>
                                    </div>
                                </div>
                                
                                <div style="margin-top: var(--spacing-sm); padding-top: var(--spacing-sm); border-top: 1px solid var(--color-border); font-size: 0.75rem; color: var(--color-text-muted);">
                                    <div>‚ö° Performance: {{ model.speed_estimate }}</div>
                                    <div style="margin-top: 2px;">‚è±Ô∏è Report Time: {{ model.time_estimate }}</div>
                                </div>
                            </div>
                        </label>
                        {% endfor %}
                    </div>
                    
                    <p style="color: var(--color-text-muted); margin: var(--spacing-sm) 0 0 0; font-size: 0.875rem;">
                        üí° <strong>Tip:</strong> q4_K_M models offer the best speed/quality balance for CPU. Higher quantization (q5_K_M, q8) improves quality but requires more time or GPU acceleration.
                    </p>
                    {% else %}
                    <!-- No models available - fallback to text input -->
                    <input type="text" 
                           id="ai_model_name"
                           name="ai_model_name" 
                           value="{{ ai_model_name }}"
                           placeholder="llama3.1:8b-instruct-q4_K_M"
                           style="width: 100%; max-width: 600px;">
                    <p style="color: var(--color-warning); margin: var(--spacing-xs) 0 0 0; font-size: 0.875rem;">
                        ‚ö†Ô∏è No models detected. Please download a model using: <code>ollama pull llama3.1:8b-instruct-q4_K_M</code>
                    </p>
                    {% endif %}
                </div>

                <!-- AI Performance Info -->
                <div style="background: var(--color-background-secondary); padding: var(--spacing-md); border-radius: var(--border-radius); border-left: 3px solid var(--color-info); margin-top: var(--spacing-md);">
                    <h3 style="margin: 0 0 var(--spacing-sm) 0; font-size: 0.875rem; color: var(--color-info);">
                        ‚ö° DFIR-Optimized AI Models
                    </h3>
                    <ul style="margin: 0; padding-left: var(--spacing-lg); color: var(--color-text-muted); font-size: 0.875rem; line-height: 1.6;">
                        <li><strong>Generation Time:</strong> 3-5 minutes average for 8GB models (GPU), 10-15 minutes (CPU)</li>
                        <li><strong>Processing:</strong> GPU-optimized (8GB VRAM) or CPU fallback mode</li>
                        <li><strong>Privacy:</strong> 100% local - no data sent to external services</li>
                        <li><strong>Cost:</strong> $0 - completely free and self-hosted</li>
                        <li><strong>Quality:</strong> Specialized DFIR models for timeline reconstruction, IOC analysis, and MITRE ATT&CK mapping</li>
                        <li><strong>Models:</strong> 4 DFIR-specialized models (Llama 3.1 8B, Mistral 7B, DeepSeek-Coder V2 16B Lite, Qwen 2.5 7B) ‚Äî ~24GB total disk space</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Save Button -->
        <div style="display: flex; gap: var(--spacing-md);">
            <button type="submit" class="btn btn-primary" style="padding: var(--spacing-sm) var(--spacing-xl);">
                üíæ Save Settings
            </button>
            <a href="{{ url_for('dashboard') }}" class="btn" style="padding: var(--spacing-sm) var(--spacing-lg);">
                Cancel
            </a>
        </div>
    </form>
</div>

<style>
.model-card:hover {
    border-color: var(--color-primary) !important;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    transform: translateY(-2px);
}

.model-card {
    transition: all 0.2s ease;
}

input[type="radio"]:checked + .model-card {
    border-color: var(--color-primary) !important;
    background: var(--color-primary-bg) !important;
    box-shadow: 0 0 0 3px rgba(var(--color-primary-rgb), 0.1);
}
</style>

<!-- GPU Setup Progress Modal -->
<div id="gpuSetupModal" class="modal-overlay" style="display: none;">
    <div class="modal-container" style="max-width: 600px;">
        <div class="modal-header">
            <h3>üîß GPU Requirements Setup</h3>
            <button type="button" class="modal-close" onclick="closeGPUSetupModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div id="gpuSetupProgress" style="font-family: monospace; font-size: 0.875rem; max-height: 400px; overflow-y: auto; background: var(--color-background); padding: var(--spacing-md); border-radius: var(--border-radius); white-space: pre-wrap;"></div>
        </div>
    </div>
</div>

<script>
function testIrisConnection() {
    const url = document.getElementById('dfir_iris_url').value.trim();
    const apiKey = document.getElementById('dfir_iris_api_key').value.trim();
    const resultDiv = document.getElementById('test-result');
    const button = event.target;
    
    if (!url || !apiKey) {
        resultDiv.style.display = 'block';
        resultDiv.style.padding = 'var(--spacing-sm)';
        resultDiv.style.borderRadius = 'var(--border-radius)';
        resultDiv.style.background = 'rgba(239, 68, 68, 0.1)';
        resultDiv.style.color = 'var(--color-error)';
        resultDiv.style.fontSize = '0.875rem';
        resultDiv.textContent = '‚ö†Ô∏è Please enter both URL and API key';
        return;
    }
    
    button.disabled = true;
    button.textContent = '‚è≥ Testing...';
    
    fetch('{{ url_for("settings.test_iris") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ url: url, api_key: apiKey })
    })
    .then(response => response.json())
    .then(data => {
        resultDiv.style.display = 'block';
        resultDiv.style.padding = 'var(--spacing-sm)';
        resultDiv.style.borderRadius = 'var(--border-radius)';
        resultDiv.style.fontSize = '0.875rem';
        
        if (data.success) {
            resultDiv.style.background = 'rgba(34, 197, 94, 0.1)';
            resultDiv.style.color = 'var(--color-success)';
        } else {
            resultDiv.style.background = 'rgba(239, 68, 68, 0.1)';
            resultDiv.style.color = 'var(--color-error)';
        }
        
        resultDiv.textContent = data.message;
    })
    .catch(error => {
        resultDiv.style.display = 'block';
        resultDiv.style.padding = 'var(--spacing-sm)';
        resultDiv.style.borderRadius = 'var(--border-radius)';
        resultDiv.style.background = 'rgba(239, 68, 68, 0.1)';
        resultDiv.style.color = 'var(--color-error)';
        resultDiv.style.fontSize = '0.875rem';
        resultDiv.textContent = '‚úó Connection test failed: ' + error.message;
    })
    .finally(() => {
        button.disabled = false;
        button.textContent = 'üîå Test Connection';
    });
}

function syncNow() {
    const resultDiv = document.getElementById('test-result');
    const button = event.target;
    
    if (!confirm('This will sync all active cases, IOCs, and tagged timeline events to DFIR-IRIS. Continue?')) {
        return;
    }
    
    button.disabled = true;
    button.textContent = '‚è≥ Syncing...';
    
    resultDiv.style.display = 'block';
    resultDiv.style.padding = 'var(--spacing-sm)';
    resultDiv.style.borderRadius = 'var(--border-radius)';
    resultDiv.style.fontSize = '0.875rem';
    resultDiv.style.background = 'rgba(59, 130, 246, 0.1)';
    resultDiv.style.color = 'var(--color-info)';
    resultDiv.textContent = '‚è≥ Starting sync process...';
    
    fetch('{{ url_for("settings.sync_now") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        resultDiv.style.display = 'block';
        resultDiv.style.padding = 'var(--spacing-sm)';
        resultDiv.style.borderRadius = 'var(--border-radius)';
        resultDiv.style.fontSize = '0.875rem';
        
        if (data.success) {
            resultDiv.style.background = 'rgba(34, 197, 94, 0.1)';
            resultDiv.style.color = 'var(--color-success)';
        } else {
            resultDiv.style.background = 'rgba(239, 68, 68, 0.1)';
            resultDiv.style.color = 'var(--color-error)';
        }
        
        resultDiv.textContent = data.message;
    })
    .catch(error => {
        resultDiv.style.display = 'block';
        resultDiv.style.padding = 'var(--spacing-sm)';
        resultDiv.style.borderRadius = 'var(--border-radius)';
        resultDiv.style.background = 'rgba(239, 68, 68, 0.1)';
        resultDiv.style.color = 'var(--color-error)';
        resultDiv.style.fontSize = '0.875rem';
        resultDiv.textContent = '‚úó Sync failed: ' + error.message;
    })
    .finally(() => {
        button.disabled = false;
        button.textContent = 'üîÑ Sync Now';
    });
}

function testOpenCTIConnection() {
    const url = document.getElementById('opencti_url').value.trim();
    const apiKey = document.getElementById('opencti_api_key').value.trim();
    const resultDiv = document.getElementById('opencti-result');
    const button = event.target;
    
    if (!url || !apiKey) {
        resultDiv.style.display = 'block';
        resultDiv.style.padding = 'var(--spacing-sm)';
        resultDiv.style.borderRadius = 'var(--border-radius)';
        resultDiv.style.background = 'rgba(239, 68, 68, 0.1)';
        resultDiv.style.color = 'var(--color-error)';
        resultDiv.style.fontSize = '0.875rem';
        resultDiv.textContent = '‚ö†Ô∏è Please enter both URL and API key';
        return;
    }
    
    button.disabled = true;
    button.textContent = '‚è≥ Testing...';
    
    fetch('{{ url_for("settings.test_opencti") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ url: url, api_key: apiKey })
    })
    .then(response => response.json())
    .then(data => {
        resultDiv.style.display = 'block';
        resultDiv.style.padding = 'var(--spacing-sm)';
        resultDiv.style.borderRadius = 'var(--border-radius)';
        resultDiv.style.fontSize = '0.875rem';
        
        if (data.success) {
            resultDiv.style.background = 'rgba(34, 197, 94, 0.1)';
            resultDiv.style.color = 'var(--color-success)';
        } else {
            resultDiv.style.background = 'rgba(239, 68, 68, 0.1)';
            resultDiv.style.color = 'var(--color-error)';
        }
        
        resultDiv.textContent = data.message;
    })
    .catch(error => {
        resultDiv.style.display = 'block';
        resultDiv.style.padding = 'var(--spacing-sm)';
        resultDiv.style.borderRadius = 'var(--border-radius)';
        resultDiv.style.background = 'rgba(239, 68, 68, 0.1)';
        resultDiv.style.color = 'var(--color-error)';
        resultDiv.style.fontSize = '0.875rem';
        resultDiv.textContent = '‚úó Connection test failed: ' + error.message;
    })
    .finally(() => {
        button.disabled = false;
        button.textContent = 'üîå Test Connection';
    });
}

function syncOpenCTI() {
    const resultDiv = document.getElementById('opencti-result');
    const button = event.target;
    
    if (!confirm('This will enrich all IOCs in all active cases with OpenCTI threat intelligence. Continue?')) {
        return;
    }
    
    button.disabled = true;
    button.textContent = '‚è≥ Enriching...';
    
    resultDiv.style.display = 'block';
    resultDiv.style.padding = 'var(--spacing-sm)';
    resultDiv.style.borderRadius = 'var(--border-radius)';
    resultDiv.style.fontSize = '0.875rem';
    resultDiv.style.background = 'rgba(59, 130, 246, 0.1)';
    resultDiv.style.color = 'var(--color-info)';
    resultDiv.textContent = '‚è≥ Starting enrichment process...';
    
    fetch('{{ url_for("settings.sync_opencti") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        resultDiv.style.display = 'block';
        resultDiv.style.padding = 'var(--spacing-sm)';
        resultDiv.style.borderRadius = 'var(--border-radius)';
        resultDiv.style.fontSize = '0.875rem';
        
        if (data.success) {
            resultDiv.style.background = 'rgba(34, 197, 94, 0.1)';
            resultDiv.style.color = 'var(--color-success)';
        } else {
            resultDiv.style.background = 'rgba(239, 68, 68, 0.1)';
            resultDiv.style.color = 'var(--color-error)';
        }
        
        resultDiv.textContent = data.message;
    })
    .catch(error => {
        resultDiv.style.display = 'block';
        resultDiv.style.padding = 'var(--spacing-sm)';
        resultDiv.style.borderRadius = 'var(--border-radius)';
        resultDiv.style.background = 'rgba(239, 68, 68, 0.1)';
        resultDiv.style.color = 'var(--color-error)';
        resultDiv.style.fontSize = '0.875rem';
        resultDiv.textContent = '‚úó Enrichment failed: ' + error.message;
    })
    .finally(() => {
        button.disabled = false;
        button.textContent = 'üîÑ Sync Now';
    });
}

// ============================================================================
// AI Model Update Functions
// ============================================================================

function updateAllModels() {
    // Create modal
    const modal = document.createElement('div');
    modal.id = 'updateModelsModal';
    modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        backdrop-filter: blur(5px);
    `;
    
    modal.innerHTML = `
        <div style="background: var(--color-background); padding: var(--spacing-lg); border-radius: var(--border-radius); max-width: 700px; width: 90%; max-height: 80vh; overflow-y: auto; box-shadow: 0 10px 40px rgba(0,0,0,0.3);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-md); padding-bottom: var(--spacing-md); border-bottom: 2px solid var(--color-border);">
                <h3 style="margin: 0; color: var(--color-text); display: flex; align-items: center; gap: var(--spacing-sm);">
                    <span style="font-size: 1.5rem;">üîÑ</span>
                    <span>Updating AI Models</span>
                </h3>
                <button id="closeUpdateModal" onclick="closeUpdateModelsModal()" style="background: none; border: none; color: var(--color-text-muted); font-size: 1.5rem; cursor: pointer; padding: 0; width: 32px; height: 32px; display: none;">
                    ‚úï
                </button>
            </div>
            
            <div id="updateProgress" style="min-height: 200px;">
                <div style="text-align: center; padding: var(--spacing-xl);">
                    <div style="font-size: 2rem; margin-bottom: var(--spacing-sm);">‚è≥</div>
                    <p style="color: var(--color-text-muted);">Checking for model updates...</p>
                </div>
            </div>
            
            <div id="updateActions" style="margin-top: var(--spacing-md); padding-top: var(--spacing-md); border-top: 1px solid var(--color-border); text-align: center; display: none;">
                <button onclick="closeUpdateModelsModal()" style="padding: var(--spacing-sm) var(--spacing-lg); background: var(--color-primary); color: white; border: none; border-radius: var(--border-radius); cursor: pointer;">
                    Close
                </button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    // Start update process with EventSource (Server-Sent Events)
    const eventSource = new EventSource('{{ url_for("settings.update_models") }}');
    
    let currentModel = '';
    let totalModels = 0;
    let completedModels = 0;
    const modelStatuses = {};
    
    eventSource.onmessage = function(event) {
        try {
            const data = JSON.parse(event.data);
            
            // Handle errors
            if (data.error) {
                document.getElementById('updateProgress').innerHTML = `
                    <div style="text-align: center; padding: var(--spacing-xl);">
                        <div style="font-size: 2rem; margin-bottom: var(--spacing-sm);">‚ùå</div>
                        <p style="color: var(--color-error); font-weight: 600;">Error</p>
                        <p style="color: var(--color-text-muted); font-size: 0.875rem;">${escapeHtml(data.error)}</p>
                    </div>
                `;
                document.getElementById('closeUpdateModal').style.display = 'block';
                document.getElementById('updateActions').style.display = 'block';
                eventSource.close();
                return;
            }
            
            // Initial data with total count
            if (data.total && data.models) {
                totalModels = data.total;
                data.models.forEach(model => {
                    modelStatuses[model] = { status: 'pending', progress: 0 };
                });
                renderModelList();
            }
            
            // Update individual model status
            if (data.model) {
                currentModel = data.model;
                
                if (data.stage === 'starting') {
                    modelStatuses[currentModel] = { status: 'updating', progress: 0, message: 'Starting update...' };
                } else if (data.stage === 'downloading') {
                    modelStatuses[currentModel] = { status: 'updating', progress: data.progress || 0, message: data.status };
                } else if (data.stage === 'completed') {
                    modelStatuses[currentModel] = { status: 'completed', progress: 100, message: '‚úÖ Up to date' };
                    completedModels++;
                } else if (data.stage === 'error') {
                    modelStatuses[currentModel] = { status: 'error', progress: 0, message: '‚ùå Error: ' + (data.error || 'Unknown') };
                    completedModels++;
                }
                
                renderModelList();
            }
            
            // All complete
            if (data.stage === 'all_complete') {
                document.getElementById('closeUpdateModal').style.display = 'block';
                document.getElementById('updateActions').style.display = 'block';
                eventSource.close();
            }
            
        } catch (e) {
            console.error('Failed to parse update event:', e, event.data);
        }
    };
    
    eventSource.onerror = function() {
        console.error('EventSource error');
        document.getElementById('updateProgress').innerHTML = `
            <div style="text-align: center; padding: var(--spacing-xl);">
                <div style="font-size: 2rem; margin-bottom: var(--spacing-sm);">‚ùå</div>
                <p style="color: var(--color-error); font-weight: 600;">Connection Error</p>
                <p style="color: var(--color-text-muted); font-size: 0.875rem;">Lost connection to server</p>
            </div>
        `;
        document.getElementById('closeUpdateModal').style.display = 'block';
        document.getElementById('updateActions').style.display = 'block';
        eventSource.close();
    };
    
    function renderModelList() {
        const models = Object.keys(modelStatuses);
        let html = `
            <div style="margin-bottom: var(--spacing-md);">
                <div style="background: var(--color-background-secondary); padding: var(--spacing-sm); border-radius: var(--border-radius); display: flex; justify-content: space-between; align-items: center;">
                    <span style="color: var(--color-text-muted); font-size: 0.875rem;">Progress</span>
                    <span style="color: var(--color-primary); font-weight: 600;">${completedModels} / ${totalModels}</span>
                </div>
            </div>
        `;
        
        models.forEach(model => {
            const status = modelStatuses[model];
            const statusColor = status.status === 'completed' ? 'var(--color-success)' : 
                              status.status === 'error' ? 'var(--color-error)' : 
                              status.status === 'updating' ? 'var(--color-primary)' : 
                              'var(--color-text-muted)';
            
            const statusIcon = status.status === 'completed' ? '‚úÖ' : 
                             status.status === 'error' ? '‚ùå' : 
                             status.status === 'updating' ? 'üîÑ' : 
                             '‚è≥';
            
            html += `
                <div style="margin-bottom: var(--spacing-md); padding: var(--spacing-md); background: var(--color-background-secondary); border-radius: var(--border-radius); border-left: 3px solid ${statusColor};">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-xs);">
                        <div style="display: flex; align-items: center; gap: var(--spacing-sm);">
                            <span style="font-size: 1.2rem;">${statusIcon}</span>
                            <span style="color: var(--color-text); font-weight: 600; font-family: monospace; font-size: 0.875rem;">${escapeHtml(model)}</span>
                        </div>
                        ${status.progress > 0 ? `<span style="color: ${statusColor}; font-size: 0.875rem; font-weight: 600;">${status.progress}%</span>` : ''}
                    </div>
                    ${status.message ? `<p style="color: var(--color-text-muted); font-size: 0.75rem; margin: 0;">${escapeHtml(status.message)}</p>` : ''}
                    ${status.status === 'updating' && status.progress > 0 ? `
                        <div style="margin-top: var(--spacing-xs); background: var(--color-background); border-radius: 10px; height: 6px; overflow: hidden;">
                            <div style="background: ${statusColor}; height: 100%; width: ${status.progress}%; transition: width 0.3s ease;"></div>
                        </div>
                    ` : ''}
                </div>
            `;
        });
        
        document.getElementById('updateProgress').innerHTML = html;
    }
}

function closeUpdateModelsModal() {
    const modal = document.getElementById('updateModelsModal');
    if (modal) {
        modal.remove();
    }
    // Refresh page to show updated model list
    location.reload();
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Check hardware requirements when switching modes
function checkHardwareRequirements() {
    const mode = document.getElementById('ai_hardware_mode').value;
    if (mode === 'gpu') {
        // Auto-setup logic will be triggered on save
        console.log('[Hardware] GPU mode selected - will check requirements on save');
    }
}

// GPU Setup Functions
function setupGPU() {
    const modal = document.getElementById('gpuSetupModal');
    const progress = document.getElementById('gpuSetupProgress');
    
    modal.style.display = 'flex';
    progress.textContent = 'üöÄ Starting GPU setup...\n';
    
    // Connect to SSE endpoint
    const eventSource = new EventSource('/settings/setup_gpu');
    
    eventSource.onmessage = function(event) {
        const data = JSON.parse(event.data);
        
        if (data.status === 'progress') {
            progress.textContent += data.message + '\n';
            progress.scrollTop = progress.scrollHeight;
        } else if (data.status === 'complete') {
            progress.textContent += '\n‚úÖ Setup complete!\n';
            if (data.result.reboot_required) {
                progress.textContent += '\n‚ö†Ô∏è  REBOOT REQUIRED: Please restart your system to activate the GPU.\n';
            }
            eventSource.close();
        } else if (data.status === 'error') {
            progress.textContent += '\n‚ùå Error: ' + data.message + '\n';
            eventSource.close();
        }
    };
    
    eventSource.onerror = function() {
        progress.textContent += '\n‚ùå Connection error. Please check logs.\n';
        eventSource.close();
    };
}

function closeGPUSetupModal() {
    document.getElementById('gpuSetupModal').style.display = 'none';
}
</script>
{% endblock %}

