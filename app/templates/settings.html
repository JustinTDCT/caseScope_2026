{% extends "base.html" %}

{% block title %}System Settings{% endblock %}

{% block content %}
<div class="content-header">
    <h1 class="content-title">‚öôÔ∏è System Settings</h1>
    <p style="color: var(--color-text-muted); margin: 0;">Configure system-wide settings and integrations</p>
</div>

<div style="max-width: 1200px; margin: 0 auto;">
    <form method="POST" action="{{ url_for('settings.save') }}">
        <!-- DFIR-IRIS Integration -->
        <div class="card" style="margin-bottom: var(--spacing-lg);">
            <div class="card-header">
                <h2 class="card-title">üîó DFIR-IRIS Integration</h2>
                <p style="color: var(--color-text-muted); margin: var(--spacing-sm) 0 0 0; font-size: 0.875rem;">
                    Sync cases, IOCs, and timeline events with DFIR-IRIS platform
                </p>
            </div>
            
            <div class="card-body">
                <!-- Enable DFIR-IRIS -->
                <div style="margin-bottom: var(--spacing-lg);">
                    <label style="display: flex; align-items: center; gap: var(--spacing-sm); cursor: pointer;">
                        <input type="checkbox" 
                               name="dfir_iris_enabled" 
                               {% if dfir_iris_enabled %}checked{% endif %}
                               style="width: 18px; height: 18px; cursor: pointer;">
                        <span style="font-weight: 500;">Enable DFIR-IRIS Integration</span>
                    </label>
                    <p style="color: var(--color-text-muted); margin: var(--spacing-xs) 0 0 26px; font-size: 0.875rem;">
                        Automatically sync case data, IOCs, and timeline events
                    </p>
                </div>

                <!-- DFIR-IRIS URL -->
                <div class="form-group">
                    <label for="dfir_iris_url">DFIR-IRIS URL</label>
                    <input type="url" 
                           id="dfir_iris_url"
                           name="dfir_iris_url" 
                           value="{{ dfir_iris_url }}"
                           placeholder="https://iris.example.com"
                           style="width: 100%; max-width: 600px;">
                    <p style="color: var(--color-text-muted); margin: var(--spacing-xs) 0 0 0; font-size: 0.875rem;">
                        Full URL to your DFIR-IRIS instance (e.g., https://iris.example.com)
                    </p>
                </div>

                <!-- API Key -->
                <div class="form-group">
                    <label for="dfir_iris_api_key">API Key</label>
                    <input type="password" 
                           id="dfir_iris_api_key"
                           name="dfir_iris_api_key" 
                           value="{{ dfir_iris_api_key }}"
                           placeholder="Enter DFIR-IRIS API key"
                           style="width: 100%; max-width: 600px; font-family: monospace;">
                    <p style="color: var(--color-text-muted); margin: var(--spacing-xs) 0 0 0; font-size: 0.875rem;">
                        API key from DFIR-IRIS (User Settings ‚Üí API Keys)
                    </p>
                </div>

                <!-- Action Buttons -->
                <div style="display: flex; gap: var(--spacing-md); margin-top: var(--spacing-md);">
                    <button type="button" 
                            onclick="testIrisConnection()"
                            class="btn"
                            style="padding: var(--spacing-sm) var(--spacing-lg); background: var(--color-info); color: white;">
                        üîå Test Connection
                    </button>
                    <button type="button" 
                            onclick="syncNow()"
                            class="btn"
                            style="padding: var(--spacing-sm) var(--spacing-lg); background: var(--color-success); color: white;">
                        üîÑ Sync Now
                    </button>
                </div>
                
                <!-- Test/Sync Result -->
                <div id="test-result" style="margin-top: var(--spacing-sm); display: none;"></div>

                <!-- Sync Behavior Info -->
                <div style="background: var(--color-background-secondary); padding: var(--spacing-md); border-radius: var(--border-radius); border-left: 3px solid var(--color-info);">
                    <h3 style="margin: 0 0 var(--spacing-sm) 0; font-size: 0.875rem; color: var(--color-info);">
                        üìã Sync Behavior
                    </h3>
                    <ul style="margin: 0; padding-left: var(--spacing-lg); color: var(--color-text-muted); font-size: 0.875rem; line-height: 1.6;">
                        <li>Company check: Creates if missing in DFIR-IRIS</li>
                        <li>Case sync: Creates if missing, matches open/closed status</li>
                        <li>IOC sync: Updates existing, creates new</li>
                        <li>Timeline events: Syncs tagged events, removes untagged
                            <ul style="margin-top: var(--spacing-xs);">
                                <li>Event timestamp = actual event time</li>
                                <li>Title = description + computer name</li>
                                <li>Source = "Pushed from CaseScope"</li>
                                <li>Raw data = full JSON/NDJSON</li>
                                <li>Manual edits in DFIR-IRIS preserved</li>
                            </ul>
                        </li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- OpenCTI Integration -->
        <div class="card" style="margin-bottom: var(--spacing-lg);">
            <div class="card-header">
                <h2 class="card-title">üß† OpenCTI Integration</h2>
                <p style="color: var(--color-text-muted); margin: var(--spacing-sm) 0 0 0; font-size: 0.875rem;">
                    Enrich IOCs with threat intelligence from OpenCTI
                </p>
            </div>
            
            <div class="card-body">
                <!-- Enable OpenCTI -->
                <div style="margin-bottom: var(--spacing-lg);">
                    <label style="display: flex; align-items: center; gap: var(--spacing-sm); cursor: pointer;">
                        <input type="checkbox" 
                               name="opencti_enabled" 
                               {% if opencti_enabled %}checked{% endif %}
                               style="width: 18px; height: 18px; cursor: pointer;">
                        <span style="font-weight: 500;">Enable OpenCTI Integration</span>
                    </label>
                    <p style="color: var(--color-text-muted); margin: var(--spacing-xs) 0 0 26px; font-size: 0.875rem;">
                        Automatically enrich IOCs with threat intelligence data
                    </p>
                </div>

                <!-- OpenCTI URL -->
                <div class="form-group">
                    <label for="opencti_url">OpenCTI URL</label>
                    <input type="url" 
                           id="opencti_url"
                           name="opencti_url" 
                           value="{{ opencti_url }}"
                           placeholder="https://opencti.example.com"
                           style="width: 100%; max-width: 600px;">
                    <p style="color: var(--color-text-muted); margin: var(--spacing-xs) 0 0 0; font-size: 0.875rem;">
                        Full URL to your OpenCTI instance (e.g., https://opencti.example.com)
                    </p>
                </div>

                <!-- API Key -->
                <div class="form-group">
                    <label for="opencti_api_key">API Key</label>
                    <input type="password" 
                           id="opencti_api_key"
                           name="opencti_api_key" 
                           value="{{ opencti_api_key }}"
                           placeholder="Enter OpenCTI API key"
                           style="width: 100%; max-width: 600px; font-family: monospace;">
                    <p style="color: var(--color-text-muted); margin: var(--spacing-xs) 0 0 0; font-size: 0.875rem;">
                        API key from OpenCTI (Profile ‚Üí API Tokens)
                    </p>
                </div>

                <!-- Action Buttons -->
                <div style="display: flex; gap: var(--spacing-md); margin-top: var(--spacing-md);">
                    <button type="button" 
                            onclick="testOpenCTIConnection()"
                            class="btn"
                            style="padding: var(--spacing-sm) var(--spacing-lg); background: var(--color-info); color: white;">
                        üîå Test Connection
                    </button>
                    <button type="button" 
                            onclick="syncOpenCTI()"
                            class="btn"
                            style="padding: var(--spacing-sm) var(--spacing-lg); background: var(--color-success); color: white;">
                        üîÑ Sync Now
                    </button>
                </div>
                
                <!-- Test/Sync Result -->
                <div id="opencti-result" style="margin-top: var(--spacing-sm); display: none;"></div>

                <!-- Sync Behavior Info -->
                <div style="background: var(--color-background-secondary); padding: var(--spacing-md); border-radius: var(--border-radius); border-left: 3px solid var(--color-info); margin-top: var(--spacing-md);">
                    <h3 style="margin: 0 0 var(--spacing-sm) 0; font-size: 0.875rem; color: var(--color-info);">
                        üìã Enrichment Behavior
                    </h3>
                    <ul style="margin: 0; padding-left: var(--spacing-lg); color: var(--color-text-muted); font-size: 0.875rem; line-height: 1.6;">
                        <li>Checks IOCs against OpenCTI threat intelligence database</li>
                        <li>Returns threat actor, campaign, and malware associations</li>
                        <li>Provides confidence score and TLP classification</li>
                        <li>Enrichment data stored with each IOC for reference</li>
                        <li>IOCs not found in OpenCTI are marked as "clean" (no match)</li>
                        <li>Re-enrichment updates existing data (useful for new intel)</li>
                        <li><strong>IOC Types Enriched:</strong> IP, Domain, Hostname, Username, Hash, Email, URL, Registry, Filename</li>
                        <li><strong>IOC Types Skipped:</strong> Command-line (environment-specific, no threat intel value)</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Logging Configuration -->
        <div class="card" style="margin-bottom: var(--spacing-lg);">
            <div class="card-header">
                <h2 class="card-title">üìã Logging</h2>
                <p style="color: var(--color-text-muted); margin: var(--spacing-sm) 0 0 0; font-size: 0.875rem;">
                    Configure application logging level and view log files
                </p>
            </div>
            
            <div class="card-body">
                <!-- Log Level Selection -->
                <div class="form-group">
                    <label for="log_level">Log Level</label>
                    <select id="log_level" 
                            name="log_level" 
                            style="width: 100%; max-width: 300px; padding: var(--spacing-sm); border: 1px solid var(--color-border); border-radius: var(--border-radius); background: var(--color-background); color: var(--color-text);">
                        <option value="DEBUG" {% if log_level == 'DEBUG' %}selected{% endif %}>DEBUG - Log everything (verbose)</option>
                        <option value="INFO" {% if log_level == 'INFO' %}selected{% endif %}>INFO - Normal operations (recommended)</option>
                        <option value="WARNING" {% if log_level == 'WARNING' %}selected{% endif %}>WARNING - Only warnings and errors</option>
                        <option value="ERROR" {% if log_level == 'ERROR' %}selected{% endif %}>ERROR - Only errors (minimal)</option>
                    </select>
                    <p style="color: var(--color-text-muted); margin: var(--spacing-xs) 0 0 0; font-size: 0.875rem;">
                        <strong>Current Level:</strong> {{ log_level or 'INFO' }} | 
                        <strong>Logs Location:</strong> <code style="background: var(--color-background-secondary); padding: 2px 6px; border-radius: 3px;">/opt/casescope/logs/</code>
                    </p>
                </div>

                <!-- Log Files Info -->
                <div style="background: var(--color-background-secondary); padding: var(--spacing-md); border-radius: var(--border-radius); border-left: 3px solid var(--color-info); margin-top: var(--spacing-md);">
                    <h3 style="margin: 0 0 var(--spacing-sm) 0; font-size: 0.875rem; color: var(--color-info);">
                        üìÅ Log Files
                    </h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-sm); margin: var(--spacing-sm) 0;">
                        <div style="font-family: monospace; font-size: 0.8rem; padding: var(--spacing-xs); background: var(--color-background); border-radius: var(--border-radius);">
                            <strong style="color: var(--color-primary);">cases.log</strong><br>
                            <span style="color: var(--color-text-muted);">Case operations</span>
                        </div>
                        <div style="font-family: monospace; font-size: 0.8rem; padding: var(--spacing-xs); background: var(--color-background); border-radius: var(--border-radius);">
                            <strong style="color: var(--color-primary);">files.log</strong><br>
                            <span style="color: var(--color-text-muted);">File processing</span>
                        </div>
                        <div style="font-family: monospace; font-size: 0.8rem; padding: var(--spacing-xs); background: var(--color-background); border-radius: var(--border-radius);">
                            <strong style="color: var(--color-primary);">workers.log</strong><br>
                            <span style="color: var(--color-text-muted);">Celery tasks</span>
                        </div>
                        <div style="font-family: monospace; font-size: 0.8rem; padding: var(--spacing-xs); background: var(--color-background); border-radius: var(--border-radius);">
                            <strong style="color: var(--color-primary);">app.log</strong><br>
                            <span style="color: var(--color-text-muted);">Web application</span>
                        </div>
                        <div style="font-family: monospace; font-size: 0.8rem; padding: var(--spacing-xs); background: var(--color-background); border-radius: var(--border-radius);">
                            <strong style="color: var(--color-primary);">api.log</strong><br>
                            <span style="color: var(--color-text-muted);">External API calls</span>
                        </div>
                        <div style="font-family: monospace; font-size: 0.8rem; padding: var(--spacing-xs); background: var(--color-background); border-radius: var(--border-radius);">
                            <strong style="color: var(--color-primary);">dfir_iris.log</strong><br>
                            <span style="color: var(--color-text-muted);">DFIR-IRIS integration</span>
                        </div>
                        <div style="font-family: monospace; font-size: 0.8rem; padding: var(--spacing-xs); background: var(--color-background); border-radius: var(--border-radius); grid-column: span 1;">
                            <strong style="color: var(--color-primary);">opencti.log</strong><br>
                            <span style="color: var(--color-text-muted);">OpenCTI integration</span>
                        </div>
                    </div>
                    <p style="margin: var(--spacing-sm) 0 0 0; color: var(--color-text-muted); font-size: 0.875rem;">
                        üí° <strong>Tip:</strong> Use <code style="background: var(--color-background); padding: 2px 6px; border-radius: 3px;">tail -f /opt/casescope/logs/[filename].log</code> to monitor logs in real-time
                    </p>
                </div>

                <!-- Log Level Details -->
                <div style="background: var(--color-background-secondary); padding: var(--spacing-md); border-radius: var(--border-radius); border-left: 3px solid var(--color-warning); margin-top: var(--spacing-md);">
                    <h3 style="margin: 0 0 var(--spacing-sm) 0; font-size: 0.875rem; color: var(--color-warning);">
                        ‚öôÔ∏è Log Level Details
                    </h3>
                    <ul style="margin: 0; padding-left: var(--spacing-lg); color: var(--color-text-muted); font-size: 0.875rem; line-height: 1.6;">
                        <li><strong>DEBUG:</strong> Maximum verbosity - Logs all operations, variables, SQL queries, API calls. Use for troubleshooting only (large log files).</li>
                        <li><strong>INFO:</strong> Normal operations - Logs important events like case creation, file uploads, user actions. Recommended for production.</li>
                        <li><strong>WARNING:</strong> Potential issues - Logs warnings and errors only. Use when disk space is limited.</li>
                        <li><strong>ERROR:</strong> Errors only - Logs only critical failures. Use for minimal logging in stable environments.</li>
                    </ul>
                    <p style="margin: var(--spacing-sm) 0 0 0; color: var(--color-text-muted); font-size: 0.875rem;">
                        ‚ö†Ô∏è <strong>Note:</strong> Changes take effect immediately. Restart services if logs are not updating.
                    </p>
                </div>
            </div>
        </div>

        <!-- AI Configuration -->
        <div class="card" style="margin-bottom: var(--spacing-lg);">
            <div class="card-header">
                <h2 class="card-title">ü§ñ AI Report Generation</h2>
                <p style="color: var(--color-text-muted); margin: var(--spacing-sm) 0 0 0; font-size: 0.875rem;">
                    Generate automated DFIR reports using local AI (Phi-3 14B via Ollama)
                </p>
            </div>
            
            <div class="card-body">
                <!-- AI System Status -->
                <div style="background: {% if ai_status.running and ai_status.model_available %}var(--color-success-bg){% elif ai_status.installed %}var(--color-warning-bg){% else %}var(--color-error-bg){% endif %}; padding: var(--spacing-md); border-radius: var(--border-radius); border-left: 3px solid {% if ai_status.running and ai_status.model_available %}var(--color-success){% elif ai_status.installed %}var(--color-warning){% else %}var(--color-error){% endif %}; margin-bottom: var(--spacing-md);">
                    <div style="display: flex; align-items: center; gap: var(--spacing-sm); margin-bottom: var(--spacing-xs);">
                        <span style="font-size: 1.2rem;">{% if ai_status.running and ai_status.model_available %}‚úÖ{% elif ai_status.installed %}‚ö†Ô∏è{% else %}‚ùå{% endif %}</span>
                        <strong style="color: {% if ai_status.running and ai_status.model_available %}var(--color-success){% elif ai_status.installed %}var(--color-warning){% else %}var(--color-error){% endif %};">
                            AI System Status
                        </strong>
                    </div>
                    <ul style="margin: var(--spacing-xs) 0 0 0; padding-left: var(--spacing-lg); color: var(--color-text-muted); font-size: 0.875rem; line-height: 1.6;">
                        <li><strong>Ollama:</strong> {% if ai_status.running %}‚úÖ Running{% elif ai_status.installed %}‚ö†Ô∏è Installed but not running{% else %}‚ùå Not installed{% endif %}</li>
                        <li><strong>Phi-3 14B Model:</strong> {% if ai_status.model_available %}‚úÖ Available{% else %}‚ùå Not found{% endif %}</li>
                        {% if ai_status.models %}
                        <li><strong>Installed Models:</strong> {{ ai_status.models|join(', ') }}</li>
                        {% endif %}
                    </ul>
                    {% if not ai_status.running or not ai_status.model_available %}
                    <p style="margin: var(--spacing-sm) 0 0 0; color: var(--color-text-muted); font-size: 0.875rem;">
                        ‚ö†Ô∏è <strong>To enable AI features:</strong> Install Ollama and pull the phi3:14b model
                        <br>
                        <code style="background: var(--color-background); padding: 2px 6px; border-radius: 3px;">curl -fsSL https://ollama.com/install.sh | sh && ollama pull phi3:14b</code>
                    </p>
                    {% endif %}
                </div>

                <!-- Enable AI -->
                <div style="margin-bottom: var(--spacing-lg);">
                    <label style="display: flex; align-items: center; gap: var(--spacing-sm); cursor: pointer;">
                        <input type="checkbox" 
                               name="ai_enabled" 
                               {% if ai_enabled %}checked{% endif %}
                               style="width: 18px; height: 18px; cursor: pointer;">
                        <span style="font-weight: 500;">Enable AI Report Generation</span>
                    </label>
                    <p style="color: var(--color-text-muted); margin: var(--spacing-xs) 0 0 26px; font-size: 0.875rem;">
                        Allow users to generate AI-powered DFIR reports from case data, IOCs, and tagged events
                    </p>
                </div>

                <!-- AI Model Name -->
                <div class="form-group">
                    <label for="ai_model_name">AI Model</label>
                    <input type="text" 
                           id="ai_model_name"
                           name="ai_model_name" 
                           value="{{ ai_model_name }}"
                           placeholder="phi3:14b"
                           style="width: 100%; max-width: 400px;">
                    <p style="color: var(--color-text-muted); margin: var(--spacing-xs) 0 0 0; font-size: 0.875rem;">
                        Ollama model name (default: phi3:14b). Other options: phi3:3.8b, llama3.1:8b, mistral:7b
                    </p>
                </div>

                <!-- AI Performance Info -->
                <div style="background: var(--color-background-secondary); padding: var(--spacing-md); border-radius: var(--border-radius); border-left: 3px solid var(--color-info); margin-top: var(--spacing-md);">
                    <h3 style="margin: 0 0 var(--spacing-sm) 0; font-size: 0.875rem; color: var(--color-info);">
                        ‚ö° Performance Information
                    </h3>
                    <ul style="margin: 0; padding-left: var(--spacing-lg); color: var(--color-text-muted); font-size: 0.875rem; line-height: 1.6;">
                        <li><strong>Generation Time:</strong> 3-5 minutes average (depends on CPU cores and case complexity)</li>
                        <li><strong>Processing:</strong> Runs on CPU only (no GPU required)</li>
                        <li><strong>Privacy:</strong> 100% local - no data sent to external services</li>
                        <li><strong>Cost:</strong> $0 - completely free and self-hosted</li>
                        <li><strong>Quality:</strong> GPT-3.5 level analysis for DFIR investigations</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Save Button -->
        <div style="display: flex; gap: var(--spacing-md);">
            <button type="submit" class="btn btn-primary" style="padding: var(--spacing-sm) var(--spacing-xl);">
                üíæ Save Settings
            </button>
            <a href="{{ url_for('dashboard') }}" class="btn" style="padding: var(--spacing-sm) var(--spacing-lg);">
                Cancel
            </a>
        </div>
    </form>
</div>

<script>
function testIrisConnection() {
    const url = document.getElementById('dfir_iris_url').value.trim();
    const apiKey = document.getElementById('dfir_iris_api_key').value.trim();
    const resultDiv = document.getElementById('test-result');
    const button = event.target;
    
    if (!url || !apiKey) {
        resultDiv.style.display = 'block';
        resultDiv.style.padding = 'var(--spacing-sm)';
        resultDiv.style.borderRadius = 'var(--border-radius)';
        resultDiv.style.background = 'rgba(239, 68, 68, 0.1)';
        resultDiv.style.color = 'var(--color-error)';
        resultDiv.style.fontSize = '0.875rem';
        resultDiv.textContent = '‚ö†Ô∏è Please enter both URL and API key';
        return;
    }
    
    button.disabled = true;
    button.textContent = '‚è≥ Testing...';
    
    fetch('{{ url_for("settings.test_iris") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ url: url, api_key: apiKey })
    })
    .then(response => response.json())
    .then(data => {
        resultDiv.style.display = 'block';
        resultDiv.style.padding = 'var(--spacing-sm)';
        resultDiv.style.borderRadius = 'var(--border-radius)';
        resultDiv.style.fontSize = '0.875rem';
        
        if (data.success) {
            resultDiv.style.background = 'rgba(34, 197, 94, 0.1)';
            resultDiv.style.color = 'var(--color-success)';
        } else {
            resultDiv.style.background = 'rgba(239, 68, 68, 0.1)';
            resultDiv.style.color = 'var(--color-error)';
        }
        
        resultDiv.textContent = data.message;
    })
    .catch(error => {
        resultDiv.style.display = 'block';
        resultDiv.style.padding = 'var(--spacing-sm)';
        resultDiv.style.borderRadius = 'var(--border-radius)';
        resultDiv.style.background = 'rgba(239, 68, 68, 0.1)';
        resultDiv.style.color = 'var(--color-error)';
        resultDiv.style.fontSize = '0.875rem';
        resultDiv.textContent = '‚úó Connection test failed: ' + error.message;
    })
    .finally(() => {
        button.disabled = false;
        button.textContent = 'üîå Test Connection';
    });
}

function syncNow() {
    const resultDiv = document.getElementById('test-result');
    const button = event.target;
    
    if (!confirm('This will sync all active cases, IOCs, and tagged timeline events to DFIR-IRIS. Continue?')) {
        return;
    }
    
    button.disabled = true;
    button.textContent = '‚è≥ Syncing...';
    
    resultDiv.style.display = 'block';
    resultDiv.style.padding = 'var(--spacing-sm)';
    resultDiv.style.borderRadius = 'var(--border-radius)';
    resultDiv.style.fontSize = '0.875rem';
    resultDiv.style.background = 'rgba(59, 130, 246, 0.1)';
    resultDiv.style.color = 'var(--color-info)';
    resultDiv.textContent = '‚è≥ Starting sync process...';
    
    fetch('{{ url_for("settings.sync_now") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        resultDiv.style.display = 'block';
        resultDiv.style.padding = 'var(--spacing-sm)';
        resultDiv.style.borderRadius = 'var(--border-radius)';
        resultDiv.style.fontSize = '0.875rem';
        
        if (data.success) {
            resultDiv.style.background = 'rgba(34, 197, 94, 0.1)';
            resultDiv.style.color = 'var(--color-success)';
        } else {
            resultDiv.style.background = 'rgba(239, 68, 68, 0.1)';
            resultDiv.style.color = 'var(--color-error)';
        }
        
        resultDiv.textContent = data.message;
    })
    .catch(error => {
        resultDiv.style.display = 'block';
        resultDiv.style.padding = 'var(--spacing-sm)';
        resultDiv.style.borderRadius = 'var(--border-radius)';
        resultDiv.style.background = 'rgba(239, 68, 68, 0.1)';
        resultDiv.style.color = 'var(--color-error)';
        resultDiv.style.fontSize = '0.875rem';
        resultDiv.textContent = '‚úó Sync failed: ' + error.message;
    })
    .finally(() => {
        button.disabled = false;
        button.textContent = 'üîÑ Sync Now';
    });
}

function testOpenCTIConnection() {
    const url = document.getElementById('opencti_url').value.trim();
    const apiKey = document.getElementById('opencti_api_key').value.trim();
    const resultDiv = document.getElementById('opencti-result');
    const button = event.target;
    
    if (!url || !apiKey) {
        resultDiv.style.display = 'block';
        resultDiv.style.padding = 'var(--spacing-sm)';
        resultDiv.style.borderRadius = 'var(--border-radius)';
        resultDiv.style.background = 'rgba(239, 68, 68, 0.1)';
        resultDiv.style.color = 'var(--color-error)';
        resultDiv.style.fontSize = '0.875rem';
        resultDiv.textContent = '‚ö†Ô∏è Please enter both URL and API key';
        return;
    }
    
    button.disabled = true;
    button.textContent = '‚è≥ Testing...';
    
    fetch('{{ url_for("settings.test_opencti") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ url: url, api_key: apiKey })
    })
    .then(response => response.json())
    .then(data => {
        resultDiv.style.display = 'block';
        resultDiv.style.padding = 'var(--spacing-sm)';
        resultDiv.style.borderRadius = 'var(--border-radius)';
        resultDiv.style.fontSize = '0.875rem';
        
        if (data.success) {
            resultDiv.style.background = 'rgba(34, 197, 94, 0.1)';
            resultDiv.style.color = 'var(--color-success)';
        } else {
            resultDiv.style.background = 'rgba(239, 68, 68, 0.1)';
            resultDiv.style.color = 'var(--color-error)';
        }
        
        resultDiv.textContent = data.message;
    })
    .catch(error => {
        resultDiv.style.display = 'block';
        resultDiv.style.padding = 'var(--spacing-sm)';
        resultDiv.style.borderRadius = 'var(--border-radius)';
        resultDiv.style.background = 'rgba(239, 68, 68, 0.1)';
        resultDiv.style.color = 'var(--color-error)';
        resultDiv.style.fontSize = '0.875rem';
        resultDiv.textContent = '‚úó Connection test failed: ' + error.message;
    })
    .finally(() => {
        button.disabled = false;
        button.textContent = 'üîå Test Connection';
    });
}

function syncOpenCTI() {
    const resultDiv = document.getElementById('opencti-result');
    const button = event.target;
    
    if (!confirm('This will enrich all IOCs in all active cases with OpenCTI threat intelligence. Continue?')) {
        return;
    }
    
    button.disabled = true;
    button.textContent = '‚è≥ Enriching...';
    
    resultDiv.style.display = 'block';
    resultDiv.style.padding = 'var(--spacing-sm)';
    resultDiv.style.borderRadius = 'var(--border-radius)';
    resultDiv.style.fontSize = '0.875rem';
    resultDiv.style.background = 'rgba(59, 130, 246, 0.1)';
    resultDiv.style.color = 'var(--color-info)';
    resultDiv.textContent = '‚è≥ Starting enrichment process...';
    
    fetch('{{ url_for("settings.sync_opencti") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        resultDiv.style.display = 'block';
        resultDiv.style.padding = 'var(--spacing-sm)';
        resultDiv.style.borderRadius = 'var(--border-radius)';
        resultDiv.style.fontSize = '0.875rem';
        
        if (data.success) {
            resultDiv.style.background = 'rgba(34, 197, 94, 0.1)';
            resultDiv.style.color = 'var(--color-success)';
        } else {
            resultDiv.style.background = 'rgba(239, 68, 68, 0.1)';
            resultDiv.style.color = 'var(--color-error)';
        }
        
        resultDiv.textContent = data.message;
    })
    .catch(error => {
        resultDiv.style.display = 'block';
        resultDiv.style.padding = 'var(--spacing-sm)';
        resultDiv.style.borderRadius = 'var(--border-radius)';
        resultDiv.style.background = 'rgba(239, 68, 68, 0.1)';
        resultDiv.style.color = 'var(--color-error)';
        resultDiv.style.fontSize = '0.875rem';
        resultDiv.textContent = '‚úó Enrichment failed: ' + error.message;
    })
    .finally(() => {
        button.disabled = false;
        button.textContent = 'üîÑ Sync Now';
    });
}
</script>
{% endblock %}

