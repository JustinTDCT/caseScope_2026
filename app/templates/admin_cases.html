{% extends "base.html" %}
{% block title %}Case Management - CaseScope 2026{% endblock %}

{% block content %}
<div class="content-header">
    <h1 class="content-title">üóÇÔ∏è Case Management</h1>
    <div>
        <a href="{{ url_for('dashboard') }}" class="btn btn-secondary">‚Üê Back to Dashboard</a>
    </div>
</div>

<div class="card">
    <div class="card-header">
        <h2 class="card-title">All Cases ({{ case_data|length }})</h2>
    </div>
    <div class="card-body">
        {% if case_data %}
        <div class="table-container">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Case Name</th>
                        <th>Status</th>
                        <th>Created By</th>
                        <th>Assigned To</th>
                        <th>Files</th>
                        <th>Created</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in case_data %}
                    <tr data-case-id="{{ item.case.id }}">
                        <td>{{ item.case.id }}</td>
                        <td>
                            <a href="{{ url_for('view_case', case_id=item.case.id) }}" style="font-weight: 600;">
                                {{ item.case.name }}
                            </a>
                        </td>
                        <td>
                            {% if item.case.status == 'New' %}
                                <span class="status-badge" style="background: rgba(99, 102, 241, 0.1); color: #6366f1; font-weight: 600;">üÜï New</span>
                            {% elif item.case.status == 'Assigned' %}
                                <span class="status-badge" style="background: rgba(251, 191, 36, 0.1); color: #f59e0b; font-weight: 600;">üë§ Assigned</span>
                            {% elif item.case.status == 'In Progress' %}
                                <span class="status-badge" style="background: rgba(16, 185, 129, 0.1); color: #10b981; font-weight: 600;">‚öôÔ∏è In Progress</span>
                            {% elif item.case.status == 'Completed' %}
                                <span class="status-badge" style="background: rgba(139, 92, 246, 0.1); color: #8b5cf6; font-weight: 600;">‚úÖ Completed</span>
                            {% else %}
                                <span class="status-badge status-{{ item.case.status }}">{{ item.case.status|upper }}</span>
                            {% endif %}
                        </td>
                        <td>{{ item.creator_name }}</td>
                        <td>{{ item.assignee_name }}</td>
                        <td>{{ item.file_count }}</td>
                        <td>{{ item.case.created_at.strftime('%Y-%m-%d') }}</td>
                        <td>
                            <div style="display: flex; gap: 4px;">
                                <button onclick="editCase({{ item.case.id }})" class="btn btn-sm btn-secondary" title="Edit Case">
                                    ‚úèÔ∏è
                                </button>
                                <button onclick="toggleStatus({{ item.case.id }}, '{{ item.case.status }}')" 
                                        class="btn btn-sm" 
                                        style="background: {% if item.case.status == 'active' %}var(--color-warning){% else %}var(--color-success){% endif %}; color: white;"
                                        title="{% if item.case.status == 'active' %}Close Case{% else %}Reopen Case{% endif %}">
                                    {% if item.case.status == 'active' %}üîí{% else %}üîì{% endif %}
                                </button>
                                <button onclick="deleteCase({{ item.case.id }}, '{{ item.case.name }}')" 
                                        class="btn btn-sm" 
                                        style="background: var(--color-error); color: white;"
                                        title="Delete Case">
                                    üóëÔ∏è
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <p>No cases found.</p>
        {% endif %}
    </div>
</div>

<script>
function editCase(caseId) {
    window.location.href = `/case/${caseId}/edit?return_to=admin`;
}

function toggleStatus(caseId, currentStatus) {
    const action = currentStatus === 'active' ? 'close' : 'reopen';
    if (!confirm(`${action.charAt(0).toUpperCase() + action.slice(1)} this case?`)) {
        return;
    }
    
    fetch(`/case/${caseId}/toggle_status`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'}
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Network error');
    });
}

let deleteTaskId = null;
let deleteIntervalId = null;

function deleteCase(caseId, caseName) {
    const confirmation = prompt(
        `‚ö†Ô∏è DELETE CASE: "${caseName}"\n\n` +
        `This will PERMANENTLY delete:\n` +
        `‚Ä¢ Physical files on disk\n` +
        `‚Ä¢ All OpenSearch indices\n` +
        `‚Ä¢ All SIGMA violations\n` +
        `‚Ä¢ All IOC matches & IOCs\n` +
        `‚Ä¢ All systems & timeline tags\n` +
        `‚Ä¢ All AI reports\n` +
        `‚Ä¢ All search history\n\n` +
        `Type "DELETE" (all caps) to confirm:`
    );
    
    if (confirmation === null) {
        // User clicked Cancel
        return;
    }
    
    if (confirmation !== 'DELETE') {
        alert(`‚ùå Case deletion cancelled.\n\nYou typed: "${confirmation}"\n\nYou must type exactly "DELETE" (all caps) to confirm deletion.`);
        return;
    }
    
    // Start deletion
    fetch(`/case/${caseId}/delete`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'}
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            deleteTaskId = data.task_id;
            showDeleteProgress(caseId, data.case_name);
            pollDeleteProgress(caseId);
        } else {
            alert('‚ùå Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Network error starting deletion');
    });
}

function showDeleteProgress(caseId, caseName) {
    document.getElementById('deleteProgressModal').style.display = 'flex';
    document.getElementById('deleteCaseName').textContent = caseName;
    document.getElementById('deleteProgress').style.width = '0%';
    document.getElementById('deleteProgress').textContent = '0%';
    document.getElementById('deleteStep').textContent = 'Starting deletion...';
    document.getElementById('deleteDetails').innerHTML = '';
}

function pollDeleteProgress(caseId) {
    if (!deleteTaskId) return;
    
    deleteIntervalId = setInterval(() => {
        fetch(`/case/${caseId}/delete/status/${deleteTaskId}`)
            .then(response => response.json())
            .then(data => {
                const progress = data.progress || 0;
                document.getElementById('deleteProgress').style.width = progress + '%';
                document.getElementById('deleteProgress').textContent = progress + '%';
                document.getElementById('deleteStep').textContent = data.message || 'Processing...';
                
                // Show details
                let details = '';
                if (data.files) details += `üìÅ Files: ${data.files}\n`;
                if (data.iocs) details += `üö® IOCs: ${data.iocs}\n`;
                if (data.systems) details += `üíª Systems: ${data.systems}\n`;
                if (data.sigma) details += `‚ö†Ô∏è SIGMA: ${data.sigma}\n`;
                if (data.ai_reports) details += `ü§ñ AI Reports: ${data.ai_reports}\n`;
                if (data.indices_deleted !== undefined) details += `üóÇÔ∏è Indices Deleted: ${data.indices_deleted}\n`;
                
                if (details) {
                    document.getElementById('deleteDetails').textContent = details;
                }
                
                // Check if done
                if (data.state === 'SUCCESS') {
                    clearInterval(deleteIntervalId);
                    document.getElementById('deleteProgress').style.background = 'var(--color-success)';
                    document.getElementById('deleteStep').innerHTML = '‚úÖ <strong>Deletion Complete!</strong>';
                    
                    setTimeout(() => {
                        document.getElementById('deleteProgressModal').style.display = 'none';
                        location.reload();
                    }, 2000);
                } else if (data.state === 'FAILURE' || data.state === 'ERROR') {
                    clearInterval(deleteIntervalId);
                    document.getElementById('deleteProgress').style.background = 'var(--color-error)';
                    document.getElementById('deleteStep').innerHTML = '‚ùå <strong>Deletion Failed:</strong> ' + data.message;
                }
            })
            .catch(error => {
                console.error('Polling error:', error);
                clearInterval(deleteIntervalId);
                document.getElementById('deleteStep').innerHTML = '‚ùå <strong>Connection Lost</strong>';
            });
    }, 500); // Poll every 500ms for smooth progress
}

function closeDeleteProgress() {
    if (deleteIntervalId) {
        clearInterval(deleteIntervalId);
    }
    document.getElementById('deleteProgressModal').style.display = 'none';
}
</script>

<style>
.status-badge {
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 11px;
    font-weight: 600;
}
.status-active {
    background: var(--color-success);
    color: white;
}
.status-closed {
    background: var(--color-text-secondary);
    color: white;
}
</style>

<!-- Deletion Progress Modal -->
<div id="deleteProgressModal" class="modal-overlay" style="display: none;">
    <div class="modal-container" style="max-width: 600px;">
        <div class="modal-header">
            <h2 class="modal-title">üóëÔ∏è Deleting Case: <span id="deleteCaseName"></span></h2>
            <button onclick="closeDeleteProgress()" class="modal-close">‚úï</button>
        </div>
        <div class="modal-body" style="padding: var(--spacing-lg);">
            <div style="margin-bottom: var(--spacing-md);">
                <div style="font-weight: 600; margin-bottom: var(--spacing-sm);" id="deleteStep">
                    Starting deletion...
                </div>
                <div style="background: var(--color-bg-secondary); border-radius: var(--border-radius); overflow: hidden; height: 32px; position: relative;">
                    <div id="deleteProgress" 
                         style="background: var(--color-warning); height: 100%; width: 0%; transition: width 0.3s ease; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 0.875rem;">
                        0%
                    </div>
                </div>
            </div>
            
            <div style="background: var(--color-bg-secondary); padding: var(--spacing-md); border-radius: var(--border-radius); font-family: 'Courier New', monospace; font-size: 0.875rem; white-space: pre-line; min-height: 120px;" id="deleteDetails">
                <!-- Details populated by JavaScript -->
            </div>
            
            <div style="margin-top: var(--spacing-md); padding: var(--spacing-md); background: var(--color-bg-tertiary); border-radius: var(--border-radius); font-size: 0.875rem;">
                <strong>‚ö†Ô∏è Note:</strong> Please wait for deletion to complete. Do not close this window or navigate away.
            </div>
        </div>
    </div>
</div>

{% endblock %}

