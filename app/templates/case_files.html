{% extends "base.html" %}

{% block title %}Case Files - {{ case.name }} - CaseScope 2026{% endblock %}

{% block content %}
<div class="content-header">
    <div>
        <h1 class="content-title">Case Files: {{ case.name }}</h1>
        <p class="text-secondary">Manage and process files for this case</p>
    </div>
    <div class="content-actions">
        <a href="{{ url_for('upload_files', case_id=case.id) }}" class="btn btn-primary">
            <span>üì§</span>
            <span>Upload Files</span>
        </a>
        <a href="{{ url_for('view_case', case_id=case.id) }}" class="btn btn-secondary">
            <span>‚Üê</span>
            <span>Back to Case</span>
        </a>
    </div>
</div>

<!-- ============================================================================
     TILES ROW: File Stats and Event Stats (Side by Side - Equal 50/50)
     ============================================================================ -->
<div class="dashboard-row-2">
    
    <!-- TILE 1: FILE STATISTICS -->
    <div class="card card-no-margin">
        <div class="card-header">
            <h2 class="card-title">üìÅ File Statistics</h2>
        </div>
        <div class="card-body">
            <div class="stat-grid-case">
                <div class="stat-item">
                    <div class="stat-item-label">Total Files</div>
                    <div class="stat-item-value-large">{{ total_files }}</div>
                </div>
                <div class="stat-item">
                    <div class="stat-item-label">Total Space Used</div>
                    <div class="stat-item-value-large">{{ "%.2f"|format(total_space_gb) }} GB</div>
                </div>
                <div class="stat-item">
                    <div class="stat-item-label">Hidden Files (0 events)</div>
                    <a href="{{ url_for('files.view_hidden_files', case_id=case.id) }}" style="text-decoration: none;">
                        <div class="stat-item-value-large" style="color: {% if hidden_files > 0 %}var(--color-warning){% else %}var(--color-text-secondary){% endif %}; cursor: pointer;">
                            {{ hidden_files }}
                        </div>
                    </a>
                </div>
            </div>
            
            <!-- Processing States -->
            <div style="margin-top: var(--spacing-lg); padding-top: var(--spacing-lg); border-top: 1px solid var(--color-border);">
                <div class="stat-item-label" style="margin-bottom: var(--spacing-sm);">Processing Status</div>
                <div id="processing-status-container" style="display: flex; gap: var(--spacing-lg); flex-wrap: wrap;">
                    <div class="stat-item">
                        <div class="text-secondary" style="font-size: 0.875rem;">‚úÖ Completed</div>
                        <div><strong id="stat-completed">{{ files_completed }}</strong></div>
                    </div>
                    <div class="stat-item">
                        <div class="text-secondary" style="font-size: 0.875rem; color: var(--color-error);">‚ùå Failed</div>
                        <div style="color: var(--color-error);"><strong id="stat-failed">{{ files_failed }}</strong></div>
                    </div>
                    <div class="stat-item">
                        <div class="text-secondary" style="font-size: 0.875rem;">‚è≥ Queued</div>
                        <div><strong id="stat-queued">{{ files_queued }}</strong></div>
                    </div>
                    <div class="stat-item">
                        <div class="text-secondary" style="font-size: 0.875rem;">üìá Indexing</div>
                        <div><strong id="stat-indexing">{{ files_indexing }}</strong></div>
                    </div>
                    <div class="stat-item">
                        <div class="text-secondary" style="font-size: 0.875rem;">üõ°Ô∏è SIGMA</div>
                        <div><strong id="stat-sigma">{{ files_sigma }}</strong></div>
                    </div>
                    <div class="stat-item">
                        <div class="text-secondary" style="font-size: 0.875rem;">üéØ IOC</div>
                        <div><strong id="stat-ioc-hunting">{{ files_ioc_hunting }}</strong></div>
                    </div>
                </div>
            </div>
            
            {% if file_types %}
            <div style="margin-top: var(--spacing-lg); padding-top: var(--spacing-lg); border-top: 1px solid var(--color-border);">
                <div class="stat-item-label" style="margin-bottom: var(--spacing-sm);">Files by Type</div>
                <div class="stat-grid-2col">
                    {% for ftype, count in file_types.items() %}
                    <div class="stat-item" style="margin-bottom: var(--spacing-xs);">
                        <div class="text-secondary" style="font-size: 0.875rem;">{{ ftype }}</div>
                        <div><strong>{{ count }}</strong></div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>
    </div>
    
    <!-- TILE 2: EVENT STATISTICS -->
    <div class="card card-no-margin">
        <div class="card-header">
            <h2 class="card-title">üìä Event Statistics</h2>
        </div>
        <div class="card-body">
            <div class="stat-grid-case">
                <div class="stat-item">
                    <div class="stat-item-label">Total Events</div>
                    <div id="stat-total-events" class="stat-item-value-large" style="color: var(--color-primary);">
                        {{ '{:,}'.format(total_events) }}
                    </div>
                </div>
                <div class="stat-item">
                    <div class="stat-item-label">SIGMA Violations</div>
                    <div id="stat-sigma-events" class="stat-item-value-large" style="color: var(--color-success);">
                        {{ '{:,}'.format(total_sigma_events) }}
                    </div>
                </div>
                <div class="stat-item">
                    <div class="stat-item-label">IOC Events</div>
                    <div id="stat-ioc-events" class="stat-item-value-large" style="color: var(--color-error);">
                        {{ '{:,}'.format(total_ioc_events) }}
                    </div>
                </div>
            </div>
            
            <!-- Processing Queue - Scrollable Window -->
            <div style="margin-top: var(--spacing-lg); padding-top: var(--spacing-lg); border-top: 1px solid var(--color-border);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-sm);">
                    <div class="stat-item-label">Processing Queue</div>
                    <button onclick="refreshQueueStatus()" class="btn-icon" style="padding: 4px 8px; font-size: 0.75rem;" title="Refresh queue">
                        <span id="refreshQueueIcon">üîÑ</span>
                    </button>
                </div>
                
                <!-- Scrollable Queue List -->
                <div id="queueListContainer" style="padding: var(--spacing-sm); background: var(--color-bg-tertiary); border-radius: 4px; max-height: 200px; overflow-y: auto; font-size: 0.8rem;">
                    <div id="queueList" style="color: var(--color-text-secondary);">
                        Loading queue...
                    </div>
                </div>
            </div>
        </div>
    </div>
    
</div>

<!-- ============================================================================
     BUTTON BAR: Bulk Operations
     ============================================================================ -->
<div class="card" style="margin-top: var(--spacing-lg);">
    <div class="card-body" style="text-align: center; padding: var(--spacing-lg);">
        <!-- All Files Actions -->
        <div style="display: inline-flex; gap: var(--spacing-md); flex-wrap: wrap; justify-content: center; margin-bottom: var(--spacing-md);">
            <button onclick="queueCleanup()" class="btn" style="background: var(--color-success); color: white;" id="queueCleanupBtn" title="Fix failed files and requeue stuck files">
                <span>üßπ</span>
                <span>Queue Cleanup</span>
            </button>
            
            <button onclick="requeueFailedFiles()" class="btn" style="background: var(--color-warning); color: white;" id="requeueFailedBtn" title="Requeue all failed files (excluding hidden)">
                <span>üîÑ</span>
                <span>Requeue Failed</span>
            </button>
            
            <button onclick="confirmReindex()" class="btn" style="background: var(--color-info); color: white;">
                <span>üîÑ</span>
                <span>Re-Index All Files</span>
            </button>
            <button onclick="confirmReSigma()" class="btn" style="background: var(--color-success); color: white;">
                <span>üõ°Ô∏è</span>
                <span>Re-SIGMA All Files</span>
            </button>
            <button onclick="confirmReHunt()" class="btn" style="background: var(--color-warning); color: white;">
                <span>üéØ</span>
                <span>Re-Hunt IOCs All Files</span>
            </button>
            {% if current_user.role == 'administrator' %}
            <button onclick="confirmDeleteAll()" class="btn" style="background: var(--color-error); color: white;">
                <span>üóëÔ∏è</span>
                <span>Delete All Files</span>
            </button>
            {% endif %}
        </div>
        
        <!-- Selected Files Actions -->
        <div id="selectedActionsBar" style="display: none; padding-top: var(--spacing-md); border-top: 1px solid var(--color-border);">
            <div style="margin-bottom: var(--spacing-sm); color: var(--color-text-secondary); font-size: 0.875rem;">
                <span id="selectedCount">0</span> file(s) selected
            </div>
            <div style="display: inline-flex; gap: var(--spacing-sm); flex-wrap: wrap; justify-content: center;">
                <button onclick="bulkReindexSelected()" class="btn btn-sm" style="background: var(--color-info); color: white;">
                    <span>üîÑ</span>
                    <span>Re-Index Selected</span>
                </button>
                <button onclick="bulkReSigmaSelected()" class="btn btn-sm" style="background: var(--color-success); color: white;">
                    <span>üõ°Ô∏è</span>
                    <span>Re-SIGMA Selected</span>
                </button>
                <button onclick="bulkReHuntSelected()" class="btn btn-sm" style="background: var(--color-warning); color: white;">
                    <span>üéØ</span>
                    <span>Re-Hunt Selected</span>
                </button>
                <button onclick="bulkHideSelected()" class="btn btn-sm" style="background: var(--color-text-secondary); color: white;">
                    <span>üëÅÔ∏è</span>
                    <span>Hide Selected</span>
                </button>
                <button onclick="deselectAll()" class="btn btn-sm btn-secondary">
                    <span>‚úï</span>
                    <span>Deselect All</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- ============================================================================
     FILES TABLE
     ============================================================================ -->
<div class="card" style="margin-top: var(--spacing-lg);">
    <div class="card-header" style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: var(--spacing-md);">
        <div>
            <h2 class="card-title">üìÑ Case Files</h2>
            <span class="text-muted">
                {% if search_term %}
                {{ pagination.total }} matching file(s) ‚Ä¢ Page {{ pagination.page }} of {{ pagination.pages }}
                {% else %}
                {{ pagination.total }} total file(s) ‚Ä¢ Page {{ pagination.page }} of {{ pagination.pages }}
                {% endif %}
            </span>
        </div>
        <div>
            <form method="GET" action="{{ url_for('files.case_files', case_id=case.id) }}" style="display: inline-flex; gap: var(--spacing-xs);">
                <input type="text" 
                       id="fileSearch" 
                       name="search"
                       value="{{ search_term }}"
                       placeholder="üîç Search files by name or hash..." 
                       class="form-input" 
                       style="width: 300px;">
                <button type="submit" class="btn btn-primary" style="padding: 0.5rem 1rem;">
                    <span>üîé</span>
                </button>
                {% if search_term %}
                <a href="{{ url_for('files.case_files', case_id=case.id) }}" class="btn btn-secondary" style="padding: 0.5rem 1rem;" title="Clear search">
                    <span>‚úï</span>
                </a>
                {% endif %}
            </form>
        </div>
    </div>
    <div class="card-body" style="padding: 0;">
        {% if files %}
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th style="width: 40px;">
                            <input type="checkbox" id="selectAll" onchange="toggleSelectAll()" title="Select all files on this page">
                        </th>
                        <th>File Name</th>
                        <th>Type</th>
                        <th>Size (MB)</th>
                        <th>Status</th>
                        <th>Events</th>
                        <th>SIGMA</th>
                        <th>IOCs</th>
                        <th>Uploaded</th>
                        <th>Uploaded By</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for file in files %}
                    <tr data-file-id="{{ file.id }}">
                        <td>
                            <input type="checkbox" class="file-checkbox" value="{{ file.id }}" onchange="updateSelectedCount()">
                        </td>
                        <td>
                            <a href="javascript:void(0)" onclick="showFileDetails({{ file.id }})" style="color: var(--color-primary); text-decoration: none; cursor: pointer;">
                                <strong>{{ file.original_filename }}</strong>
                            </a>
                            {% if file.file_hash %}
                            <br><span class="text-muted file-hash-mini">{{ file.file_hash[:16] }}...</span>
                            {% endif %}
                        </td>
                        <td>
                            <span class="status-badge" style="background: rgba(59, 130, 246, 0.1); color: var(--color-info);">
                                {{ file.file_type or 'UNKNOWN' }}
                            </span>
                        </td>
                        <td>{{ (file.file_size / 1024 / 1024)|round(2) }}</td>
                        <td class="status-cell">
                            {% if file.indexing_status == 'Completed' %}
                                <span class="status-badge status-completed">Completed</span>
                            {% elif file.indexing_status == 'Indexing' %}
                                <span class="status-badge status-indexing pulsing">Indexing</span>
                            {% elif file.indexing_status == 'SIGMA Testing' %}
                                <span class="status-badge status-sigma pulsing">SIGMA Testing</span>
                            {% elif file.indexing_status == 'IOC Hunting' %}
                                <span class="status-badge status-ioc pulsing">IOC Hunting</span>
                            {% elif file.indexing_status == 'Queued' %}
                                <span class="status-badge status-queued">Queued</span>
                            {% else %}
                                <span class="status-badge status-failed">{{ file.indexing_status }}</span>
                            {% endif %}
                        </td>
                        <td class="event-count">
                            {% if file.event_count > 0 %}
                            {{ '{:,}'.format(file.event_count) }}
                            {% else %}
                            0
                            {% endif %}
                        </td>
                        <td class="sigma-count">
                            {% if file.violation_count > 0 %}
                            <span class="status-badge status-sigma">{{ file.violation_count }}</span>
                            {% else %}
                            <span class="text-muted">0</span>
                            {% endif %}
                        </td>
                        <td class="ioc-count">
                            {% if file.ioc_event_count > 0 %}
                            <span class="status-badge status-ioc">{{ file.ioc_event_count }}</span>
                            {% else %}
                            <span class="text-muted">0</span>
                            {% endif %}
                        </td>
                        <td>
                            <span class="text-muted">{{ file.uploaded_at.strftime('%Y-%m-%d') }}</span>
                            <br><span class="text-muted" style="font-size: 0.75rem;">{{ file.uploaded_at.strftime('%H:%M') }}</span>
                        </td>
                        <td>
                            {% if file.uploaded_by %}
                            <span class="text-muted">User #{{ file.uploaded_by }}</span>
                            {% else %}
                            <span class="text-muted">‚Äî</span>
                            {% endif %}
                        </td>
                        <td>
                            <div style="display: flex; gap: 4px; flex-wrap: wrap;">
                                {% if file.is_indexed and file.indexing_status == 'Completed' %}
                                <!-- Re-Index button -->
                                <button onclick="reindexSingleFile({{ file.id }})" 
                                        class="btn btn-sm" 
                                        style="background: var(--color-info); color: white; padding: 4px 8px; font-size: 0.75rem;"
                                        title="Re-index this file (clears all data)">
                                    üìá
                                </button>
                                <!-- Re-SIGMA button -->
                                <button onclick="reSigmaSingleFile({{ file.id }})" 
                                        class="btn btn-sm" 
                                        style="background: var(--color-success); color: white; padding: 4px 8px; font-size: 0.75rem;"
                                        title="Re-run SIGMA on this file">
                                    üõ°Ô∏è
                                </button>
                                <!-- Re-Hunt IOCs button -->
                                <button onclick="rehuntSingleFile({{ file.id }})" 
                                        class="btn btn-sm" 
                                        style="background: var(--color-warning); color: white; padding: 4px 8px; font-size: 0.75rem;"
                                        title="Re-hunt IOCs for this file">
                                    üéØ
                                </button>
                                <!-- Hide button -->
                                <button onclick="hideSingleFile({{ file.id }})" 
                                        class="btn btn-sm" 
                                        style="background: var(--color-text-secondary); color: white; padding: 4px 8px; font-size: 0.75rem;"
                                        title="Hide this file">
                                    üëÅÔ∏è
                                </button>
                                {% else %}
                                <span class="text-muted" style="font-size: 0.75rem;">‚Äî</span>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <!-- Pagination Controls (Reusable Component) -->
        {% set endpoint = 'files.case_files' %}
        {% set case_id = case.id %}
        {# Note: pagination component uses 'q' parameter, but we need 'search' for file search #}
        {% if search_term %}
        <div class="pagination-container" style="display: flex; justify-content: space-between; align-items: center; padding: var(--spacing-lg); border-top: 1px solid var(--color-border);">
            <div class="pagination-info" style="color: var(--color-text-secondary); font-size: 0.875rem;">
                Showing {{ ((pagination.page - 1) * pagination.per_page) + 1 }} 
                to {% if pagination.page * pagination.per_page > pagination.total %}{{ pagination.total }}{% else %}{{ pagination.page * pagination.per_page }}{% endif %} 
                of {{ pagination.total }} items
            </div>
            <div class="pagination-controls" style="display: flex; gap: var(--spacing-xs);">
                {% if pagination.has_prev %}
                <a href="{{ url_for('files.case_files', case_id=case.id, page=1, search=search_term) }}" class="btn btn-sm" style="padding: 6px 12px; font-size: 0.875rem;">¬´¬´</a>
                <a href="{{ url_for('files.case_files', case_id=case.id, page=pagination.prev_num, search=search_term) }}" class="btn btn-sm" style="padding: 6px 12px; font-size: 0.875rem;">‚Äπ Previous</a>
                {% else %}
                <span class="btn btn-sm" style="padding: 6px 12px; font-size: 0.875rem; opacity: 0.5; cursor: not-allowed;">¬´¬´</span>
                <span class="btn btn-sm" style="padding: 6px 12px; font-size: 0.875rem; opacity: 0.5; cursor: not-allowed;">‚Äπ Previous</span>
                {% endif %}
                
                {% set start_page = [1, pagination.page - 2]|max %}
                {% set end_page = [pagination.pages, pagination.page + 2]|min %}
                {% if start_page > 1 %}<span style="padding: 6px 12px; color: var(--color-text-secondary);">...</span>{% endif %}
                
                {% for page_num in range(start_page, end_page + 1) %}
                    {% if page_num == pagination.page %}
                    <span class="btn btn-sm" style="padding: 6px 12px; font-size: 0.875rem; background: var(--color-primary); color: white; cursor: default;">{{ page_num }}</span>
                    {% else %}
                    <a href="{{ url_for('files.case_files', case_id=case.id, page=page_num, search=search_term) }}" class="btn btn-sm" style="padding: 6px 12px; font-size: 0.875rem;">{{ page_num }}</a>
                    {% endif %}
                {% endfor %}
                
                {% if end_page < pagination.pages %}<span style="padding: 6px 12px; color: var(--color-text-secondary);">...</span>{% endif %}
                
                {% if pagination.has_next %}
                <a href="{{ url_for('files.case_files', case_id=case.id, page=pagination.next_num, search=search_term) }}" class="btn btn-sm" style="padding: 6px 12px; font-size: 0.875rem;">Next ‚Ä∫</a>
                <a href="{{ url_for('files.case_files', case_id=case.id, page=pagination.pages, search=search_term) }}" class="btn btn-sm" style="padding: 6px 12px; font-size: 0.875rem;">¬ª¬ª</a>
                {% else %}
                <span class="btn btn-sm" style="padding: 6px 12px; font-size: 0.875rem; opacity: 0.5; cursor: not-allowed;">Next ‚Ä∫</span>
                <span class="btn btn-sm" style="padding: 6px 12px; font-size: 0.875rem; opacity: 0.5; cursor: not-allowed;">¬ª¬ª</span>
                {% endif %}
            </div>
        </div>
        {% else %}
        {% include 'components/pagination.html' %}
        {% endif %}
        
        {% else %}
        <div style="text-align: center; padding: var(--spacing-2xl); color: var(--color-text-muted);">
            <div style="font-size: 3rem; margin-bottom: var(--spacing-md);">üìÑ</div>
            <h3>No files uploaded yet</h3>
            <p style="margin-bottom: var(--spacing-lg);">Upload EVTX, JSON, or ZIP files to start processing</p>
            <a href="{{ url_for('upload_files', case_id=case.id) }}" class="btn btn-primary">
                <span>üì§</span>
                <span>Upload Files</span>
            </a>
        </div>
        {% endif %}
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
const CASE_ID = {{ case.id }};

// ============================================================================
// CHECKBOX SELECTION FUNCTIONS
// ============================================================================

function toggleSelectAll() {
    const selectAllCheckbox = document.getElementById('selectAll');
    const checkboxes = document.querySelectorAll('.file-checkbox');
    checkboxes.forEach(cb => {
        cb.checked = selectAllCheckbox.checked;
    });
    updateSelectedCount();
}

function updateSelectedCount() {
    const checkboxes = document.querySelectorAll('.file-checkbox:checked');
    const count = checkboxes.length;
    document.getElementById('selectedCount').textContent = count;
    document.getElementById('selectedActionsBar').style.display = count > 0 ? 'block' : 'none';
}

function deselectAll() {
    document.getElementById('selectAll').checked = false;
    document.querySelectorAll('.file-checkbox').forEach(cb => cb.checked = false);
    updateSelectedCount();
}

function getSelectedFileIds() {
    const checkboxes = document.querySelectorAll('.file-checkbox:checked');
    return Array.from(checkboxes).map(cb => parseInt(cb.value));
}

// ============================================================================
// BULK OPERATIONS ON SELECTED FILES
// ============================================================================

function bulkReindexSelected() {
    const fileIds = getSelectedFileIds();
    if (fileIds.length === 0) return;
    
    if (confirm(`üîÑ Re-Index ${fileIds.length} Selected File(s)\n\nThis will:\n‚Ä¢ Clear all OpenSearch data for these files\n‚Ä¢ Clear all database metadata (events, SIGMA, IOCs)\n‚Ä¢ Re-process files from scratch\n‚Ä¢ Rebuild all indices and detections\n\nThis is a FULL REBUILD.\n\nContinue?`)) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/case/${CASE_ID}/bulk_reindex_selected`;
        fileIds.forEach(id => {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'file_ids';
            input.value = id;
            form.appendChild(input);
        });
        document.body.appendChild(form);
        form.submit();
    }
}

function bulkReSigmaSelected() {
    const fileIds = getSelectedFileIds();
    if (fileIds.length === 0) return;
    
    if (confirm(`üõ°Ô∏è Re-SIGMA ${fileIds.length} Selected File(s)\n\nThis will:\n‚Ä¢ Clear existing SIGMA violations for these files\n‚Ä¢ Re-run SIGMA detection\n‚Ä¢ Update violation counts\n\nOld violations will be removed before re-processing.\n\nContinue?`)) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/case/${CASE_ID}/bulk_rechainsaw_selected`;
        fileIds.forEach(id => {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'file_ids';
            input.value = id;
            form.appendChild(input);
        });
        document.body.appendChild(form);
        form.submit();
    }
}

function bulkReHuntSelected() {
    const fileIds = getSelectedFileIds();
    if (fileIds.length === 0) return;
    
    if (confirm(`üéØ Re-Hunt IOCs on ${fileIds.length} Selected File(s)\n\nThis will:\n‚Ä¢ Clear existing IOC matches for these files\n‚Ä¢ Re-scan files for IOC matches\n‚Ä¢ Update IOC event counts\n\nOld matches will be removed before re-scanning.\n\nContinue?`)) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/case/${CASE_ID}/bulk_rehunt_selected`;
        fileIds.forEach(id => {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'file_ids';
            input.value = id;
            form.appendChild(input);
        });
        document.body.appendChild(form);
        form.submit();
    }
}

function bulkHideSelected() {
    const fileIds = getSelectedFileIds();
    if (fileIds.length === 0) return;
    
    if (confirm(`üëÅÔ∏è Hide ${fileIds.length} Selected File(s)\n\nThis will hide these files from the main file list.\nYou can view and unhide them later from the Hidden Files page.\n\nContinue?`)) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/case/${CASE_ID}/bulk_hide_selected`;
        fileIds.forEach(id => {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'file_ids';
            input.value = id;
            form.appendChild(input);
        });
        document.body.appendChild(form);
        form.submit();
    }
}

// ============================================================================
// EXISTING BULK OPERATIONS (ALL FILES)
// ============================================================================

// ============================================================================
// QUEUE STATUS AND MANAGEMENT
// ============================================================================

// Fetch and display queue status
function refreshQueueStatus() {
    const icon = document.getElementById('refreshQueueIcon');
    const queueList = document.getElementById('queueList');
    
    if (!icon || !queueList) {
        console.error('Queue UI elements not found');
        return;
    }
    
    icon.style.animation = 'spin 1s linear infinite';
    
    fetch(`/case/${CASE_ID}/queue/status`)
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.status === 'success') {
                if (data.processing.length === 0 && data.queued.length === 0) {
                    queueList.innerHTML = '<div style="text-align: center; padding: var(--spacing-sm); color: var(--color-text-secondary);">‚úÖ Queue is empty</div>';
                } else {
                    let html = '';
                    
                    // Show processing files
                    if (data.processing && data.processing.length > 0) {
                        html += '<div style="font-weight: bold; margin-bottom: 4px; color: var(--color-info);">‚öôÔ∏è Processing Now:</div>';
                        data.processing.forEach(file => {
                            html += `<div style="padding: 2px 4px; margin-bottom: 2px; background: var(--color-bg-secondary); border-radius: 2px;">üìá ${file.filename}</div>`;
                        });
                    }
                    
                    // Show queued files
                    if (data.queued && data.queued.length > 0) {
                        html += '<div style="font-weight: bold; margin-top: 8px; margin-bottom: 4px;">‚è≥ Queued:</div>';
                        data.queued.forEach((file, index) => {
                            if (index < 30) {
                                html += `<div style="padding: 2px 4px; margin-bottom: 2px;">${file.filename}</div>`;
                            }
                        });
                        if (data.queued.length > 30) {
                            html += `<div style="padding: 4px; margin-top: 4px; text-align: center; font-style: italic; color: var(--color-text-secondary);">... and ${data.queued.length - 30} more</div>`;
                        }
                    }
                    
                    if (html) {
                        queueList.innerHTML = html;
                    } else {
                        queueList.innerHTML = '<div style="text-align: center; padding: var(--spacing-sm); color: var(--color-text-secondary);">‚úÖ Queue is empty</div>';
                    }
                }
            } else {
                queueList.innerHTML = `<div style="color: var(--color-error);">‚ùå ${data.message || 'Unknown error'}</div>`;
            }
            
            icon.style.animation = '';
        })
        .catch(error => {
            console.error('Error fetching queue status:', error);
            queueList.innerHTML = `<div style="color: var(--color-error);">‚ùå Error: ${error.message}</div>`;
            icon.style.animation = '';
        });
}

// Requeue all failed files
function requeueFailedFiles() {
    const btn = document.getElementById('requeueFailedBtn');
    
    if (!confirm(`üîÑ Requeue All Failed Files\n\nThis will resubmit all failed files (excluding hidden files) to the processing queue.\n\nContinue?`)) {
        return;
    }
    
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<span>üîÑ</span><span>Requeueing...</span>';
    
    fetch(`/case/${CASE_ID}/queue/requeue-failed`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                alert(data.message);
                refreshQueueStatus();
                setTimeout(() => location.reload(), 1000);
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error requeueing files:', error);
            alert('Error requeueing files. Check console for details.');
        })
        .finally(() => {
            btn.disabled = false;
            btn.innerHTML = originalText;
        });
}

// Auto-refresh queue status every 10 seconds
let queueRefreshInterval;
function startQueueAutoRefresh() {
    refreshQueueStatus(); // Initial load
    queueRefreshInterval = setInterval(refreshQueueStatus, 10000); // Refresh every 10 seconds
}

// Stop auto-refresh (e.g., when navigating away)
function stopQueueAutoRefresh() {
    if (queueRefreshInterval) {
        clearInterval(queueRefreshInterval);
    }
}

// Add CSS animation for refresh icon (wrapped to avoid conflicts)
(function() {
    if (!document.getElementById('queue-spin-animation')) {
        const spinStyle = document.createElement('style');
        spinStyle.id = 'queue-spin-animation';
        spinStyle.textContent = `
            @keyframes spin {
                from { transform: rotate(0deg); }
                to { transform: rotate(360deg); }
            }
        `;
        document.head.appendChild(spinStyle);
    }
})();

// Refresh file statistics
function refreshFileStats() {
    fetch(`/case/${CASE_ID}/file-stats`)
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                // Update individual stat elements
                document.getElementById('stat-completed').textContent = data.completed || 0;
                document.getElementById('stat-failed').textContent = data.failed || 0;
                document.getElementById('stat-queued').textContent = data.queued || 0;
                document.getElementById('stat-indexing').textContent = data.indexing || 0;
                document.getElementById('stat-sigma').textContent = data.sigma || 0;
                document.getElementById('stat-ioc-hunting').textContent = data.ioc_hunting || 0;
            }
        })
        .catch(error => {
            console.error('Error fetching file stats:', error);
        });
}

// Start auto-refresh when page loads
document.addEventListener('DOMContentLoaded', function() {
    startQueueAutoRefresh();
    refreshFileStats(); // Initial load
    setInterval(refreshFileStats, 10000); // Refresh file stats every 10 seconds
});

// Queue Cleanup
function queueCleanup() {
    const btn = document.getElementById('queueCleanupBtn');
    const originalText = btn.innerHTML;
    
    btn.disabled = true;
    btn.innerHTML = '<span>üîÑ</span><span>Cleaning...</span>';
    
    fetch(`/case/${CASE_ID}/queue/cleanup`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            btn.style.background = 'var(--color-success)';
            btn.innerHTML = '<span>‚úÖ</span><span>Done!</span>';
            
            // Show detailed results
            const message = `Queue Cleanup Complete:\n\n` +
                (data.failed_fixed > 0 ? `‚úÖ Fixed ${data.failed_fixed} misclassified failed files (now hidden)\n` : '') +
                (data.queued_requeued > 0 ? `‚úÖ Requeued ${data.queued_requeued} stuck files\n` : '') +
                (data.failed_fixed === 0 && data.queued_requeued === 0 ? `‚úÖ No issues found - queue is healthy` : '') +
                `\nRedis Queue: ${data.redis_queue_size} tasks`;
            
            alert(message);
            
            // Reload page to show updated stats
            setTimeout(() => window.location.reload(), 1500);
        } else {
            btn.style.background = 'var(--color-error)';
            btn.innerHTML = '<span>‚ùå</span><span>Error</span>';
            alert('Error: ' + data.message);
            setTimeout(() => {
                btn.disabled = false;
                btn.innerHTML = originalText;
                btn.style.background = 'var(--color-success)';
            }, 2000);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        btn.style.background = 'var(--color-error)';
        btn.innerHTML = '<span>‚ùå</span><span>Error</span>';
        alert('Network error: ' + error.message);
        setTimeout(() => {
            btn.disabled = false;
            btn.innerHTML = originalText;
            btn.style.background = 'var(--color-success)';
        }, 2000);
    });
}

function confirmReindex() {
    if (confirm('üîÑ Re-Index All Files\n\nThis will:\n‚Ä¢ Clear all OpenSearch indices for this case\n‚Ä¢ Clear all database metadata (events, SIGMA, IOCs)\n‚Ä¢ Clear all timeline tags (event references will change)\n‚Ä¢ Skip hidden files (0-event/CyLR artifacts)\n‚Ä¢ Re-process all visible files from scratch\n‚Ä¢ Rebuild all indices and detections\n\nThis is a FULL REBUILD and may take significant time.\n\nContinue?')) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/case/${CASE_ID}/bulk_reindex`;
        document.body.appendChild(form);
        form.submit();
    }
}

function confirmReSigma() {
    if (confirm('üõ°Ô∏è Re-SIGMA All Files\n\nThis will:\n‚Ä¢ Clear all existing SIGMA violations for this case\n‚Ä¢ Re-run SIGMA detection on all indexed files\n‚Ä¢ Update violation counts\n\nOld violations will be removed before re-processing.\n\nContinue?')) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/case/${CASE_ID}/bulk_rechainsaw`;
        document.body.appendChild(form);
        form.submit();
    }
}

function confirmReHunt() {
    if (confirm('üéØ Re-Hunt IOCs on All Files\n\nThis will:\n‚Ä¢ Clear all existing IOC matches for this case\n‚Ä¢ Re-scan all indexed files for IOC matches\n‚Ä¢ Update IOC event counts\n\nOld matches will be removed before re-scanning.\n\nContinue?')) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/case/${CASE_ID}/bulk_rehunt_iocs`;
        document.body.appendChild(form);
        form.submit();
    }
}

function confirmDeleteAll() {
    if (confirm('‚ö†Ô∏è WARNING: Delete ALL Files\n\nThis will PERMANENTLY:\n‚Ä¢ Delete all files from the filesystem\n‚Ä¢ Remove all database records (files, SIGMA violations, IOC matches)\n‚Ä¢ Remove all data from OpenSearch\n‚Ä¢ Delete staging, archive, and upload directories\n\nThis action CANNOT be undone!\n\nAre you ABSOLUTELY SURE?')) {
        if (confirm('FINAL WARNING: This will delete ALL files for this case.\n\nType "DELETE" in the next prompt to confirm.')) {
            const confirmation = prompt('Type DELETE to confirm deletion:');
            if (confirmation === 'DELETE') {
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = `/case/${CASE_ID}/bulk_delete_files`;
                document.body.appendChild(form);
                form.submit();
            } else {
                alert('Deletion cancelled - confirmation text did not match.');
            }
        }
    }
}

function reindexSingleFile(fileId) {
    if (confirm('üìá Re-Index This File\n\nThis will:\n‚Ä¢ Clear all OpenSearch data for this file\n‚Ä¢ Clear all database metadata (events, SIGMA, IOCs)\n‚Ä¢ Re-index the file from scratch\n‚Ä¢ Re-run SIGMA and IOC detection\n\nThis is a FULL REBUILD of this file.\n\nContinue?')) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/case/${CASE_ID}/file/${fileId}/reindex`;
        document.body.appendChild(form);
        form.submit();
    }
}

function reSigmaSingleFile(fileId) {
    if (confirm('üõ°Ô∏è Re-SIGMA This File\n\nThis will:\n‚Ä¢ Clear existing SIGMA violations for this file only\n‚Ä¢ Re-run SIGMA detection\n‚Ä¢ Update violation count\n\nContinue?')) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/case/${CASE_ID}/file/${fileId}/rechainsaw`;
        document.body.appendChild(form);
        form.submit();
    }
}

function rehuntSingleFile(fileId) {
    if (confirm('üéØ Re-Hunt IOCs for This File\n\nThis will:\n‚Ä¢ Clear existing IOC matches for this file only\n‚Ä¢ Re-scan this file for IOC matches\n‚Ä¢ Update IOC event count\n\nContinue?')) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/case/${CASE_ID}/file/${fileId}/rehunt_iocs`;
        document.body.appendChild(form);
        form.submit();
    }
}

function hideSingleFile(fileId) {
    if (confirm('üëÅÔ∏è Hide This File\n\nThis will hide the file from the main file list.\nYou can view and unhide it later from the Hidden Files page.\n\nContinue?')) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/case/${CASE_ID}/file/${fileId}/toggle_hidden`;
        document.body.appendChild(form);
        form.submit();
    }
}

function showFileDetails(fileId) {
    // Redirect to file details page
    window.location.href = `/case/${CASE_ID}/file/${fileId}/details`;
}

// Live status updates - refresh every 3 seconds (reused from view_case)
function updateStatuses() {
    fetch(`/case/${CASE_ID}/status`)
        .then(response => response.json())
        .then(data => {
            let processingCount = 0;
            
            // Update statistics tiles if present
            if (data.stats) {
                const totalEventsEl = document.getElementById('stat-total-events');
                const sigmaEventsEl = document.getElementById('stat-sigma-events');
                const iocEventsEl = document.getElementById('stat-ioc-events');
                
                if (totalEventsEl) {
                    totalEventsEl.textContent = data.stats.total_events.toLocaleString();
                }
                if (sigmaEventsEl) {
                    sigmaEventsEl.textContent = data.stats.sigma_events.toLocaleString();
                }
                if (iocEventsEl) {
                    iocEventsEl.textContent = data.stats.ioc_events.toLocaleString();
                }
            }
            
            data.files.forEach(file => {
                const row = document.querySelector(`tr[data-file-id="${file.id}"]`);
                if (!row) return;
                
                // Update status
                const statusCell = row.querySelector('.status-cell');
                if (!statusCell) return;
                
                const currentStatus = statusCell.textContent.trim();
                
                if (currentStatus !== file.status) {
                    let statusClass = 'status-failed';
                    let pulsing = '';
                    
                    if (file.status === 'Completed') {
                        statusClass = 'status-completed';
                    } else if (file.status === 'Indexing') {
                        statusClass = 'status-indexing';
                        pulsing = ' pulsing';
                        processingCount++;
                    } else if (file.status === 'SIGMA Testing') {
                        statusClass = 'status-sigma';
                        pulsing = ' pulsing';
                        processingCount++;
                    } else if (file.status === 'IOC Hunting') {
                        statusClass = 'status-ioc';
                        pulsing = ' pulsing';
                        processingCount++;
                    } else if (file.status === 'Queued') {
                        statusClass = 'status-queued';
                        processingCount++;
                    }
                    
                    statusCell.innerHTML = `<span class="status-badge ${statusClass}${pulsing}">${file.status}</span>`;
                }
                
                // Update event count
                const eventCell = row.querySelector('.event-count');
                if (eventCell) {
                    eventCell.textContent = file.event_count.toLocaleString();
                }
                
                // Update SIGMA count
                const sigmaCell = row.querySelector('.sigma-count');
                if (sigmaCell) {
                    if (file.violation_count > 0) {
                        sigmaCell.innerHTML = `<span class="status-badge status-sigma">${file.violation_count}</span>`;
                    } else {
                        sigmaCell.innerHTML = '<span class="text-muted">0</span>';
                    }
                }
                
                // Update IOC count
                const iocCell = row.querySelector('.ioc-count');
                if (iocCell) {
                    if (file.ioc_event_count > 0) {
                        iocCell.innerHTML = `<span class="status-badge status-ioc">${file.ioc_event_count}</span>`;
                    } else {
                        iocCell.innerHTML = '<span class="text-muted">0</span>';
                    }
                }
            });
            
            // If there are files being processed, continue polling
            // Otherwise, slow down to every 10 seconds
            if (processingCount > 0) {
                setTimeout(updateStatuses, 3000);
            } else {
                setTimeout(updateStatuses, 10000);
            }
        })
        .catch(error => {
            console.error('Error updating statuses:', error);
            // Retry after 10 seconds on error
            setTimeout(updateStatuses, 10000);
        });
}

// Start status updates after 1 second
setTimeout(updateStatuses, 1000);
</script>
{% endblock %}

